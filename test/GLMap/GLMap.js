!function(a){function b(a,b,c){return Math.min(c,Math.max(a,b))}function c(a,b,c){a.addEventListener(b,c,!1)}function d(a){a.preventDefault&&a.preventDefault(),a.stopPropagation&&a.stopPropagation(),a.returnValue=!1}function e(a,b){var c=a[0]-b[0],d=a[1]-b[1];return c*c+d*d}var f=a.document,g=function(a,b){this.container="string"==typeof a?f.getElementById(a):a,b=b||{},this.container.classList.add("glmap-container"),this.width=this.container.offsetWidth,this.height=this.container.offsetHeight,this.minZoom=parseFloat(b.minZoom)||10,this.maxZoom=parseFloat(b.maxZoom)||20,this.maxZoom<this.minZoom&&(this.maxZoom=this.minZoom),this.center={x:0,y:0},this.zoom=0,this.listeners={},this.restoreState(b),b.state&&(this.persistState(),this.on("change",function(){this.persistState()}.bind(this))),this.interaction=new h(this,this.container),this.layers=new i(this),b.disabled&&this.setDisabled(!0),this.attribution=b.attribution,this.attributionDiv=f.createElement("DIV"),this.attributionDiv.className="glmap-attribution",this.container.appendChild(this.attributionDiv),this.updateAttribution()};g.TILE_SIZE=256,g.prototype={updateAttribution:function(){var a=this.layers.getAttribution();this.attribution&&a.unshift(this.attribution),this.attributionDiv.innerHTML=a.join(" &middot; ")},restoreState:function(a){var b=location.search,c={};b&&b.substring(1).replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(a,b,d){b&&(c[b]=d)});var d;void 0!==c.lat&&void 0!==c.lon&&(d={latitude:parseFloat(c.lat),longitude:parseFloat(c.lon)}),this.setPosition(d||a.position||{latitude:52.52,longitude:13.41});var e;void 0!==c.zoom&&(e=void 0!==c.zoom?parseFloat(c.zoom):null),this.setZoom(e||a.zoom||this.minZoom);var f;void 0!==c.rotation&&(f=parseFloat(c.rotation)),this.setRotation(f||a.rotation||0);var g;void 0!==c.tilt&&(g=parseFloat(c.tilt)),this.setTilt(g||a.tilt||0);var h;void 0!==c.bend&&(h=parseFloat(c.bend)),this.setBend(h||a.bend||0)},persistState:function(){history.replaceState&&(this.stateDebounce||(this.stateDebounce=setTimeout(function(){this.stateDebounce=null;var a=[];a.push("lat="+this.position.latitude.toFixed(5)),a.push("lon="+this.position.longitude.toFixed(5)),a.push("zoom="+this.zoom.toFixed(1)),a.push("tilt="+this.tilt.toFixed(1)),a.push("bend="+this.bend.toFixed(1)),a.push("rotation="+this.rotation.toFixed(1)),history.replaceState({},"","?"+a.join("&"))}.bind(this),1e3)))},setCenter:function(a){(this.center.x!==a.x||this.center.y!==a.y)&&(this.center=a,this.position=this.unproject(a.x,a.y,g.TILE_SIZE*Math.pow(2,this.zoom)),this.emit("change"))},emit:function(a,b){if(this.listeners[a]){var c=this.listeners[a];c.timer||(c.timer=setTimeout(function(){for(var a=0,d=c.fn.length;d>a;a++)c.fn[a](b);c.timer=null}.bind(this),17))}},on:function(a,b){return this.listeners[a]||(this.listeners[a]={fn:[]}),this.listeners[a].fn.push(b),this},off:function(a,b){},setDisabled:function(a){return this.interaction.disabled=!!a,this},isDisabled:function(){return!!this.interaction.disabled},project:function(a,b,c){var d=b/360+.5,e=Math.min(1,Math.max(0,.5-Math.log(Math.tan(Math.PI/4+Math.PI/2*a/180))/Math.PI/2));return{x:d*c,y:e*c}},unproject:function(a,b,c){return a/=c,b/=c,{latitude:(2*Math.atan(Math.exp(Math.PI*(1-2*b)))-Math.PI/2)*(180/Math.PI),longitude:360*a-180}},getBounds:function(){var a=this.width/2,b=this.height/2,c=this.rotation*Math.PI/180,d=Math.cos(c)*a-Math.sin(c)*b,e=Math.sin(c)*a+Math.cos(c)*b,f=this.center,h=g.TILE_SIZE*Math.pow(2,this.zoom),i=this.unproject(f.x-d,f.y-e,h),j=this.unproject(f.x+d,f.y+e,h);return{n:i.latitude,w:i.longitude,s:j.latitude,e:j.longitude}},setZoom:function(a,c){if(a=b(parseFloat(a),this.minZoom,this.maxZoom),this.zoom!==a){var d=Math.pow(2,a-this.zoom);if(this.zoom=a,c){var e=this.container.offsetWidth/2-c.clientX,f=this.container.offsetHeight/2-c.clientY;this.center.x-=e,this.center.y-=f,this.center.x*=d,this.center.y*=d,this.center.x+=e,this.center.y+=f}else this.center.x*=d,this.center.y*=d;this.emit("change")}return this},getZoom:function(){return this.zoom},setPosition:function(a){var c=b(parseFloat(a.latitude),-90,90),d=b(parseFloat(a.longitude),-180,180),e=this.project(c,d,g.TILE_SIZE*Math.pow(2,this.zoom));return this.setCenter(e),this},getPosition:function(){return this.position},setSize:function(a){return(a.width!==this.width||a.height!==this.height)&&(this.width=a.width,this.height=a.height,this.emit("resize")),this},getSize:function(){return{width:this.width,height:this.height}},setRotation:function(a){return a=parseFloat(a)%360,this.rotation!==a&&(this.rotation=a,this.emit("change")),this},getRotation:function(){return this.rotation},setTilt:function(a){return a=b(parseFloat(a),0,60),this.tilt!==a&&(this.tilt=a,this.emit("change")),this},getTilt:function(){return this.tilt},setBend:function(a){return a=b(parseFloat(a),0,90),this.bend!==a&&(this.bend=a,this.emit("change")),this},getBend:function(){return this.bend},addLayer:function(a){return this.layers.add(a),this.updateAttribution(),this},removeLayer:function(a){this.layers.remove(a),this.updateAttribution()},destroy:function(){this.listeners=null,this.interaction.destroy(),this.layers.destroy()}},"function"==typeof a.define?a.define([],g):"object"==typeof a.exports?a.module.exports=g:a.GLMap=g;var h=function(b,d){this.map=b,"ontouchstart"in a?(c(d,"touchstart",this.onTouchStart.bind(this)),c(f,"touchmove",this.onTouchMove.bind(this)),c(f,"touchend",this.onTouchEnd.bind(this)),c(d,"gesturechange",this.onGestureChange.bind(this))):(c(d,"mousedown",this.onMouseDown.bind(this)),c(f,"mousemove",this.onMouseMove.bind(this)),c(f,"mouseup",this.onMouseUp.bind(this)),c(d,"dblclick",this.onDoubleClick.bind(this)),c(d,"mousewheel",this.onMouseWheel.bind(this)),c(d,"DOMMouseScroll",this.onMouseWheel.bind(this)));var e;c(a,"resize",function(){e||(e=setTimeout(function(){e=null,b.setSize({width:d.offsetWidth,height:d.offsetHeight})},250))})};h.prototype={prevX:0,prevY:0,startX:0,startY:0,startZoom:0,prevRotation:0,prevTilt:0,disabled:!1,pointerIsDown:!1,onDoubleClick:function(a){this.disabled||(d(a),this.map.setZoom(this.map.zoom+1,a))},onMouseDown:function(a){this.disabled||a.button>1||(d(a),this.startZoom=this.map.zoom,this.prevRotation=this.map.rotation,this.prevTilt=this.map.tilt,this.startX=this.prevX=a.clientX,this.startY=this.prevY=a.clientY,this.pointerIsDown=!0,this.map.emit("pointerdown",{x:a.clientX,y:a.clientY}))},onMouseMove:function(a){this.disabled||(this.pointerIsDown&&(0!==a.button||a.altKey?this.rotateMap(a):this.moveMap(a),this.prevX=a.clientX,this.prevY=a.clientY),this.map.emit("pointermove",{x:a.clientX,y:a.clientY}))},onMouseUp:function(a){this.disabled||this.pointerIsDown&&(0!==a.button||a.altKey?this.rotateMap(a):(Math.abs(a.clientX-this.startX)>5||Math.abs(a.clientY-this.startY)>5)&&this.moveMap(a),this.pointerIsDown=!1,this.map.emit("pointerup",{x:a.clientX,y:a.clientY}))},onMouseWheel:function(a){if(!this.disabled){d(a);var b=0;a.wheelDeltaY?b=a.wheelDeltaY:a.wheelDelta?b=a.wheelDelta:a.detail&&(b=-a.detail);var c=.2*(b>0?1:0>b?-1:0);this.map.setZoom(this.map.zoom+c,a)}},moveMap:function(a){var b=a.clientX-this.prevX,c=a.clientY-this.prevY,d=this.map.rotation*Math.PI/180,e={x:Math.cos(d)*b-Math.sin(d)*c,y:Math.sin(d)*b+Math.cos(d)*c};this.map.setCenter({x:this.map.center.x-e.x,y:this.map.center.y-e.y})},rotateMap:function(a){this.prevRotation+=(a.clientX-this.prevX)*(360/innerWidth),this.prevTilt-=(a.clientY-this.prevY)*(360/innerHeight),this.map.setRotation(this.prevRotation),this.map.setTilt(this.prevTilt)},onTouchStart:function(a){this.disabled||(d(a),this.startZoom=this.map.zoom,this.prevRotation=this.map.rotation,this.prevTilt=this.map.tilt,a.touches.length>1&&(a=a.touches[0]),this.startX=this.prevX=a.clientX,this.startY=this.prevY=a.clientY,this.map.emit("pointerdown",{x:a.clientX,y:a.clientY}))},onTouchMove:function(a){this.disabled||(a.touches.length>1&&(a=a.touches[0]),this.moveMap(a),this.prevX=a.clientX,this.prevY=a.clientY,this.map.emit("pointermove",{x:a.clientX,y:a.clientY}))},onTouchEnd:function(a){this.disabled||(a.touches.length>1&&(a=a.touches[0]),(Math.abs(a.clientX-this.startX)>5||Math.abs(a.clientY-this.startY)>5)&&this.moveMap(a),this.map.emit("pointerup",{x:a.clientX,y:a.clientY}))},onGestureChange:function(a){this.disabled||(d(a),this.map.setZoom(this.startZoom+(a.scale-1)),this.map.setRotation(this.prevRotation-a.rotation))},destroy:function(){this.disabled=!0}};var i=function(a){this.map=a,this.items=[]};i.prototype={add:function(a){this.items.push(a)},remove:function(a){for(var b=0;b<this.items.length;b++)if(this.items[b]===a)return void this.items.splice(b,1)},getAttribution:function(){for(var a=[],b=0;b<this.items.length;b++)this.items[b].attribution&&a.push(this.items[b].attribution);return a},render:function(){for(var a=0;a<this.items.length;a++)this.items[a].render()},destroy:function(){for(var a=0;a<this.items.length;a++)this.items[a].destroy();this.items=null}},g.TileLayer=function(a,b){this.source=a,b=b||{},this.attribution=b.attribution,this.minZoom=parseFloat(b.minZoom)||0,this.maxZoom=parseFloat(b.maxZoom)||18,this.maxZoom<this.minZoom&&(this.maxZoom=this.minZoom),this.buffer=b.buffer||1,this.items={}},g.TileLayer.prototype={addTo:function(a){this.map=a,a.addLayer(this),a.on("change",function(){this.update(2e3)}.bind(this)),a.on("resize",this.update.bind(this)),this.update()},remove:function(){clearTimeout(this.isWaiting),this.map.removeLayer(this),this.map=null},update:function(a){var b=this.map;if(!(b.zoom<this.minZoom||b.zoom>this.maxZoom))return a?void(this.isWaiting||(this.isWaiting=setTimeout(function(){this.isWaiting=null,this.loadTiles()}.bind(this),a))):void this.loadTiles()},getURL:function(a,b,c){var d={s:"abcd"[(a+b)%4],x:a,y:b,z:c};return this.source.replace(/\{(\w+)\}/g,function(a,b){return d[b]||a})},updateBounds:function(){var a=this.map,b=Math.round(a.zoom),c=1500,d=Math.pow(2,b-a.zoom)/g.TILE_SIZE,e=a.center;this.minX=(e.x-c)*d<<0,this.minY=(e.y-c)*d<<0,this.maxX=Math.ceil((e.x+c)*d),this.maxY=Math.ceil((e.y+c)*d)},loadTiles:function(){this.updateBounds();var a,b,c,d,f=this.map,h=Math.round(f.zoom),i=[],k=[f.center.x/g.TILE_SIZE<<0,f.center.y/g.TILE_SIZE<<0];for(b=this.minY;b<this.maxY;b++)for(a=this.minX;a<this.maxX;a++)c=[a,b,h].join(","),this.items[c]||(this.items[c]=new j(this,a,b,h),i.push({tile:this.items[c],dist:e([a,b],k)}));if(d=i.length){i.sort(function(a,b){return a.dist-b.dist});for(var l,m=0;d>m;m++)l=i[m].tile,l.load(this.getURL(l.x,l.y,l.zoom));this.purge()}},purge:function(){for(var a in this.items)this.isVisible(this.items[a],this.buffer)||(this.items[a].destroy(),delete this.items[a])},isVisible:function(a,b){b=b||0;var c=a.x,d=a.y,e=Math.round(this.map.zoom);return a.zoom===e&&c>=this.minX-b&&c<=this.maxX+b&&d>=this.minY-b&&d<=this.maxY+b},render:function(){var a,b=this.map,c=Math.round(b.zoom),d=1/Math.pow(2,c-b.zoom),e=b.center;for(var f in this.items)a=this.items[f],a.render(a.x*g.TILE_SIZE*d-e.x,a.y*g.TILE_SIZE*d-e.y)},destroy:function(){for(var a in this.items)this.items[a].destroy();this.items=null,this.remove()}};var j=function(a,b,c,d){this.layer=a,this.x=b,this.y=c,this.zoom=d};j.prototype={load:function(a){var b=new Image;b.onload=function(){this.image=b}.bind(this),b.style.position="absolute",b.src=a},render:function(a,b){this.image&&(this.image.parentNode||this.layer.map.container.appendChild(this.image),this.image.style.left=a+"px",this.image.style.top=b+"px")},destroy:function(){this.image&&(this.layer.map.container.removeChild(this.image),this.image.src="")}}}(this);