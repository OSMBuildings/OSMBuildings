!function(a){function b(a,b,c){a.addEventListener(b,c,!1)}function c(a){a.preventDefault&&a.preventDefault(),a.stopPropagation&&a.stopPropagation(),a.returnValue=!1}function d(a){J.length||w.emit("busy"),-1===J.indexOf(a)&&J.push(a)}function e(a){if(J.length){var b=J.indexOf(a);b>-1&&J.splice(b,1),J.length||w.emit("idle")}}function f(a,b,c){return Math.min(c,Math.max(a,b))}function g(a,b,c){var d=c-b;return f((a-b)/d,0,1)}function h(a,b,c,d){var e=b.min,f=b.max,h=g(a,e[c],f[c]);return e[d]+(f[d]-e[d])*h}function i(a,b,c){var d=b/360+.5,e=Math.min(1,Math.max(0,.5-Math.log(Math.tan(Math.PI/4+Math.PI/2*a/180))/Math.PI/2));return{x:d*c,y:e*c}}function j(a,b,c){return a/=c,b/=c,{latitude:(2*Math.atan(Math.exp(Math.PI*(1-2*b)))-Math.PI/2)*(180/Math.PI),longitude:360*a-180}}function k(a,b){return a.replace(/\{(\w+)\}/g,function(a,c){return b[c]||a})}function l(a){return a--,a|=a>>1,a|=a>>2,a|=a>>4,a|=a>>8,a|=a>>16,a++,a}function m(a,b){var c=a[0]-b[0],d=a[1]-b[1];return c*c+d*d}function n(a){var b=a[0],c=b.length;if(16>c)return!1;var d,e=1/0,f=-1/0,g=1/0,h=-1/0;for(d=0;c>d;d++)e=Math.min(e,b[d][0]),f=Math.max(f,b[d][0]),g=Math.min(g,b[d][1]),h=Math.max(h,b[d][1]);var i=f-e,j=h-g,k=i/j;if(.85>k||k>1.15)return!1;var l=[e+i/2,g+j/2],n=(i+j)/4,o=n*n;for(d=0;c>d;d++){var p=m(b[d],l);if(.8>p/o||p/o>1.2)return!1}return!0}function o(a){for(var b=a[0],c=1/0,d=-1/0,e=1/0,f=-1/0,g=0;g<b.length;g++)c=Math.min(c,b[g][0]),d=Math.max(d,b[g][0]),e=Math.min(e,b[g][1]),f=Math.max(f,b[g][1]);return{minX:c,maxX:d,minY:e,maxY:f}}function p(a,b,c,d,e,f,g,h,i){var j=a-d,k=b-e,l=c-f,m=d-g,n=e-h,o=f-i,p=k*o-l*n,r=l*m-j*o,s=j*n-k*m;return q(p,r,s)}function q(a,b,c){var d=Math.sqrt(a*a+b*b+c*c);return 0===d&&(d=1e-5),[a/d,b/d,c/d]}function r(a,b,c){return{x:Math.cos(c)*a-Math.sin(c)*b,y:Math.sin(c)*a+Math.cos(c)*b}}var s=function(){"use strict";function a(a,e){var f=c(b(a[0],!0)),g=e?{vertices:[],indices:[]}:[];if(!f)return g;var h,j,k,l,m,n,o,p,q,r=80;for(q=0;r>=0&&q<a.length;q++)r-=a[q].length;if(0>r){h=f.next,j=l=h.p[0],k=m=h.p[1];do n=h.p[0],o=h.p[1],j>n&&(j=n),k>o&&(k=o),n>l&&(l=n),o>m&&(m=o),h=h.next;while(h!==f);p=Math.max(l-j,m-k)}return a.length>1&&(f=i(a,f)),d(f,g,j,k,p),g}function b(a,b){var c,d,e,f,g,h=0,i=a.length;for(c=0,d=i-1;i>c;d=c++)e=a[c],f=a[d],h+=(f[0]-e[0])*(e[1]+f[1]);if(b===h>0)for(c=0;i>c;c++)g=y(a[c],g);else for(c=i-1;c>=0;c--)g=y(a[c],g);return g}function c(a,b){b||(b=a);var c,d=a;do if(c=!1,r(d.p,d.next.p)||0===q(d.prev.p,d.p,d.next.p)){if(d.prev.next=d.next,d.next.prev=d.prev,d.prevZ&&(d.prevZ.nextZ=d.nextZ),d.nextZ&&(d.nextZ.prevZ=d.prevZ),d=b=d.prev,d===d.next)return null;c=!0}else d=d.next;while(c||d!==b);return b}function d(a,b,i,j,k,m){if(a){var n=void 0!==b.vertices;m||void 0===i||l(a,i,j,k);for(var o,p,q=a;a.prev!==a.next;)if(o=a.prev,p=a.next,f(a,i,j,k))n?(e(b,o),e(b,a),e(b,p)):(b.push(o.p),b.push(a.p),b.push(p.p)),p.prev=o,o.next=p,a.prevZ&&(a.prevZ.nextZ=a.nextZ),a.nextZ&&(a.nextZ.prevZ=a.prevZ),a=p.next,q=p.next;else if(a=p,a===q){m?1===m?(a=g(a,b),d(a,b,i,j,k,2)):2===m&&h(a,b,i,j,k):d(c(a),b,i,j,k,1);break}}}function e(a,b){b.source&&(b=b.source);var c=b.index;if(null===c){var d=b.p.length,e=a.vertices;b.index=c=e.length/d;for(var f=0;d>f;f++)e.push(b.p[f])}a.indices.push(c)}function f(a,b,c,d){var e=a.prev.p,f=a.p,g=a.next.p,h=e[0],i=f[0],j=g[0],k=e[1],l=f[1],m=g[1],o=h*l-k*i,p=h*m-k*j,q=j*l-m*i,r=o-p-q;if(0>=r)return!1;var s,t,u,v,w,x,y,z=m-k,A=h-j,B=k-l,C=i-h;if(void 0!==b){var D=i>h?j>h?h:j:j>i?i:j,E=l>k?m>k?k:m:m>l?l:m,F=h>i?h>j?h:j:i>j?i:j,G=k>l?k>m?k:m:l>m?l:m,H=n(D,E,b,c,d),I=n(F,G,b,c,d);for(y=a.nextZ;y&&y.z<=I;)if(s=y.p,y=y.nextZ,s!==e&&s!==g&&(t=s[0],u=s[1],v=z*t+A*u-p,v>=0&&(w=B*t+C*u+o,w>=0&&(x=r-v-w,x>=0&&(v&&w||v&&x||w&&x)))))return!1;for(y=a.prevZ;y&&y.z>=H;)if(s=y.p,y=y.prevZ,s!==e&&s!==g&&(t=s[0],u=s[1],v=z*t+A*u-p,v>=0&&(w=B*t+C*u+o,w>=0&&(x=r-v-w,x>=0&&(v&&w||v&&x||w&&x)))))return!1}else for(y=a.next.next;y!==a.prev;)if(s=y.p,y=y.next,t=s[0],u=s[1],v=z*t+A*u-p,v>=0&&(w=B*t+C*u+o,w>=0&&(x=r-v-w,x>=0&&(v&&w||v&&x||w&&x))))return!1;return!0}function g(a,b){var c=!!b.vertices,d=a;do{var f=d.prev,g=d.next.next;if(s(f.p,d.p,d.next.p,g.p)&&u(f,g)&&u(g,f)){c?(e(b,f),e(b,d),e(b,g)):(b.push(f.p),b.push(d.p),b.push(g.p)),f.next=g,g.prev=f;var h=d.prevZ,i=d.nextZ&&d.nextZ.nextZ;h&&(h.nextZ=i),i&&(i.prevZ=h),d=a=g}d=d.next}while(d!==a);return d}function h(a,b,e,f,g){var h=a;do{for(var i=h.next.next;i!==h.prev;){if(p(h,i)){var j=x(h,i);return h=c(h,h.next),j=c(j,j.next),d(h,b,e,f,g),void d(j,b,e,f,g)}i=i.next}h=h.next}while(h!==a)}function i(a,d){for(var e=a.length,f=[],g=1;e>g;g++){var h=c(b(a[g],!1));h&&f.push(o(h))}for(f.sort(w),g=0;g<f.length;g++)j(f[g],d),d=c(d,d.next);return d}function j(a,b){if(b=k(a,b)){var d=x(b,a);c(d,d.next)}}function k(a,b){var c,d,e,f=b,g=a.p,h=g[0],i=g[1],j=-1/0;do{if(d=f.p,e=f.next.p,i<=d[1]&&i>=e[1]){var k=d[0]+(i-d[1])*(e[0]-d[0])/(e[1]-d[1]);h>=k&&k>j&&(j=k,c=d[0]<e[0]?f:f.next)}f=f.next}while(f!==b);if(!c)return null;var l,m,n,o,p,q,r=c.p[0],s=c.p[1],t=h*s-i*r,v=h*i-i*j,w=i-i,x=h-j,y=i-s,z=r-h,A=t-v-(j*s-i*r),B=0>=A?-1:1,C=c,D=1/0;for(f=c.next;f!==C;)l=f.p[0],m=f.p[1],n=h-l,n>=0&&l>=r&&(o=(w*l+x*m-v)*B,o>=0&&(p=(y*l+z*m+t)*B,p>=0&&A*B-o-p>=0&&(q=Math.abs(i-m)/n,D>q&&u(f,a)&&(c=f,D=q)))),f=f.next;return c}function l(a,b,c,d){var e=a;do null===e.z&&(e.z=n(e.p[0],e.p[1],b,c,d)),e.prevZ=e.prev,e.nextZ=e.next,e=e.next;while(e!==a);e.prevZ.nextZ=null,e.prevZ=null,m(e)}function m(a){for(var b,c,d,e,f,g,h,i,j=1;;){for(c=a,a=null,f=null,g=0;c;){for(g++,d=c,h=0,b=0;j>b&&(h++,d=d.nextZ,d);b++);for(i=j;h>0||i>0&&d;)0===h?(e=d,d=d.nextZ,i--):0!==i&&d?c.z<=d.z?(e=c,c=c.nextZ,h--):(e=d,d=d.nextZ,i--):(e=c,c=c.nextZ,h--),f?f.nextZ=e:a=e,e.prevZ=f,f=e;c=d}if(f.nextZ=null,1>=g)return a;j*=2}}function n(a,b,c,d,e){return a=1e3*(a-c)/e,a=16711935&(a|a<<8),a=252645135&(a|a<<4),a=858993459&(a|a<<2),a=1431655765&(a|a<<1),b=1e3*(b-d)/e,b=16711935&(b|b<<8),b=252645135&(b|b<<4),b=858993459&(b|b<<2),b=1431655765&(b|b<<1),a|b<<1}function o(a){var b=a,c=a;do b.p[0]<c.p[0]&&(c=b),b=b.next;while(b!==a);return c}function p(a,b){return!t(a,a.p,b.p)&&u(a,b)&&u(b,a)&&v(a,a.p,b.p)}function q(a,b,c){var d=(b[1]-a[1])*(c[0]-b[0])-(b[0]-a[0])*(c[1]-b[1]);return d>0?1:0>d?-1:0}function r(a,b){return a[0]===b[0]&&a[1]===b[1]}function s(a,b,c,d){return q(a,b,c)!==q(a,b,d)&&q(c,d,a)!==q(c,d,b)}function t(a,b,c){var d=a;do{var e=d.p,f=d.next.p;if(e!==b&&f!==b&&e!==c&&f!==c&&s(e,f,b,c))return!0;d=d.next}while(d!==a);return!1}function u(a,b){return-1===q(a.prev.p,a.p,a.next.p)?-1!==q(a.p,b.p,a.next.p)&&-1!==q(a.p,a.prev.p,b.p):-1===q(a.p,b.p,a.prev.p)||-1===q(a.p,a.next.p,b.p)}function v(a,b,c){var d=a,e=!1,f=(b[0]+c[0])/2,g=(b[1]+c[1])/2;do{var h=d.p,i=d.next.p;h[1]>g!=i[1]>g&&f<(i[0]-h[0])*(g-h[1])/(i[1]-h[1])+h[0]&&(e=!e),d=d.next}while(d!==a);return e}function w(a,b){return a.p[0]-b.p[0]}function x(a,b){var c=new z(a.p),d=new z(b.p),e=a.next,f=b.prev;return c.source=a,d.source=b,a.next=b,b.prev=a,c.next=e,e.prev=c,d.next=c,c.prev=d,f.next=d,d.prev=f,d}function y(a,b){var c=new z(a);return b?(c.next=b.next,c.prev=b,b.next.prev=c,b.next=c):(c.prev=c,c.next=c),c}function z(a){this.p=a,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.source=null,this.index=null}return a}(),t=function(){function a(a,b,c){return 0>c&&(c+=1),c>1&&(c-=1),1/6>c?a+6*(b-a)*c:.5>c?b:2/3>c?a+(b-a)*(2/3-c)*6:a}function b(a,b){return Math.min(b,Math.max(0,a))}var c={aqua:"#00ffff",black:"#000000",blue:"#0000ff",fuchsia:"#ff00ff",gray:"#808080",grey:"#808080",green:"#008000",lime:"#00ff00",maroon:"#800000",navy:"#000080",olive:"#808000",orange:"#ffa500",purple:"#800080",red:"#ff0000",silver:"#c0c0c0",teal:"#008080",white:"#ffffff",yellow:"#ffff00"},d=function(a,b,c,d){this.H=a,this.S=b,this.L=c,this.A=d};return d.parse=function(a){var b,d=0,e=0,f=0,g=1;if(a=(""+a).toLowerCase(),a=c[a]||a,b=a.match(/^#(\w{2})(\w{2})(\w{2})$/))d=parseInt(b[1],16),e=parseInt(b[2],16),f=parseInt(b[3],16);else{if(!(b=a.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/)))return;d=parseInt(b[1],10),e=parseInt(b[2],10),f=parseInt(b[3],10),g=b[4]?parseFloat(b[5]):1}return this.fromRGBA(d,e,f,g)},d.fromRGBA=function(a,b,c,e){"object"==typeof a?(b=a.g/255,c=a.b/255,e=a.a,a=a.r/255):(a/=255,b/=255,c/=255);var f,g,h=Math.max(a,b,c),i=Math.min(a,b,c),j=(h+i)/2,k=h-i;if(k){switch(g=j>.5?k/(2-h-i):k/(h+i),h){case a:f=(b-c)/k+(c>b?6:0);break;case b:f=(c-a)/k+2;break;case c:f=(a-b)/k+4}f*=60}else f=g=0;return new d(f,g,j,e)},d.prototype={toRGBA:function(){var c=b(this.H,360),d=b(this.S,1),e=b(this.L,1),f={a:b(this.A,1)};if(0===d)f.r=e,f.g=e,f.b=e;else{var g=.5>e?e*(1+d):e+d-e*d,h=2*e-g;c/=360,f.r=a(h,g,c+1/3),f.g=a(h,g,c),f.b=a(h,g,c-1/3)}return{r:Math.round(255*f.r),g:Math.round(255*f.g),b:Math.round(255*f.b),a:f.a}},toString:function(){var a=this.toRGBA();return 1===a.a?"#"+((1<<24)+(a.r<<16)+(a.g<<8)+a.b).toString(16).slice(1,7):"rgba("+[a.r,a.g,a.b,a.a.toFixed(2)].join(",")+")"},hue:function(a){return new d(this.H*a,this.S,this.L,this.A)},saturation:function(a){return new d(this.H,this.S*a,this.L,this.A)},lightness:function(a){return new d(this.H,this.S,this.L*a,this.A)},alpha:function(a){return new d(this.H,this.S,this.L,this.A*a)}},d}(this),u=function(a,b){b=b||{};var c=F.getElementById(a);if(this.view=new Y.View(c),this.renderer=new _({backgroundColor:b.backgroundColor,showBackfaces:b.showBackfaces}),this.renderer.start(),v.init(b),w.init(c),this.setDisabled(b.disabled),b.style&&this.setStyle(b.style),O.setSource(b.tileSource),M.setSource(b.dataSource,b.dataKey||A),null!==b.attribution&&b.attribution!==!1&&""!==b.attribution){var d=F.createElement("DIV");d.setAttribute("style","position:absolute;right:0;bottom:0;padding:1px 3px;background:rgba(255,255,255,0.5);font:11px sans-serif"),d.innerHTML=b.attribution||u.ATTRIBUTION,c.appendChild(d)}};u.VERSION="0.1.8",u.ATTRIBUTION="Â© OSM Buildings (http://osmbuildings.org)</a>",u.ATTRIBUTION_HTML='&copy; <a href="http://osmbuildings.org">OSM Buildings</a>',u.prototype={setStyle:function(a){var b=a.color||a.wallColor;return b&&(D=t.parse(b).toRGBA()),this},addModifier:function(a){return Q.addModifier(a),this},removeModifier:function(a){return Q.removeModifier(a),this},addMesh:function(){console.warn("Method addMesh() is deprecated and will be removed soon. Use addGeoJSON() or addOBJ() instead.")},addOBJ:function(a,b){return new T(a,b)},addGeoJSON:function(a,b){return new S(a,b)},on:function(a,b){return w.on(a,b),this},off:function(a,b){return w.off(a,b),this},setDisabled:function(a){return w.setDisabled(a),this},isDisabled:function(){return w.isDisabled()},setZoom:function(a){return v.setZoom(a),this},getZoom:function(){return v.zoom},setPosition:function(a){return v.setPosition(a),this},getPosition:function(){return v.getPosition()},getBounds:function(){var a=v.bounds,b=z*Math.pow(2,v.zoom),c=j(a.minX,a.maxY,b),d=j(a.maxX,a.minY,b);return{n:c.latitude,w:c.longitude,s:d.latitude,e:d.longitude}},setSize:function(a){return this.view.setSize(a.width,a.height),this},getSize:function(){return{width:Z,height:$}},setRotation:function(a){return v.setRotation(a),this},getRotation:function(){return v.rotation},setTilt:function(a){return v.setTilt(a),this},getTilt:function(){return v.tilt},transform:function(a,b,c){{var d=i(a,b,z*Math.pow(2,v.zoom)),e=v.center,f=d.x-e.x,g=d.y-e.y,h=c,j=v.transform.data,k=f*j[0]+g*j[4]+h*j[8]+j[12],l=f*j[1]+g*j[5]+h*j[9]+j[13];f*j[2]+g*j[6]+h*j[10]+j[14],f*j[3]+g*j[7]+h*j[11]+j[15]}return{x:k*Z,y:l*$}},destroy:function(){this.view.destroy(),this.renderer.destroy(),O.destroy(),M.destroy()}},"function"==typeof define?define([],u):"object"==typeof exports?module.exports=u:a.OSMBuildingsGL=u;var v={};!function(){function a(){var a=v.center,b=Z/2,c=$/2;v.bounds={maxY:a.y+c,minX:a.x-b,minY:a.y-c,maxX:a.x+b}}v.center={x:0,y:0},v.zoom=0,v.init=function(b){v.minZoom=parseFloat(b.minZoom)||10,v.maxZoom=parseFloat(b.maxZoom)||20,v.maxZoom<v.minZoom&&(v.maxZoom=v.minZoom),b=x.load(b),v.setPosition(b.position||{latitude:52.52,longitude:13.41}),v.setZoom(b.zoom||v.minZoom),v.setRotation(b.rotation||0),v.setTilt(b.tilt||0),w.on("resize",a),x.save(v)},v.setZoom=function(b,c){if(b=f(parseFloat(b),v.minZoom,v.maxZoom),v.zoom!==b){var d=Math.pow(2,b-v.zoom);if(v.zoom=b,c){var e=Z/2-c.clientX,g=$/2-c.clientY;v.center.x-=e,v.center.y-=g,v.center.x*=d,v.center.y*=d,v.center.x+=e,v.center.y+=g}else v.center.x*=d,v.center.y*=d;a(),w.emit("change")}},v.getPosition=function(){return j(v.center.x,v.center.y,z*Math.pow(2,v.zoom))},v.setPosition=function(a){var b=f(parseFloat(a.latitude),-90,90),c=f(parseFloat(a.longitude),-180,180),d=i(b,c,z*Math.pow(2,v.zoom));v.setCenter(d)},v.setCenter=function(b){(v.center.x!==b.x||v.center.y!==b.y)&&(v.center=b,a(),w.emit("change"))},v.setRotation=function(b){b=parseFloat(b)%360,v.rotation!==b&&(v.rotation=b,a(),w.emit("change"))},v.setTilt=function(b){b=f(parseFloat(b),0,60),v.tilt!==b&&(v.tilt=b,a(),w.emit("change"))},v.destroy=function(){}}();var w={};!function(){function d(a){if(!(E||a.button>1)){if(c(a),B=v.zoom,C=v.rotation,D=v.tilt,m=360/innerWidth,n=360/innerHeight,void 0===a.touches)l=a.button;else{if(a.touches.length>1)return;a=a.touches[0]}z=x=a.clientX,A=y=a.clientY,G=!0}}function e(a){if(!E&&G){if(void 0!==a.touches){if(a.touches.length>1)return;a=a.touches[0]}void 0===a.touches&&0!==l||a.altKey?(C+=(a.clientX-x)*m,D-=(a.clientY-y)*n,v.setRotation(C),v.setTilt(D)):k(a),x=a.clientX,y=a.clientY}}function f(a){if(!E&&G){if(void 0!==a.touches){if(a.touches.length>1)return;a=a.touches[0]}void 0===a.touches&&0!==l||a.altKey?(C+=(a.clientX-x)*m,D-=(a.clientY-y)*n,v.setRotation(C),v.setTilt(D)):Math.abs(a.clientX-z)<5&&Math.abs(a.clientY-A)<5?i(a):k(a),G=!1}}function g(a){E||(c(a),v.setZoom(B+(a.scale-1)),v.setRotation(C-a.rotation))}function h(a){E||(c(a),v.setZoom(v.zoom+1,a))}function i(a){E||(c(a),bb.getFeatureID({x:a.clientX,y:a.clientY},function(a){w.emit("click",{target:{id:a}})}))}function j(a){if(!E){c(a);var b=0;a.wheelDeltaY?b=a.wheelDeltaY:a.wheelDelta?b=a.wheelDelta:a.detail&&(b=-a.detail);var d=.2*(b>0?1:0>b?-1:0);v.setZoom(v.zoom+d,a)}}function k(a){var b=a.clientX-x,c=a.clientY-y,d=r(b,c,v.rotation*Math.PI/180);v.setCenter({x:v.center.x-d.x,y:v.center.y-d.y})}var l,m,n,o,p={},q="ontouchstart"in a,s=q?"touchstart":"mousedown",t=q?"touchmove":"mousemove",u=q?"touchend":"mouseup",x=0,y=0,z=0,A=0,B=0,C=0,D=0,E=!1,G=!1;w.init=function(c){b(c,s,d),b(c,"dblclick",h),b(F,t,e),b(F,u,f),q?b(c,"gesturechange",g):(b(c,"mousewheel",j),b(c,"DOMMouseScroll",j)),b(a,"resize",function(){clearTimeout(o),o=setTimeout(function(){w.emit("resize")},250)})},w.on=function(a,b){p[a]||(p[a]=[]),p[a].push(b)},w.off=function(){},w.emit=function(a,b){if(p[a])for(var c=0,d=p[a].length;d>c;c++)p[a][c](b)},w.setDisabled=function(a){E=!!a},w.isDisabled=function(){return!!E},w.destroy=function(){p=null}}();var x={};!function(){function a(a){if(history.replaceState){var b=[],c=a.getPosition();b.push("lat="+c.latitude.toFixed(5)),b.push("lon="+c.longitude.toFixed(5)),b.push("zoom="+a.zoom.toFixed(1)),b.push("tilt="+a.tilt.toFixed(1)),b.push("rotation="+a.rotation.toFixed(1)),history.replaceState({},"","?"+b.join("&"))}}x.load=function(a){var b=location.search;if(b){var c={};b=b.substring(1).replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(a,b,d){b&&(c[b]=d)});void 0!==c.lat&&void 0!==c.lon&&(a.position={latitude:parseFloat(c.lat),longitude:parseFloat(c.lon)}),void 0!==c.zoom&&(a.zoom=parseFloat(c.zoom)),void 0!==c.rotation&&(a.rotation=parseFloat(c.rotation)),void 0!==c.tilt&&(a.tilt=parseFloat(c.tilt))}return a};var b;x.save=function(c){clearTimeout(b),b=setTimeout(function(){a(c)},1e3)},w.on("change",function(){x.save(v)})}();var y=(Math.PI,14.5),z=256,A="anonymous",B="http://{s}.data.osmbuildings.org/0.2/{k}/tile/{z}/{x}/{y}.json",C=10,D=t.parse("rgb(220, 210, 200)").toRGBA(),E={zoomAlpha:{min:{zoom:17,alpha:1},max:{zoom:20,alpha:1}}},F=a.document,G=6378137,H=G*Math.PI*2,I={};!function(){function a(a,c){if(b[a])return b[a];var f=new XMLHttpRequest;return f.onreadystatechange=function(){4===f.readyState&&(delete b[a],e(a),!f.status||f.status<200||f.status>299||c(f))},b[a]=f,f.open("GET",a),d(a),f.send(null),{abort:function(){b[a]&&(e(a),f.abort(),delete b[a])}}}var b={};I.getText=function(b,c){return a(b,function(a){void 0!==a.responseText&&c(a.responseText)})},I.getXML=function(b,c){return a(b,function(a){void 0!==a.responseXML&&c(a.responseXML)})},I.getJSON=function(b,c){return a(b,function(a){if(a.responseText){var d;try{d=JSON.parse(a.responseText)}catch(e){console.error("Could not parse JSON from "+b+"\n"+e.message)}c(d)}})},I.abortAll=function(){for(var a in b)b[a].abort();b={}},I.destroy=function(){I.abortAll(),b=null}}();var J=[],K={interaction:{src:{vertex:"#ifdef GL_ES\nprecision mediump float;\n#endif\nattribute vec4 aPosition;\nattribute vec3 aColor;\nattribute float aHidden;\nuniform mat4 uMatrix;\nvarying vec3 vColor;\nvoid main() {\n  if (aHidden == 1.0) {\n    gl_Position = vec4(0.0);\n    vColor = vec3(0.0);\n  } else {\n    gl_Position = uMatrix * aPosition;\n    vColor = aColor;\n  }\n}\n",fragment:"#ifdef GL_ES\nprecision mediump float;\n#endif\nvarying vec3 vColor;\nvoid main() {\n  gl_FragColor = vec4(vColor, 1.0);\n}\n"},attributes:["aPosition","aColor","aHidden"],uniforms:["uMatrix"],framebuffer:!0},depth:{src:{vertex:"#ifdef GL_ES\nprecision mediump float;\n#endif\nattribute vec4 aPosition;\nattribute float aHidden;\nuniform mat4 uMatrix;\nvarying vec4 vPosition;\nvoid main() {\n  if (aHidden == 1.0) {\n    gl_Position = vec4(0.0);\n    vPosition = vec4(0.0);\n  } else {\n    gl_Position = uMatrix * aPosition;\n    vPosition = aPosition;\n  }\n}\n",fragment:"#ifdef GL_ES\nprecision mediump float;\n#endif\nvarying vec4 vPosition;\nvoid main() {\n	gl_FragColor = vec4(vPosition.xyz, length(vPosition));\n}\n"},attributes:["aPosition","aHidden"],uniforms:["uMatrix"],framebuffer:!0},textured:{src:{vertex:"#ifdef GL_ES\nprecision mediump float;\n#endif\nattribute vec4 aPosition;\nattribute vec2 aTexCoord;\nuniform mat4 uMatrix;\nvarying vec2 vTexCoord;\nvoid main() {\n  gl_Position = uMatrix * aPosition;\n  vTexCoord = aTexCoord;\n}\n",fragment:"#ifdef GL_ES\nprecision mediump float;\n#endif\nuniform sampler2D uTileImage;\nvarying vec2 vTexCoord;\nvoid main() {\n  gl_FragColor = texture2D(uTileImage, vec2(vTexCoord.x, -vTexCoord.y));\n}\n"},attributes:["aPosition","aTexCoord"],uniforms:["uMatrix","uTileImage"]},buildings:{src:{vertex:"#ifdef GL_ES\nprecision mediump float;\n#endif\nattribute vec4 aPosition;\nattribute vec3 aNormal;\nattribute vec3 aColor;\nattribute float aHidden;\nuniform mat4 uMatrix;\nuniform mat3 uNormalTransform;\nuniform vec3 uLightDirection;\nuniform vec3 uLightColor;\nvarying vec3 vColor;\nvarying vec4 vPosition;\nvoid main() {\n  if (aHidden == 1.0) {\n    gl_Position = vec4(0.0);\n    vPosition = vec4(0.0);\n    vColor = vec3(0.0, 0.0, 0.0);\n  } else {\n    gl_Position = uMatrix * aPosition;\n    vPosition = aPosition;\n    vec3 transformedNormal = aNormal * uNormalTransform;\n    float intensity = max( dot(transformedNormal, uLightDirection), 0.0) / 1.5;\n    vColor = aColor + uLightColor * intensity;\n  }\n}",fragment:"#ifdef GL_ES\nprecision mediump float;\n#endif\nuniform float uAlpha;\nvarying vec4 vPosition;\nvarying vec3 vColor;\nfloat gradientHeight = 90.0;\nfloat maxGradientStrength = 0.3;\nvoid main() {\n  float shading = clamp((gradientHeight-vPosition.z) / (gradientHeight/maxGradientStrength), 0.0, maxGradientStrength);\n  gl_FragColor = vec4(vColor - shading, uAlpha);\n}\n"},attributes:["aPosition","aColor","aNormal","aHidden"],uniforms:["uMatrix","uNormalTransform","uAlpha","uLightColor","uLightDirection"]}},L={};!function(){function a(a,b,c){var d=a[0]-b[0],e=a[1]-b[1],f=a[2]-b[2],g=b[0]-c[0],h=b[1]-c[1],i=b[2]-c[2],j=e*i-f*h,k=f*g-d*i,l=d*h-e*g,m=q(j,k,l);return 0===Math.round(5e3*m[2])}var b=32,c=32;L.quad=function(a,b,c,d,e){L.addTriangle(a,b,c,d),L.addTriangle(a,c,e,d)},L.circle=function(a,b,d,e){for(var f,g,h=0;c>h;h++)f=h/c,g=(h+1)/c,L.addTriangle(a,[b[0]+d*Math.sin(f*Math.PI*2),b[1]+d*Math.cos(f*Math.PI*2),e],[b[0],b[1],e],[b[0]+d*Math.sin(g*Math.PI*2),b[1]+d*Math.cos(g*Math.PI*2),e])},L.polygon=function(a,b,c){for(var d=s(b),e=0,f=d.length-2;f>e;e+=3)L.addTriangle(a,[d[e][0],d[e][1],c],[d[e+1][0],d[e+1][1],c],[d[e+2][0],d[e+2][1],c])},L.polygon3d=function(b,c){var d,e,f,g=c[0],h=g.length;if(4>=h)return L.addTriangle(b,g[0],g[2],g[1]),void(4===h&&this.addTriangle(b,g[0],g[3],g[2]));if(a(g[0],g[1],g[2])){for(var i=0,j=c[0].length;j>i;i++)c[0][i]=[c[0][i][2],c[0][i][1],c[0][i][0]];for(d=s(c),e=0,f=d.length-2;f>e;e+=3)L.addTriangle(b,[d[e][2],d[e][1],d[e][0]],[d[e+1][2],d[e+1][1],d[e+1][0]],[d[e+2][2],d[e+2][1],d[e+2][0]])}else for(d=s(c),e=0,f=d.length-2;f>e;e+=3)L.addTriangle(b,[d[e][0],d[e][1],d[e][2]],[d[e+1][0],d[e+1][1],d[e+1][2]],[d[e+2][0],d[e+2][1],d[e+2][2]])},L.cylinder=function(a,b,d,e,f,g){for(var h,i,j,k,l,m,n=0;c>n;n++)h=n/c,i=(n+1)/c,j=Math.sin(h*Math.PI*2),k=Math.cos(h*Math.PI*2),l=Math.sin(i*Math.PI*2),m=Math.cos(i*Math.PI*2),L.addTriangle(a,[b[0]+d*j,b[1]+d*k,f],[b[0]+e*l,b[1]+e*m,g],[b[0]+d*l,b[1]+d*m,f]),0!==e&&L.addTriangle(a,[b[0]+e*j,b[1]+e*k,g],[b[0]+e*l,b[1]+e*m,g],[b[0]+d*j,b[1]+d*k,f])},L.pyramid=function(a,b,c,d,e){b=b[0];for(var f=0,g=b.length-1;g>f;f++)L.addTriangle(a,[b[f][0],b[f][1],d],[b[f+1][0],b[f+1][1],d],[c[0],c[1],e])},L.dome=function(a,d,e){for(var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w=Math.sin,x=Math.cos,y=Math.PI,z={vertices:[],texCoords:[]},A=0;c>A;A++)for(r=A/c,f=2*r*y,g=x(f)*e,h=w(f)*e,s=(A+1)/c,i=2*s*y,j=x(i)*e,k=w(i)*e,v=0;b>v;v++)l=v*y/(2*b),m=(v+1)*y/(2*b),n=[g*x(l),h*x(l),e*w(l)],o=[j*x(l),k*x(l),e*w(l)],p=[j*x(m),k*x(m),e*w(m)],q=[g*x(m),h*x(m),e*w(m)],z.vertices.push.apply(z.vertices,n),z.vertices.push.apply(z.vertices,o),z.vertices.push.apply(z.vertices,p),z.vertices.push.apply(z.vertices,n),z.vertices.push.apply(z.vertices,p),z.vertices.push.apply(z.vertices,q),t=1-(v+1)/b,u=1-v/b,z.texCoords.push(r,u,s,u,s,t,r,u,s,t,r,t);return z},L.sphere=function(a,c,d,e,f){for(var g,h,i,j=0;j<latSegments;j++)g=j*Math.PI/b,h=Math.sin(g),i=Math.cos(g),L.cylinder(a,c,radiusBottom,radiusTop,e,f)},L.extrusion=function(a,b,c,d){for(var e,f,g,h,i,j,k=0,l=b.length;l>k;k++){e=b[k],f=e.length-1,(e[0][0]!==e[f][0]||e[0][1]!==e[f][1])&&(e.push(e[0]),f++);for(var m=0;f>m;m++)g=e[m],h=e[m+1],i=c,j=d,L.quad(a,[g[0],g[1],i],[h[0],h[1],i],[g[0],g[1],j],[h[0],h[1],j])}},L.addTriangle=function(a,b,c,d){a.vertices.push(b[0],b[1],b[2],d[0],d[1],d[2],c[0],c[1],c[2]);var e=p(b[0],b[1],b[2],c[0],c[1],c[2],d[0],d[1],d[2]);a.normals.push(e[0],e[1],e[2],e[0],e[1],e[2],e[0],e[1],e[2])}}();var M={};!function(){function a(a){return b(),a?void(h||(h=setTimeout(function(){h=null,c()},a))):void c()}function b(){i=Math.round(q||v.zoom);var a=Math.pow(2,i-v.zoom)/z,b=v.bounds;j=(b.minX*a<<0)-1,l=(b.minY*a<<0)-1,n=Math.ceil(b.maxX*a)+1,o=Math.ceil(b.maxY*a)+1}function c(){if(!(v.zoom<y)){var a,b,c,e,g=[],h=[j+(n-j-1)/2,o];for(b=l;o>b;b++)for(a=j;n>a;a++)c=[a,b,i].join(","),p[c]||(p[c]=new N(a,b,i),g.push({tile:p[c],dist:m([a,b],h)}));if(e=g.length){g.sort(function(a,b){return a.dist-b.dist});for(var k,q=0;e>q;q++)k=g[q].tile,k.load(f(k.tileX,k.tileY,k.zoom));d()}}}function d(){for(var a in p)e(p[a],1)||(p[a].destroy(),delete p[a])}function e(a,b){b=b||0;var c=a.tileX,d=a.tileY;return a.zoom===i&&c>=j-b&&n+b>=c&&d>=l-b&&o+b>=d}function f(a,b,c){var d="abcd"[(a+b)%4];return k(g,{s:d,x:a,y:b,z:c})}var g,h,i,j,l,n,o,p={},q=16;M.setSource=function(b,c){(void 0===b||b===!1||""===b)&&(b=B.replace("{k}",c)),b&&(g=b,w.on("change",function(){a(1e3)}),w.on("resize",a),a())},M.destroy=function(){clearTimeout(h);for(var a in p)p[a].destroy();p=null}}();var N=function(a,b,c){this.tileX=a,this.tileY=b,this.zoom=c};N.prototype={load:function(a){this.mesh=new S(a)},destroy:function(){this.mesh&&(this.mesh.destroy(),this.mesh=null)}};var O={};!function(){function a(a){return b(),a?void(h||(h=setTimeout(function(){h=null,c()},a))):void c()}function b(){i=Math.round(v.zoom);var a=Math.pow(2,i-v.zoom)/z,b=v.bounds;j=(b.minX*a<<0)-1,l=(b.minY*a<<0)-1,n=Math.ceil(b.maxX*a)+1,o=Math.ceil(b.maxY*a)+1}function c(){var a,b,c,e,g=[],h=[j+(n-j-1)/2,o];for(b=l;o>b;b++)for(a=j;n>a;a++)c=[a,b,i].join(","),p[c]||(p[c]=new P(a,b,i),g.push({tile:p[c],dist:m([a,b],h)}));if(e=g.length){g.sort(function(a,b){return a.dist-b.dist});for(var k,q=0;e>q;q++)k=g[q].tile,k.load(f(k.tileX,k.tileY,k.zoom));d()}}function d(){for(var a in p)e(p[a],1)||(p[a].destroy(),delete p[a])}function e(a,b){b=b||0;var c=a.tileX,d=a.tileY;return a.zoom===i&&c>=j-b&&n+b>=c&&d>=l-b&&o+b>=d}function f(a,b,c){var d="abcd"[(a+b)%4];return k(g,{s:d,x:a,y:b,z:c})}var g,h,i,j,l,n,o,p={};O.setSource=function(b){b&&(g=b,w.on("change",function(){a(1e3)}),w.on("resize",a),a())},O.getTiles=function(){return p},O.destroy=function(){clearTimeout(h);for(var a in p)p[a].destroy();p=null}}();var P=function(a,b,c){this.tileX=a,this.tileY=b,this.zoom=c,this.vertexBuffer=new Y.Buffer(3,new Float32Array([255,255,0,255,0,0,0,255,0,0,0,0])),this.texCoordBuffer=new Y.Buffer(2,new Float32Array([1,1,1,0,0,1,0,0])),this.texture=new Y.Texture};P.prototype={load:function(a){this.texture.load(a)},getMatrix:function(){if(this.texture.isLoaded){var a=new W,b=1/Math.pow(2,this.zoom-v.zoom),c=v.center;return a.scale(1.005*b,1.005*b,1),a.translate(this.tileX*z*b-c.x,this.tileY*z*b-c.y,0),a}},destroy:function(){this.vertexBuffer.destroy(),this.texCoordBuffer.destroy(),this.texture.destroy()}};var Q={items:[],modifiers:[],add:function(a){this.items.push(a)},remove:function(a){for(var b=this.items,c=0,d=b.length;d>c;c++)if(b[c]===a)return void b.splice(c,1)},destroy:function(){this.items=null},addModifier:function(a){this.modifiers.push(a),w.emit("modify")},removeModifier:function(a){for(var b=0;b<this.modifiers.length;b++)if(this.modifiers[b]===a){this.modifiers.splice(b,1);break}w.emit("modify")},applyModifiers:function(a){for(var b=Object.create(a),c=this.modifiers,d=0,e=c.length;e>d;d++)c[d](b);return b}},R=function(a,b){b=b||{},this.isReady=!1,this.id=b.id,this.position=b.position||{},this.scale=b.scale||1,this.rotation=b.rotation||0,this.elevation=b.elevation||0,b.color&&(this.color=t.parse(b.color).toRGBA()),this.replaces=b.replaces||[],Q.add(this),w.on("modify",this.modify.bind(this))};!function(){R.prototype={_setItems:function(a){this.items=[];for(var b,c,d,e,f=[],g=[],h=[],i=0,j=a.length;j>i;i++){for(b=a[i],b.color=this.color||b.color||D,b.id=this.id||b.id,b.numVertices=b.vertices.length/3,c=bb.idToColor(b.id),d=0,e=b.vertices.length-2;e>d;d+=3)f.push(b.vertices[d],b.vertices[d+1],b.vertices[d+2]),g.push(b.normals[d],b.normals[d+1],b.normals[d+2]),h.push(c.r,c.g,c.b);delete b.vertices,delete b.normals,this.items.push(b)}this.vertexBuffer=new Y.Buffer(3,new Float32Array(f)),this.normalBuffer=new Y.Buffer(3,new Float32Array(g)),this.idColorBuffer=new Y.Buffer(3,new Uint8Array(h)),this.modify(),f=null,g=null,h=null,a=null},_replaceItems:function(){if(this.replaces.length){var a=this.replaces;Q.addModifier(function(b){a.indexOf(b.id)>=0&&(b.hidden=!0)})}},modify:function(){if(this.items){for(var a,b=[],c=[],d=0,e=this.items.length;e>d;d++){a=Q.applyModifiers(this.items[d]);for(var f=0,g=a.numVertices;g>f;f++)b.push(a.color.r,a.color.g,a.color.b),c.push(a.hidden?1:0)}return this.colorBuffer=new Y.Buffer(3,new Uint8Array(b)),this.visibilityBuffer=new Y.Buffer(1,new Float32Array(c)),b=null,c=null,this}},destroy:function(){Q.remove(this),this.isReady&&(this.vertexBuffer.destroy(),this.normalBuffer.destroy(),this.colorBuffer.destroy(),this.idColorBuffer.destroy(),this.visibilityBuffer.destroy()),this.request&&(this.request.abort(),this.request=null)}}}();var S=function(a,b){R.call(this,a,b),this.zoom=16,"string"==typeof a?this.request=I.getJSON(a,this._convert.bind(this)):this._convert(a)};!function(){S.prototype=Object.create(R.prototype),S.prototype._convert=function(a){if(this.request=null,a.features.length){var b=a.features[0].geometry.coordinates[0][0];this.position={latitude:b[1],longitude:b[0]};var c=i(b[1],b[0],z<<this.zoom);U.parse(c.x,c.y,this.zoom,a,function(a){this._setItems(a),this._replaceItems(),this.isReady=!0}.bind(this))}},S.prototype.getMatrix=function(){if(this.isReady){var a=new W;this.elevation&&a.translate(0,0,this.elevation);var b=1/Math.pow(2,this.zoom-v.zoom)*this.scale;a.scale(b,b,.65*b),a.rotateZ(-this.rotation);var c=i(this.position.latitude,this.position.longitude,z*Math.pow(2,v.zoom)),d=v.center;return a.translate(c.x-d.x,c.y-d.y,0),a}}}();var T=function(a,b){R.call(this,a,b),this.inMeters=z/(Math.cos(this.position.latitude*Math.PI/180)*H),this._baseURL=a.replace(/[^\/]+$/,""),this.request=I.getText(a,this._convert.bind(this))};!function(){T.prototype=Object.create(R.prototype),T.prototype._convert=function(a){var b=a.match(/^mtllib\s+(.*)$/m);return b?void I.getText(this._baseURL+b[1],function(b){V.parse(a,b,function(a){this._setItems(a),this._replaceItems(),this.isReady=!0}.bind(this))}.bind(this)):void setTimeout(function(){V.parse(a,null,function(a){this._setItems(a),this._replaceItems(),this.isReady=!0}.bind(this))}.bind(this),1)},T.prototype.getMatrix=function(){if(this.isReady){var a=new W;this.elevation&&a.translate(0,0,this.elevation);var b=Math.pow(2,v.zoom)*this.inMeters*this.scale;a.scale(b,b,b),a.rotateZ(-this.rotation);var c=i(this.position.latitude,this.position.longitude,z*Math.pow(2,v.zoom)),d=v.center;return a.translate(c.x-d.x,c.y-d.y,0),a}}}();var U={};!function(){function a(a){return a=a.toLowerCase(),"#"===a[0]?a:h[j[a]||a]||null}function b(b){var c,d={};b=b||{},d.height=b.height||(b.levels?b.levels*f:C),d.minHeight=b.minHeight||(b.minLevel?b.minLevel*f:0);var e=b.material?a(b.material):b.wallColor||b.color;d.wallColor=(c=t.parse(e))?c.toRGBA():D;var g=b.roofMaterial?a(b.roofMaterial):b.roofColor;switch(d.roofColor=(c=t.parse(g))?c.toRGBA():D,b.shape){case"cylinder":case"cone":case"dome":case"sphere":d.shape=b.shape,d.isRotational=!0;break;case"pyramid":d.shape=b.shape}switch(b.roofShape){case"cone":case"dome":d.roofShape=b.roofShape,d.isRotational=!0;break;case"pyramid":d.roofShape=b.roofShape}return d.roofShape&&b.roofHeight?(d.roofHeight=b.roofHeight,d.height=Math.max(0,d.height-d.roofHeight)):d.roofHeight=0,d.height+d.roofHeight<=d.minHeight?void 0:(b.relationId&&(d.relationId=b.relationId),d)}function c(a){var b,d,e,f=[];switch(a.type){case"GeometryCollection":for(d=0,e=a.geometries.length;e>d;d++)(b=c(a.geometries[d]))&&f.push.apply(f,b);return f;case"MultiPolygon":for(d=0,e=a.coordinates.length;e>d;d++)(b=c({type:"Polygon",coordinates:a.coordinates[d]}))&&f.push.apply(f,b);return f;case"Polygon":return[a.coordinates];default:return[]}}function d(a,b,c,d){for(var e,f,g,h,j=z*Math.pow(2,c),k=[],l=0,m=d.length;m>l;l++)for(h=d[l],k[l]=[],e=0,f=h.length-1;f>e;e++)g=i(h[e][1],h[e][0],j),k[l][e]=[g.x-a,g.y-b];return k}function e(a,f,h,i,j,k,l){for(var m,p,q,r,s,t,u,v,w,x,y,z=k.features,A=f+Math.min(z.length-f,g);A>f;f++)if(m=z[f],t=b(m.properties))for(p=c(m.geometry),r=0,s=p.length;s>r;r++){switch(u=d(h,i,j,p[r]),y=m.properties.relationId||m.id||m.properties.id,"cone"!==t.roofShape&&"dome"!==t.roofShape||t.shape||!n(u)||(t.shape="cylinder",t.isRotational=!0),v=o(u),x=[v.minX+(v.maxX-v.minX)/2,v.minY+(v.maxY-v.minY)/2],t.isRotational&&(w=(v.maxX-v.minX)/2),q={vertices:[],normals:[]},t.shape){case"cylinder":L.cylinder(q,x,w,w,t.minHeight,t.height);break;case"cone":L.cylinder(q,x,w,0,t.minHeight,t.height);break;case"sphere":L.cylinder(q,x,w,w/2,t.minHeight,t.height);break;case"pyramid":L.pyramid(q,u,x,t.minHeight,t.height);break;default:L.extrusion(q,u,t.minHeight,t.height)}switch(a.push({id:y,color:t.wallColor,vertices:q.vertices,normals:q.normals}),q={vertices:[],normals:[]},t.roofShape){case"cone":L.cylinder(q,x,w,0,t.height,t.height+t.roofHeight);break;case"dome":L.cylinder(q,x,w,w/2,t.height,t.height+t.roofHeight),L.circle(q,x,w/2,t.height+t.roofHeight);break;case"pyramid":L.pyramid(q,u,x,t.height,t.height+t.roofHeight);
break;default:"cylinder"===t.shape?L.circle(q,x,w,t.height):void 0===t.shape&&L.polygon(q,u,t.height)}a.push({id:y,color:t.roofColor,vertices:q.vertices,normals:q.normals})}f===z.length?(k=null,l(a)):setTimeout(function(){e(a,f,h,i,j,k,l)},10)}var f=3,g=1e3,h={brick:"#cc7755",bronze:"#ffeecc",canvas:"#fff8f0",concrete:"#999999",copper:"#a0e0d0",glass:"#e8f8f8",gold:"#ffcc00",plants:"#009933",metal:"#aaaaaa",panel:"#fff8f0",plaster:"#999999",roof_tiles:"#f08060",silver:"#cccccc",slate:"#666666",stone:"#996666",tar_paper:"#333333",wood:"#deb887"},j={asphalt:"tar_paper",bitumen:"tar_paper",block:"stone",bricks:"brick",glas:"glass",glassfront:"glass",grass:"plants",masonry:"stone",granite:"stone",panels:"panel",paving_stones:"stone",plastered:"plaster",rooftiles:"roof_tiles",roofingfelt:"tar_paper",sandstone:"stone",sheet:"canvas",sheets:"canvas",shingle:"tar_paper",shingles:"tar_paper",slates:"slate",steel:"metal",tar:"tar_paper",tent:"canvas",thatch:"plants",tile:"roof_tiles",tiles:"roof_tiles"};U.parse=function(a,b,c,d,f){var g=[];return d&&"FeatureCollection"===d.type?void e(g,0,a,b,c,d,f):void f(g)}}();var V=function(){this.vertices=[]};"undefined"!=typeof module&&(module.exports=V),V.prototype={parseMaterials:function(a){var b,c,d,e=a.split(/[\r\n]/g),f={},g=null;for(c=0,d=e.length;d>c;c++)switch(b=e[c].trim().split(/\s+/),b[0]){case"newmtl":this.storeMaterial(f,g),g={id:b[1],color:{}};break;case"Kd":g.color.r=255*parseFloat(b[1])<<0,g.color.g=255*parseFloat(b[2])<<0,g.color.b=255*parseFloat(b[3])<<0;break;case"d":g.color.a=parseFloat(b[1])}return this.storeMaterial(f,g),a=null,f},storeMaterial:function(a,b){null!==b&&(a[b.id]=b.color)},parseModel:function(a,b){var c,d,e,f,g,h=a.split(/[\r\n]/g),i=[],j=[];for(d=0,e=h.length;e>d;d++)switch(c=h[d].trim().split(/\s+/),c[0]){case"g":case"o":this.storeMesh(i,f,g,j),f=c[1],j=[];break;case"usemtl":this.storeMesh(i,f,g,j),b[c[1]]&&(g=b[c[1]]),j=[];break;case"v":this.vertices.push([parseFloat(c[1]),parseFloat(c[2]),parseFloat(c[3])]);break;case"f":j.push([parseFloat(c[1])-1,parseFloat(c[2])-1,parseFloat(c[3])-1])}return this.storeMesh(i,f,g,j),a=null,i},storeMesh:function(a,b,c,d){if(d.length){var e=this.createGeometry(d);a.push({id:b,color:c,vertices:e.vertices,normals:e.normals})}},createGeometry:function(a){for(var b,c,d,e,f,g,h,i={vertices:[],normals:[]},j=0,k=a.length;k>j;j++)b=this.vertices[a[j][0]],c=this.vertices[a[j][1]],d=this.vertices[a[j][2]],e=[c[0]-b[0],c[1]-b[1],c[2]-b[2]],f=[d[0]-b[0],d[1]-b[1],d[2]-b[2]],g=[e[1]*f[2]-e[2]*f[1],e[2]*f[0]-e[0]*f[2],e[0]*f[1]-e[1]*f[0]],h=Math.sqrt(g[0]*g[0]+g[1]*g[1]+g[2]*g[2]),g[0]/=h,g[1]/=h,g[2]/=h,i.vertices.push(b[0],b[2],b[1],c[0],c[2],c[1],d[0],d[2],d[1]),i.normals.push(g[0],g[1],g[2],g[0],g[1],g[2],g[0],g[1],g[2]);return i}},V.parse=function(a,b,c){var d=new V,e=b?d.parseMaterials(b):{};setTimeout(function(){c(d.parseModel(a,e))},10)};var W=function(a){a?this.data=new Float32Array(a):this.identity()};!function(){function a(a){return a*Math.PI/180}function b(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=a[9],m=a[10],n=a[11],o=a[12],p=a[13],q=a[14],r=a[15],s=b[0],t=b[1],u=b[2],v=b[3],w=b[4],x=b[5],y=b[6],z=b[7],A=b[8],B=b[9],C=b[10],D=b[11],E=b[12],F=b[13],G=b[14],H=b[15];return new Float32Array([c*s+d*w+e*A+f*E,c*t+d*x+e*B+f*F,c*u+d*y+e*C+f*G,c*v+d*z+e*D+f*H,g*s+h*w+i*A+j*E,g*t+h*x+i*B+j*F,g*u+h*y+i*C+j*G,g*v+h*z+i*D+j*H,k*s+l*w+m*A+n*E,k*t+l*x+m*B+n*F,k*u+l*y+m*C+n*G,k*v+l*z+m*D+n*H,o*s+p*w+q*A+r*E,o*t+p*x+q*B+r*F,o*u+p*y+q*C+r*G,o*v+p*z+q*D+r*H])}W.prototype={identity:function(){return this.data=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),this},multiply:function(a){return this.data=b(this.data,a.data),this},translate:function(a,c,d){return this.data=b(this.data,[1,0,0,0,0,1,0,0,0,0,1,0,a,c,d,1]),this},rotateX:function(c){var d=a(c),e=Math.cos(d),f=Math.sin(d);return this.data=b(this.data,[1,0,0,0,0,e,f,0,0,-f,e,0,0,0,0,1]),this},rotateY:function(c){var d=a(c),e=Math.cos(d),f=Math.sin(d);return this.data=b(this.data,[e,0,-f,0,0,1,0,0,f,0,e,0,0,0,0,1]),this},rotateZ:function(c){var d=a(c),e=Math.cos(d),f=Math.sin(d);return this.data=b(this.data,[e,-f,0,0,f,e,0,0,0,0,1,0,0,0,0,1]),this},scale:function(a,c,d){return this.data=b(this.data,[a,0,0,0,0,c,0,0,0,0,d,0,0,0,0,1]),this}},W.multiply=function(a,c){return b(a.data,c.data)},W._perspective=function(a,b,c,d){return new W([2/b,0,0,0,0,-2/c,0,0,0,40/d,-2/d,a*(-2/d),-1,1,0,1])},W.perspective=function(a,b,c,d){var e=1/Math.tan(a*(Math.PI/180)/2),f=1/(c-d);return new W([e/b,0,0,0,0,e,0,0,0,0,(d+c)*f,-1,0,0,2*d*c*f,0])},W.invert3=function(a){var b=a[0],c=a[1],d=a[2],e=a[4],f=a[5],g=a[6],h=a[8],i=a[9],j=a[10],k=j*f-g*i,l=-j*e+g*h,m=i*e-f*h,n=b*k+c*l+d*m;return n?(n=1/n,[k*n,(-j*c+d*i)*n,(g*c-d*f)*n,l*n,(j*b-d*h)*n,(-g*b+d*e)*n,m*n,(-i*b+c*h)*n,(f*b-c*e)*n]):null},W.transpose=function(a){return new Float32Array([a[0],a[3],a[6],a[1],a[4],a[7],a[2],a[5],a[8]])}}();var X,Y={},Z=0,$=0;Y.View=function(a){var b=this.canvas=F.createElement("CANVAS");b.style.position="absolute",b.style.pointerEvents="none",a.appendChild(b),this.setSize(a.offsetWidth,a.offsetHeight),w.on("resize",function(){this.setSize(a.offsetWidth,a.offsetHeight)}.bind(this));var c={antialias:!0,depth:!0,premultipliedAlpha:!1};try{X=b.getContext("webgl",c)}catch(d){}if(!X)try{X=b.getContext("experimental-webgl",c)}catch(d){}if(!X)throw new Error("WebGL not supported")},Y.View.prototype={setSize:function(a,b){(a!==Z||b!==$)&&(this.canvas.width=Z=a,this.canvas.height=$=b,w.emit("resize"))},destroy:function(){this.canvas.parentNode.removeChild(this.canvas),this.canvas=null}},Y.Buffer=function(a,b){this.id=X.createBuffer(),this.itemSize=a,this.numItems=b.length/a,X.bindBuffer(X.ARRAY_BUFFER,this.id),X.bufferData(X.ARRAY_BUFFER,b,X.STATIC_DRAW),b=null},Y.Buffer.prototype={enable:function(){X.bindBuffer(X.ARRAY_BUFFER,this.id)},destroy:function(){X.deleteBuffer(this.id)}},Y.Framebuffer=function(a,b){this.setSize(a,b)},Y.Framebuffer.prototype={setSize:function(a,b){this.frameBuffer=X.createFramebuffer(),X.bindFramebuffer(X.FRAMEBUFFER,this.frameBuffer),this.width=a||Z,this.height=b||$;var c=l(Math.max(this.width,this.height));if(this.renderBuffer=X.createRenderbuffer(),X.bindRenderbuffer(X.RENDERBUFFER,this.renderBuffer),X.renderbufferStorage(X.RENDERBUFFER,X.DEPTH_COMPONENT16,c,c),this.renderTexture&&this.renderTexture.destroy(),this.renderTexture=new Y.Texture({size:c}),X.framebufferRenderbuffer(X.FRAMEBUFFER,X.DEPTH_ATTACHMENT,X.RENDERBUFFER,this.renderBuffer),X.framebufferTexture2D(X.FRAMEBUFFER,X.COLOR_ATTACHMENT0,X.TEXTURE_2D,this.renderTexture.id,0),X.checkFramebufferStatus(X.FRAMEBUFFER)!==X.FRAMEBUFFER_COMPLETE)throw new Error("This combination of framebuffer attachments does not work");X.bindRenderbuffer(X.RENDERBUFFER,null),X.bindFramebuffer(X.FRAMEBUFFER,null)},enable:function(){X.bindFramebuffer(X.FRAMEBUFFER,this.frameBuffer),X.bindRenderbuffer(X.RENDERBUFFER,this.renderBuffer)},disable:function(){X.bindFramebuffer(X.FRAMEBUFFER,null),X.bindRenderbuffer(X.RENDERBUFFER,null)},getData:function(){var a=new Uint8Array(this.width*this.height*4);return X.readPixels(0,0,this.width,this.height,X.RGBA,X.UNSIGNED_BYTE,a),a},destroy:function(){this.renderTexture&&this.renderTexture.destroy()}},Y.Texture=function(a){a=a||{},this.id=X.createTexture(),X.bindTexture(X.TEXTURE_2D,this.id),a.size?(X.texParameteri(X.TEXTURE_2D,X.TEXTURE_MAG_FILTER,X.NEAREST),X.texParameteri(X.TEXTURE_2D,X.TEXTURE_MIN_FILTER,X.NEAREST),X.texImage2D(X.TEXTURE_2D,0,X.RGBA,a.size,a.size,0,X.RGBA,X.UNSIGNED_BYTE,null)):(X.pixelStorei(X.UNPACK_FLIP_Y_WEBGL,!0),X.texParameteri(X.TEXTURE_2D,X.TEXTURE_MAG_FILTER,a.filter||X.LINEAR),X.texParameteri(X.TEXTURE_2D,X.TEXTURE_MIN_FILTER,X.LINEAR_MIPMAP_NEAREST),a.image&&this.setImage(a.image),X.bindTexture(X.TEXTURE_2D,null))},Y.Texture.prototype={enable:function(a){X.bindTexture(X.TEXTURE_2D,this.id),X.activeTexture(X.TEXTURE0+(a||0))},disable:function(){X.bindTexture(X.TEXTURE_2D,null)},load:function(a,b){var c=this.image=new Image;c.crossOrigin="*",c.onload=function(){e(a);var d=X.getParameter(X.MAX_TEXTURE_SIZE);if(c.width>d||c.height>d){var f=d,g=d,h=c.width/c.height;1>h?f=Math.round(g*h):g=Math.round(f/h);var i=F.createElement("CANVAS");i.width=f,i.height=g;var j=i.getContext("2d");j.drawImage(c,0,0,i.width,i.height),c=i}this.setImage(c),this.isLoaded=!0,b&&b()}.bind(this),c.onerror=function(){e(a)},d(a),c.src=a},setImage:function(a){X.bindTexture(X.TEXTURE_2D,this.id),X.texImage2D(X.TEXTURE_2D,0,X.RGBA,X.RGBA,X.UNSIGNED_BYTE,a),X.generateMipmap(X.TEXTURE_2D),a=null},destroy:function(){X.bindTexture(X.TEXTURE_2D,null),X.deleteTexture(this.id),this.image&&(this.isLoaded=null,e(this.image.src),this.image.src="",this.image=null)}},Y.Shader=function(a){var b=K[a];if(this.id=X.createProgram(),this.name=a,!b.src)throw new Error('missing source for shader "'+a+'"');if(this.attach(X.VERTEX_SHADER,b.src.vertex),this.attach(X.FRAGMENT_SHADER,b.src.fragment),X.linkProgram(this.id),!X.getProgramParameter(this.id,X.LINK_STATUS))throw new Error(X.getProgramParameter(this.id,X.VALIDATE_STATUS)+"\n"+X.getError());this.attributeNames=b.attributes,this.uniformNames=b.uniforms,b.framebuffer&&(this.framebuffer=new Y.Framebuffer,w.on("resize",function(){this.framebuffer.setSize(Z,$)}.bind(this)))},Y.Shader.prototype={locateAttribute:function(a){var b=X.getAttribLocation(this.id,a);return 0>b?void console.error('unable to locate attribute "'+a+'" in shader "'+this.name+'"'):(X.enableVertexAttribArray(b),void(this.attributes[a]=b))},locateUniform:function(a){var b=X.getUniformLocation(this.id,a);return 0>b?void console.error('unable to locate uniform "'+a+'" in shader "'+this.name+'"'):void(this.uniforms[a]=b)},attach:function(a,b){var c=X.createShader(a);if(X.shaderSource(c,b),X.compileShader(c),!X.getShaderParameter(c,X.COMPILE_STATUS))throw new Error("("+this.name+") "+X.getShaderInfoLog(c));X.attachShader(this.id,c)},enable:function(){X.useProgram(this.id);var a;if(this.attributeNames)for(this.attributes={},a=0;a<this.attributeNames.length;a++)this.locateAttribute(this.attributeNames[a]);if(this.uniformNames)for(this.uniforms={},a=0;a<this.uniformNames.length;a++)this.locateUniform(this.uniformNames[a]);return this.framebuffer&&this.framebuffer.enable(),this},disable:function(){if(this.attributes)for(var a in this.attributes)X.disableVertexAttribArray(this.attributes[a]);this.attributes=null,this.uniforms=null,this.framebuffer&&this.framebuffer.disable()}};var _=function(a){this.layers={},this.layers.interaction=bb.initShader(),this.layers.skydome=cb.initShader(),this.layers.basemap=db.initShader(),this.layers.buildings=eb.initShader({showBackfaces:a.showBackfaces}),this.resize(),w.on("resize",this.resize.bind(this));var b=t.parse(a.backgroundColor||"#cccccc").toRGBA();this.backgroundColor={r:b.r/255,g:b.g/255,b:b.b/255},X.cullFace(X.BACK),X.enable(X.CULL_FACE),X.enable(X.DEPTH_TEST)};_.prototype={start:function(){this.loop=setInterval(function(){requestAnimationFrame(function(){v.transform=(new W).rotateZ(v.rotation).rotateX(v.tilt).translate(Z/2,$/2,0).multiply(this.perspective),this.layers.interaction.render(this),X.clearColor(this.backgroundColor.r,this.backgroundColor.g,this.backgroundColor.b,1),X.clear(X.COLOR_BUFFER_BIT|X.DEPTH_BUFFER_BIT),this.layers.skydome.render(this),this.layers.basemap.render(this),this.layers.buildings.render(this)}.bind(this))}.bind(this),17)},stop:function(){clearInterval(this.loop)},resize:function(){this.perspective=W._perspective(20,Z,$,4e4),X.viewport(0,0,Z,$)},destroy:function(){this.stop();for(var a in this.layers)this.layers[a].destroy()}};var ab={};!function(){var a;ab.initShader=function(){return a=new Y.Shader("depth"),this},ab.render=function(){if(!(v.zoom<y)){a.enable(),X.clearColor(0,0,0,1),X.clear(X.COLOR_BUFFER_BIT|X.DEPTH_BUFFER_BIT);for(var b,c,d=Q.items,e=0,f=d.length;f>e;e++)b=d[e],(c=b.getMatrix())&&(X.uniformMatrix4fv(a.uniforms.uMatrix,!1,c.multiply(v.transform).data),b.vertexBuffer.enable(),X.vertexAttribPointer(a.attributes.aPosition,b.vertexBuffer.itemSize,X.FLOAT,!1,0,0),X.drawArrays(X.TRIANGLES,0,b.vertexBuffer.numItems));a.disable()}}}();var bb={};!function(){var a,b,c=[null];bb.initShader=function(){return a=new Y.Shader("interaction"),this},bb.render=function(){if(b){if(v.zoom<y)return void b();a.enable(),X.clearColor(0,0,0,1),X.clear(X.COLOR_BUFFER_BIT|X.DEPTH_BUFFER_BIT);for(var c,d,e=Q.items,f=0,g=e.length;g>f;f++)c=e[f],(d=c.getMatrix())&&(X.uniformMatrix4fv(a.uniforms.uMatrix,!1,d.multiply(v.transform).data),c.vertexBuffer.enable(),X.vertexAttribPointer(a.attributes.aPosition,c.vertexBuffer.itemSize,X.FLOAT,!1,0,0),c.idColorBuffer.enable(),X.vertexAttribPointer(a.attributes.aColor,c.idColorBuffer.itemSize,X.UNSIGNED_BYTE,!0,0,0),c.visibilityBuffer.enable(),X.vertexAttribPointer(a.attributes.aHidden,c.visibilityBuffer.itemSize,X.FLOAT,!1,0,0),X.drawArrays(X.TRIANGLES,0,c.vertexBuffer.numItems));var h=a.framebuffer.getData();a.disable(),b(h)}},bb.idToColor=function(a){var b=c.indexOf(a);return-1===b&&(c.push(a),b=c.length-1),{r:255&b,g:b>>8&255,b:b>>16&255}},bb.getFeatureID=function(a,d){b=function(e){var f=4*(($-a.y)*Z+a.x),g=e[f]|e[f+1]<<8|e[f+2]<<16;d(c[g]),b=null}}}();var cb={};!function(){function a(){var a=Math.sqrt(Z*Z+$*$),b=1/Math.pow(2,y-v.zoom);return a*b/f}var b,c,d,e,f=100,g=L.dome({},{},f,0,0);cb.initShader=function(){return b=new Y.Shader("textured"),c=new Y.Buffer(3,new Float32Array(g.vertices)),d=new Y.Buffer(2,new Float32Array(g.texCoords)),e=new Y.Texture,e.load("skydome.jpg"),this},cb.render=function(f){if(e.isLoaded){b.enable(),X.clear(X.COLOR_BUFFER_BIT|X.DEPTH_BUFFER_BIT);var g=new W,h=a();g.scale(h,h,h),g.rotateZ(v.rotation).translate(Z/2,$/2,0).rotateX(v.tilt).translate(0,$/2,0).multiply(f.perspective),X.uniformMatrix4fv(b.uniforms.uMatrix,!1,g.data),c.enable(),X.vertexAttribPointer(b.attributes.aPosition,c.itemSize,X.FLOAT,!1,0,0),d.enable(),X.vertexAttribPointer(b.attributes.aTexCoord,d.itemSize,X.FLOAT,!1,0,0),e.enable(0),X.uniform1i(b.uniforms.uTileImage,0),X.drawArrays(X.TRIANGLES,0,c.numItems),b.disable()}},cb.getRadius=function(){return f*a()}}();var db={};!function(){var a;db.initShader=function(){return a=new Y.Shader("textured"),this},db.render=function(){var b,c,d=O.getTiles();a.enable();for(var e in d)b=d[e],(c=b.getMatrix())&&(X.uniformMatrix4fv(a.uniforms.uMatrix,!1,c.multiply(v.transform).data),b.vertexBuffer.enable(),X.vertexAttribPointer(a.attributes.aPosition,b.vertexBuffer.itemSize,X.FLOAT,!1,0,0),b.texCoordBuffer.enable(),X.vertexAttribPointer(a.attributes.aTexCoord,b.texCoordBuffer.itemSize,X.FLOAT,!1,0,0),b.texture.enable(0),X.uniform1i(a.uniforms.uTileImage,0),X.drawArrays(X.TRIANGLE_STRIP,0,b.vertexBuffer.numItems));a.disable()}}();var eb={};!function(){var a;eb.initShader=function(b){return a=new Y.Shader("buildings"),this.showBackfaces=b.showBackfaces,this},eb.render=function(){if(!(v.zoom<y)){a.enable(),this.showBackfaces&&X.disable(X.CULL_FACE),X.uniform3fv(a.uniforms.uLightColor,[.5,.5,.5]),X.uniform3fv(a.uniforms.uLightDirection,q(1,1,1)),X.uniform1f(a.uniforms.uAlpha,h(v.zoom,E.zoomAlpha,"zoom","alpha"));var b=W.invert3((new W).data);X.uniformMatrix3fv(a.uniforms.uNormalTransform,!1,W.transpose(b));for(var c,d,e=Q.items,f=0,g=e.length;g>f;f++)c=e[f],(d=c.getMatrix())&&(X.uniformMatrix4fv(a.uniforms.uMatrix,!1,d.multiply(v.transform).data),c.vertexBuffer.enable(),X.vertexAttribPointer(a.attributes.aPosition,c.vertexBuffer.itemSize,X.FLOAT,!1,0,0),c.normalBuffer.enable(),X.vertexAttribPointer(a.attributes.aNormal,c.normalBuffer.itemSize,X.FLOAT,!1,0,0),c.colorBuffer.enable(),X.vertexAttribPointer(a.attributes.aColor,c.colorBuffer.itemSize,X.UNSIGNED_BYTE,!0,0,0),c.visibilityBuffer.enable(),X.vertexAttribPointer(a.attributes.aHidden,c.visibilityBuffer.itemSize,X.FLOAT,!1,0,0),X.drawArrays(X.TRIANGLES,0,c.vertexBuffer.numItems));this.showBackfaces&&X.enable(X.CULL_FACE),a.disable()}}}()}(this);