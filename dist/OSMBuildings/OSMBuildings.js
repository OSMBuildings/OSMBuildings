!function(){var e=function(){var e={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgrey:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkslategrey:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgray:"#d3d3d3",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370db",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#db7093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",slategrey:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};function t(e,t,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?e+6*(t-e)*i:i<.5?t:i<2/3?e+(t-e)*(2/3-i)*6:e}function i(e,t){if(void 0!==e)return Math.min(t,Math.max(0,e||0))}var r=function(e,t,r,n){this.r=i(e,1),this.g=i(t,1),this.b=i(r,1),this.a=i(n,1)||1};return r.parse=function(t){if("string"==typeof t){var i;if(t=t.toLowerCase(),i=(t=e[t]||t).match(/^#?(\w{2})(\w{2})(\w{2})$/))return new r(parseInt(i[1],16)/255,parseInt(i[2],16)/255,parseInt(i[3],16)/255);if(i=t.match(/^#?(\w)(\w)(\w)$/))return new r(parseInt(i[1]+i[1],16)/255,parseInt(i[2]+i[2],16)/255,parseInt(i[3]+i[3],16)/255);if(i=t.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new r(parseFloat(i[1])/255,parseFloat(i[2])/255,parseFloat(i[3])/255,i[4]?parseFloat(i[5]):1)}return new r},r.fromHSL=function(e,t,i){var n=(new r).fromHSL(e,t,i);return n.a=a,n},r.prototype={isValid:function(){return void 0!==this.r&&void 0!==this.g&&void 0!==this.b},toHSL:function(){if(this.isValid()){var e,t,i=Math.max(this.r,this.g,this.b),r=Math.min(this.r,this.g,this.b),n=(i+r)/2,o=i-r;if(o){switch(t=n>.5?o/(2-i-r):o/(i+r),i){case this.r:e=(this.g-this.b)/o+(this.g<this.b?6:0);break;case this.g:e=(this.b-this.r)/o+2;break;case this.b:e=(this.r-this.g)/o+4}e*=60}else e=t=0;return{h:e,s:t,l:n}}},fromHSL:function(e,i,r){if(0===i)return this.r=this.g=this.b=r,this;var n=r<.5?r*(1+i):r+i-r*i,o=2*r-n;return e/=360,this.r=t(o,n,e+1/3),this.g=t(o,n,e),this.b=t(o,n,e-1/3),this},toString:function(){if(this.isValid())return 1===this.a?"#"+((1<<24)+(Math.round(255*this.r)<<16)+(Math.round(255*this.g)<<8)+Math.round(255*this.b)).toString(16).slice(1,7):"rgba("+[Math.round(255*this.r),Math.round(255*this.g),Math.round(255*this.b),this.a.toFixed(2)].join(",")+")"},toArray:function(){if(this.isValid)return[this.r,this.g,this.b]},hue:function(e){var t=this.toHSL();return this.fromHSL(t.h+e,t.s,t.l)},saturation:function(e){var t=this.toHSL();return this.fromHSL(t.h,t.s*e,t.l)},lightness:function(e){var t=this.toHSL();return this.fromHSL(t.h,t.s,t.l*e)},clone:function(){return new r(this.r,this.g,this.b,this.a)}},r}();"object"==typeof module&&(module.exports=e);var t=function(){"use strict";var e=Math.PI,t=Math.sin,i=Math.cos,r=Math.tan,n=Math.asin,o=Math.atan2,a=e/180,s=864e5,u=2440588,f=2451545;function l(e){return function(e){return e.valueOf()/s-.5+u}(e)-f}var h=23.4397*a;function d(s){var u,f,l=function(i){return i+a*(1.9148*t(i)+.02*t(2*i)+3e-4*t(3*i))+102.9372*a+e}(function(e){return a*(357.5291+.98560028*e)}(s));return{dec:(u=l,f=0,n(t(f)*i(h)+i(f)*t(h)*t(u))),ra:function(e,n){return o(t(e)*i(h)-r(n)*t(h),i(e))}(l,0)}}return function(e,s,u){var f=a*-u,h=a*s,c=l(e),m=d(c),v=function(e,t){return a*(280.16+360.9856235*e)-t}(c,f)-m.ra;return{azimuth:function(e,n,a){return o(t(e),i(e)*t(n)-r(a)*i(n))}(v,h,m.dec),altitude:function(e,r,o){return n(t(r)*t(o)+i(r)*i(o)*i(e))}(v,h,m.dec)}}}(),i={vertex:"precision highp float;  //is default in vertex shaders anyway, using highp fixes #49\n#define halfPi 1.57079632679\nattribute vec4 aPosition;\nattribute vec3 aId;\nattribute vec4 aFilter;\nuniform mat4 uModelMatrix;\nuniform mat4 uMatrix;\nuniform float uFogRadius;\nuniform float uTime;\nvarying vec4 vColor;\nvoid main() {\n  float t = clamp((uTime-aFilter.r) / (aFilter.g-aFilter.r), 0.0, 1.0);\n  float f = aFilter.b + (aFilter.a-aFilter.b) * t;\n  if (f == 0.0) {\n    gl_Position = vec4(0.0, 0.0, 0.0, 0.0);\n    vColor = vec4(0.0, 0.0, 0.0, 0.0);\n  } else {\n    vec4 pos = vec4(aPosition.x, aPosition.y, aPosition.z*f, aPosition.w);\n    gl_Position = uMatrix * pos;\n    vec4 mPosition = vec4(uModelMatrix * pos);\n    float distance = length(mPosition);\n    if (distance > uFogRadius) {\n      vColor = vec4(0.0, 0.0, 0.0, 0.0);\n    } else {\n      vColor = vec4(aId, 1.0);\n    }\n  }\n}\n",fragment:"#ifdef GL_ES\n  precision mediump float;\n#endif\nvarying vec4 vColor;\nvoid main() {\n  gl_FragColor = vColor;\n}\n"},r={vertex:"precision highp float;  //is default in vertex shaders anyway, using highp fixes #49\n#define halfPi 1.57079632679\nattribute vec4 aPosition;\nattribute vec2 aTexCoord;\nattribute vec3 aNormal;\nattribute vec3 aColor;\nattribute vec3 aId;\nattribute vec4 aFilter;\nattribute float aHeight;\nuniform mat4 uModelMatrix;\nuniform mat4 uMatrix;\nuniform mat3 uNormalTransform;\nuniform vec3 uLightDirection;\nuniform vec3 uLightColor;\nuniform vec3 uHighlightColor;\nuniform vec3 uHighlightId;\nuniform vec2 uViewDirOnMap;\nuniform vec2 uLowerEdgePoint;\nuniform float uTime;\nvarying vec3 vColor;\nvarying vec2 vTexCoord;\nvarying float verticalDistanceToLowerEdge;\nconst float gradientStrength = 0.4;\nvoid main() {\n  float t = clamp((uTime-aFilter.r) / (aFilter.g-aFilter.r), 0.0, 1.0);\n  float f = aFilter.b + (aFilter.a-aFilter.b) * t;\n  if (f == 0.0) {\n    gl_Position = vec4(0.0, 0.0, 0.0, 0.0);\n    vColor = vec3(0.0, 0.0, 0.0);\n  } else {\n    vec4 pos = vec4(aPosition.x, aPosition.y, aPosition.z*f, aPosition.w);\n    gl_Position = uMatrix * pos;\n    //*** highlight object ******************************************************\n    vec3 color = aColor;\n    if (uHighlightId == aId) {\n      color = mix(aColor, uHighlightColor, 0.5);\n    }\n    //*** light intensity, defined by light direction on surface ****************\n    vec3 transformedNormal = aNormal * uNormalTransform;\n    float lightIntensity = max( dot(transformedNormal, uLightDirection), 0.0) / 1.5;\n    color = color + uLightColor * lightIntensity;\n    vTexCoord = aTexCoord;\n    //*** vertical shading ******************************************************\n    float verticalShading = clamp(gradientStrength - ((pos.z*gradientStrength) / aHeight), 0.0, gradientStrength);\n    //***************************************************************************\n    vColor = color-verticalShading;\n    vec4 worldPos = uModelMatrix * pos;\n    vec2 dirFromLowerEdge = worldPos.xy / worldPos.w - uLowerEdgePoint;\n    verticalDistanceToLowerEdge = dot(dirFromLowerEdge, uViewDirOnMap);\n  }\n}\n",fragment:"#ifdef GL_ES\n  precision mediump float;\n#endif\nvarying vec3 vColor;\nvarying vec2 vTexCoord;\nvarying float verticalDistanceToLowerEdge;\nuniform vec3 uFogColor;\nuniform float uFogDistance;\nuniform float uFogBlurDistance;\nuniform sampler2D uWallTexIndex;\nvoid main() {\n    \n  float fogIntensity = (verticalDistanceToLowerEdge - uFogDistance) / uFogBlurDistance;\n  fogIntensity = clamp(fogIntensity, 0.0, 1.0);\n  gl_FragColor = vec4( vColor* texture2D(uWallTexIndex, vTexCoord).rgb, 1.0-fogIntensity);\n}\n"},n={vertex:"precision highp float;  //is default in vertex shaders anyway, using highp fixes #49\n#define halfPi 1.57079632679\nattribute vec4 aPosition;\nattribute vec3 aNormal;\nattribute vec3 aColor;\nattribute vec2 aTexCoord;\nattribute vec3 aId;\nattribute vec4 aFilter;\nattribute float aHeight;\nuniform mat4 uModelMatrix;\nuniform mat4 uMatrix;\nuniform mat4 uSunMatrix;\nuniform mat3 uNormalTransform;\nuniform vec3 uHighlightColor;\nuniform vec3 uHighlightId;\nuniform vec2 uViewDirOnMap;\nuniform vec2 uLowerEdgePoint;\nuniform float uTime;\nvarying vec3 vColor;\nvarying vec2 vTexCoord;\nvarying vec3 vNormal;\nvarying vec3 vSunRelPosition;\nvarying float verticalDistanceToLowerEdge;\nfloat gradientStrength = 0.4;\nvoid main() {\n  float t = clamp((uTime-aFilter.r) / (aFilter.g-aFilter.r), 0.0, 1.0);\n  float f = aFilter.b + (aFilter.a-aFilter.b) * t;\n  if (f == 0.0) {\n    gl_Position = vec4(0.0, 0.0, 0.0, 0.0);\n    vColor = vec3(0.0, 0.0, 0.0);\n  } else {\n    vec4 pos = vec4(aPosition.x, aPosition.y, aPosition.z*f, aPosition.w);\n    gl_Position = uMatrix * pos;\n    //*** highlight object ******************************************************\n    vec3 color = aColor;\n    if (uHighlightId == aId) {\n      color = mix(aColor, uHighlightColor, 0.5);\n    }\n    //*** light intensity, defined by light direction on surface ****************\n    vNormal = aNormal;\n    vTexCoord = aTexCoord;\n    //vec3 transformedNormal = aNormal * uNormalTransform;\n    //float lightIntensity = max( dot(aNormal, uLightDirection), 0.0) / 1.5;\n    //color = color + uLightColor * lightIntensity;\n    //*** vertical shading ******************************************************\n    float verticalShading = clamp(gradientStrength - ((pos.z*gradientStrength) / aHeight), 0.0, gradientStrength);\n    //***************************************************************************\n    vColor = color-verticalShading;\n    vec4 worldPos = uModelMatrix * pos;\n    vec2 dirFromLowerEdge = worldPos.xy / worldPos.w - uLowerEdgePoint;\n    verticalDistanceToLowerEdge = dot(dirFromLowerEdge, uViewDirOnMap);\n    \n    // *** shadow mapping ********\n    vec4 sunRelPosition = uSunMatrix * pos;\n    vSunRelPosition = (sunRelPosition.xyz / sunRelPosition.w + 1.0) / 2.0;\n  }\n}\n",fragment:"\n#ifdef GL_FRAGMENT_PRECISION_HIGH\n  precision highp float;\n#else\n  precision mediump float;\n#endif\nvarying vec2 vTexCoord;\nvarying vec3 vColor;\nvarying vec3 vNormal;\nvarying vec3 vSunRelPosition;\nvarying float verticalDistanceToLowerEdge;\nuniform vec3 uFogColor;\nuniform vec2 uShadowTexDimensions;\nuniform sampler2D uShadowTexIndex;\nuniform sampler2D uWallTexIndex;\nuniform float uFogDistance;\nuniform float uFogBlurDistance;\nuniform float uShadowStrength;\nuniform vec3 uLightDirection;\nuniform vec3 uLightColor;\nfloat isSeenBySun(const vec2 sunViewNDC, const float depth, const float bias) {\n  if ( clamp( sunViewNDC, 0.0, 1.0) != sunViewNDC)  //not inside sun's viewport\n    return 1.0;\n  \n  float depthFromTexture = texture2D( uShadowTexIndex, sunViewNDC.xy).x;\n  \n  //compare depth values not in reciprocal but in linear depth\n  return step(1.0/depthFromTexture, 1.0/depth + bias);\n}\nvoid main() {\n  vec3 normal = normalize(vNormal); //may degenerate during per-pixel interpolation\n  float diffuse = dot(uLightDirection, normal);\n  diffuse = max(diffuse, 0.0);\n  // reduce shadow strength with:\n  // - lowering sun positions, to be consistent with the shadows on the basemap (there,\n  //   shadows are faded out with lowering sun positions to hide shadow artifacts caused\n  //   when sun direction and map surface are almost perpendicular\n  // - large angles between the sun direction and the surface normal, to hide shadow\n  //   artifacts that occur when surface normal and sun direction are almost perpendicular\n  float shadowStrength = pow( max( min(\n    dot(uLightDirection, vec3(0.0, 0.0, 1.0)),\n    dot(uLightDirection, normal)\n  ), 0.0), 1.5);\n  if (diffuse > 0.0 && shadowStrength > 0.0) {\n    // note: the diffuse term is also the cosine between the surface normal and the\n    // light direction\n    float bias = clamp(0.0007*tan(acos(diffuse)), 0.0, 0.01);\n    vec2 pos = fract( vSunRelPosition.xy * uShadowTexDimensions);\n    \n    vec2 tl = floor(vSunRelPosition.xy * uShadowTexDimensions) / uShadowTexDimensions;\n    float tlVal = isSeenBySun( tl,                           vSunRelPosition.z, bias);\n    float trVal = isSeenBySun( tl + vec2(1.0, 0.0) / uShadowTexDimensions, vSunRelPosition.z, bias);\n    float blVal = isSeenBySun( tl + vec2(0.0, 1.0) / uShadowTexDimensions, vSunRelPosition.z, bias);\n    float brVal = isSeenBySun( tl + vec2(1.0, 1.0) / uShadowTexDimensions, vSunRelPosition.z, bias);\n    float occludedBySun = mix( \n                            mix(tlVal, trVal, pos.x), \n                            mix(blVal, brVal, pos.x),\n                            pos.y);\n    diffuse *= 1.0 - (shadowStrength * (1.0 - occludedBySun));\n  }\n  vec3 color = vColor* texture2D( uWallTexIndex, vTexCoord.st).rgb +\n              (diffuse/1.5) * uLightColor;\n  float fogIntensity = (verticalDistanceToLowerEdge - uFogDistance) / uFogBlurDistance;\n  fogIntensity = clamp(fogIntensity, 0.0, 1.0);\n  //gl_FragColor = vec4( mix(color, uFogColor, fogIntensity), 1.0);\n  gl_FragColor = vec4( color, 1.0-fogIntensity);\n}\n"},o={vertex:"precision highp float;  //is default in vertex shaders anyway, using highp fixes #49\n#define halfPi 1.57079632679\nattribute vec4 aPosition;\nattribute vec2 aTexCoord;\nuniform mat4 uModelMatrix;\nuniform mat4 uViewMatrix;\nuniform mat4 uProjMatrix;\nuniform mat4 uMatrix;\nuniform vec2 uViewDirOnMap;\nuniform vec2 uLowerEdgePoint;\nvarying vec2 vTexCoord;\nvarying float verticalDistanceToLowerEdge;\nvoid main() {\n  gl_Position = uMatrix * aPosition;\n  vTexCoord = aTexCoord;\n  vec4 worldPos = uModelMatrix * aPosition;\n  vec2 dirFromLowerEdge = worldPos.xy / worldPos.w - uLowerEdgePoint;\n  verticalDistanceToLowerEdge = dot(dirFromLowerEdge, uViewDirOnMap);\n}\n",fragment:"#ifdef GL_ES\n  precision mediump float;\n#endif\nuniform sampler2D uTexIndex;\nuniform vec3 uFogColor;\nvarying vec2 vTexCoord;\nvarying float verticalDistanceToLowerEdge;\nuniform float uFogDistance;\nuniform float uFogBlurDistance;\nvoid main() {\n  float fogIntensity = (verticalDistanceToLowerEdge - uFogDistance) / uFogBlurDistance;\n  fogIntensity = clamp(fogIntensity, 0.0, 1.0);\n  gl_FragColor = vec4(texture2D(uTexIndex, vec2(vTexCoord.x, 1.0-vTexCoord.y)).rgb, 1.0-fogIntensity);\n}\n"},s={vertex:"precision highp float;  //is default in vertex shaders anyway, using highp fixes #49\nattribute vec4 aPosition;\nattribute vec2 aTexCoord;\nuniform mat4 uMatrix;\nvarying vec2 vTexCoord;\nvoid main() {\n  gl_Position = uMatrix * aPosition;\n  vTexCoord = aTexCoord;\n}\n",fragment:"#ifdef GL_ES\n  precision mediump float;\n#endif\nuniform sampler2D uTexIndex;\nvarying vec2 vTexCoord;\nvoid main() {\n  gl_FragColor = vec4(texture2D(uTexIndex, vTexCoord.st).rgb, 1.0);\n}\n"},u={vertex:"precision highp float;  //is default in vertex shaders anyway, using highp fixes #49\nattribute vec4 aPosition;\nattribute vec4 aFilter;\nattribute vec3 aNormal;\nuniform mat4 uMatrix;\nuniform mat4 uModelMatrix;\nuniform mat3 uNormalMatrix;\nuniform vec2 uViewDirOnMap;\nuniform vec2 uLowerEdgePoint;\nvarying float verticalDistanceToLowerEdge;\nvarying vec3 vNormal;\nuniform float uTime;\nvoid main() {\n  float t = clamp((uTime-aFilter.r) / (aFilter.g-aFilter.r), 0.0, 1.0);\n  float f = aFilter.b + (aFilter.a-aFilter.b) * t;\n  if (f == 0.0) {\n    gl_Position = vec4(0.0, 0.0, 0.0, 0.0);\n    verticalDistanceToLowerEdge = 0.0;\n  } else {\n    vec4 pos = vec4(aPosition.x, aPosition.y, aPosition.z*f, aPosition.w);\n    gl_Position = uMatrix * pos;\n    vNormal = uNormalMatrix * aNormal;\n    vec4 worldPos = uModelMatrix * pos;\n    vec2 dirFromLowerEdge = worldPos.xy / worldPos.w - uLowerEdgePoint;\n    verticalDistanceToLowerEdge = dot(dirFromLowerEdge, uViewDirOnMap);\n  }\n}\n",fragment:"\n#ifdef GL_ES\n  precision mediump float;\n#endif\nuniform float uFogDistance;\nuniform float uFogBlurDistance;\nvarying float verticalDistanceToLowerEdge;\nvarying vec3 vNormal;\nvoid main() {\n  float fogIntensity = (verticalDistanceToLowerEdge - uFogDistance) / uFogBlurDistance;\n  gl_FragColor = vec4(normalize(vNormal) / 2.0 + 0.5, clamp(fogIntensity, 0.0, 1.0));\n}\n"},f={vertex:"precision highp float;  //is default in vertex shaders anyway, using highp fixes #49\nattribute vec4 aPosition;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\nvoid main() {\n  gl_Position = aPosition;\n  vTexCoord = aTexCoord;\n}\n",fragment:"#ifdef GL_FRAGMENT_PRECISION_HIGH\n  // we need high precision for the depth values\n  precision highp float;\n#else\n  precision mediump float;\n#endif\nuniform sampler2D uDepthTexIndex;\nuniform sampler2D uFogTexIndex;\nuniform vec2 uInverseTexSize;   //in 1/pixels, e.g. 1/512 if the texture is 512px wide\nuniform float uEffectStrength;\nuniform float uNearPlane;\nuniform float uFarPlane;\nvarying vec2 vTexCoord;\n/* Retrieves the depth value 'offset' pixels away from 'pos' from texture 'uDepthTexIndex'. */\nfloat getDepth(vec2 pos, ivec2 offset)\n{\n  float z = texture2D(uDepthTexIndex, pos + float(offset) * uInverseTexSize).x;\n  return (2.0 * uNearPlane) / (uFarPlane + uNearPlane - z * (uFarPlane - uNearPlane)); // linearize depth\n}\n/* getOcclusionFactor() determines a heuristic factor (from [0..1]) for how \n * much the fragment at 'pos' with depth 'depthHere'is occluded by the \n * fragment that is (dx, dy) texels away from it.\n */\nfloat getOcclusionFactor(float depthHere, vec2 pos, ivec2 offset)\n{\n    float depthThere = getDepth(pos, offset);\n    /* if the fragment at (dx, dy) has no depth (i.e. there was nothing rendered there), \n     * then 'here' is not occluded (result 1.0) */\n    if (depthThere == 0.0)\n      return 1.0;\n    /* if the fragment at (dx, dy) is further away from the viewer than 'here', then\n     * 'here is not occluded' */\n    if (depthHere < depthThere )\n      return 1.0;\n      \n    float relDepthDiff = depthThere / depthHere;\n    float depthDiff = abs(depthThere - depthHere) * uFarPlane;\n    /* if the fragment at (dx, dy) is closer to the viewer than 'here', then it occludes\n     * 'here'. The occlusion is the higher the bigger the depth difference between the two\n     * locations is.\n     * However, if the depth difference is too high, we assume that 'there' lies in a\n     * completely different depth region of the scene than 'here' and thus cannot occlude\n     * 'here'. This last assumption gets rid of very dark artifacts around tall buildings.\n     */\n    return depthDiff < 50.0 ? mix(0.99, 1.0, 1.0 - clamp(depthDiff, 0.0, 1.0)) : 1.0;\n}\n/* This shader approximates the ambient occlusion in screen space (SSAO). \n * It is based on the assumption that a pixel will be occluded by neighboring \n * pixels iff. those have a depth value closer to the camera than the original\n * pixel itself (the function getOcclusionFactor() computes this occlusion \n * by a single other pixel).\n *\n * A naive approach would sample all pixels within a given distance. For an\n * interesting-looking effect, the sampling area needs to be at least 9 pixels \n * wide (-/+ 4), requiring 81 texture lookups per pixel for ambient occlusion.\n * This overburdens many GPUs.\n * To make the ambient occlusion computation faster, we do not consider all \n * texels in the sampling area, but only 16. This causes some sampling artifacts\n * that are later removed by blurring the ambient occlusion texture (this is \n * done in a separate shader).\n */\nvoid main() {\n  float depthHere = getDepth(vTexCoord, ivec2(0, 0));\n  float fogIntensity = texture2D(uFogTexIndex, vTexCoord).w;\n  if (depthHere == 0.0)\n  {\n\t//there was nothing rendered 'here' --\x3e it can't be occluded\n    gl_FragColor = vec4(1.0);\n    return;\n  }\n  float occlusionFactor = 1.0;\n  \n  occlusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2(-1,  0));\n  occlusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2(+1,  0));\n  occlusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2( 0, -1));\n  occlusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2( 0, +1));\n  occlusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2(-2, -2));\n  occlusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2(+2, +2));\n  occlusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2(+2, -2));\n  occlusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2(-2, +2));\n  occlusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2(-4,  0));\n  occlusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2(+4,  0));\n  occlusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2( 0, -4));\n  occlusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2( 0, +4));\n  occlusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2(-4, -4));\n  occlusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2(+4, +4));\n  occlusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2(+4, -4));\n  occlusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2(-4, +4));\n  occlusionFactor = pow(occlusionFactor, 4.0) + 55.0/255.0; // empirical bias determined to let SSAO have no effect on the map plane\n  occlusionFactor = 1.0 - ((1.0 - occlusionFactor) * uEffectStrength * (1.0-fogIntensity));\n  gl_FragColor = vec4(vec3(occlusionFactor), 1.0);\n}\n"},l={vertex:"precision highp float;  //is default in vertex shaders anyway, using highp fixes #49\nattribute vec4 aPosition;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\nvoid main() {\n  gl_Position = aPosition;\n  vTexCoord = aTexCoord;\n}\n",fragment:"#ifdef GL_ES\n  precision mediump float;\n#endif\nuniform sampler2D uTexIndex;\nuniform vec2 uInverseTexSize;   //in 1/pixels, e.g. 1/512 if the texture is 512px wide\nvarying vec2 vTexCoord;\n/* Retrieves the texel color 'offset' pixels away from 'pos' from texture 'uTexIndex'. */\nvec4 getTexel(vec2 pos, vec2 offset)\n{\n  return texture2D(uTexIndex, pos + offset * uInverseTexSize);\n}\nvoid main() {\n  vec4 center = texture2D(uTexIndex, vTexCoord);\n  vec4 nonDiagonalNeighbors = getTexel(vTexCoord, vec2(-1.0,  0.0)) +\n                              getTexel(vTexCoord, vec2(+1.0,  0.0)) +\n                              getTexel(vTexCoord, vec2( 0.0, -1.0)) +\n                              getTexel(vTexCoord, vec2( 0.0, +1.0));\n  vec4 diagonalNeighbors =    getTexel(vTexCoord, vec2(-1.0, -1.0)) +\n                              getTexel(vTexCoord, vec2(+1.0, +1.0)) +\n                              getTexel(vTexCoord, vec2(-1.0, +1.0)) +\n                              getTexel(vTexCoord, vec2(+1.0, -1.0));\n  \n  //approximate Gaussian blur (mean 0.0, stdev 1.0)\n  gl_FragColor = 0.2/1.0 * center + \n                 0.5/4.0 * nonDiagonalNeighbors + \n                 0.3/4.0 * diagonalNeighbors;\n}\n"},h={vertex:"precision highp float;  //is default in vertex shaders anyway, using highp fixes #49\nattribute vec3 aPosition;\nattribute vec3 aNormal;\nuniform mat4 uModelMatrix;\nuniform mat4 uMatrix;\nuniform mat4 uSunMatrix;\nuniform vec2 uViewDirOnMap;\nuniform vec2 uLowerEdgePoint;\n//varying vec2 vTexCoord;\nvarying vec3 vSunRelPosition;\nvarying vec3 vNormal;\nvarying float verticalDistanceToLowerEdge;\nvoid main() {\n  vec4 pos = vec4(aPosition.xyz, 1.0);\n  gl_Position = uMatrix * pos;\n  vec4 sunRelPosition = uSunMatrix * pos;\n  vSunRelPosition = (sunRelPosition.xyz / sunRelPosition.w + 1.0) / 2.0;\n  vNormal = aNormal;\n  vec4 worldPos = uModelMatrix * pos;\n  vec2 dirFromLowerEdge = worldPos.xy / worldPos.w - uLowerEdgePoint;\n  verticalDistanceToLowerEdge = dot(dirFromLowerEdge, uViewDirOnMap);\n}\n",fragment:"\n#ifdef GL_FRAGMENT_PRECISION_HIGH\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n/* This shader computes the diffuse brightness of the map layer. It does *not* \n * render the map texture itself, but is instead intended to be blended on top\n * of an already rendered map.\n * Note: this shader is not (and does not attempt to) be physically correct.\n *       It is intented to be a blend between a useful illustration of cast\n *       shadows and a mitigation of shadow casting artifacts occuring at\n *       low angles on incidence.\n *       Map brightness is only affected by shadows, not by light direction.\n *       Shadows are darkest when light comes from straight above (and thus\n *       shadows can be computed reliably) and become less and less visible\n *       with the light source close to the horizont (where moirC) and offset\n *       artifacts would otherwise be visible).\n */\n//uniform sampler2D uTexIndex;\nuniform sampler2D uShadowTexIndex;\nuniform vec3 uFogColor;\nuniform vec3 uDirToSun;\nuniform vec2 uShadowTexDimensions;\nuniform float uShadowStrength;\nvarying vec2 vTexCoord;\nvarying vec3 vSunRelPosition;\nvarying vec3 vNormal;\nvarying float verticalDistanceToLowerEdge;\nuniform float uFogDistance;\nuniform float uFogBlurDistance;\nfloat isSeenBySun( const vec2 sunViewNDC, const float depth, const float bias) {\n  if ( clamp( sunViewNDC, 0.0, 1.0) != sunViewNDC)  //not inside sun's viewport\n    return 1.0;\n  \n  float depthFromTexture = texture2D( uShadowTexIndex, sunViewNDC.xy).x;\n  \n  //compare depth values not in reciprocal but in linear depth\n  return step(1.0/depthFromTexture, 1.0/depth + bias);\n}\nvoid main() {\n  //vec2 tl = floor(vSunRelPosition.xy * uShadowTexDimensions) / uShadowTexDimensions;\n  //gl_FragColor = vec4(vec3(texture2D( uShadowTexIndex, tl).x), 1.0);\n  //return;\n  float diffuse = dot(uDirToSun, normalize(vNormal));\n  diffuse = max(diffuse, 0.0);\n  \n  float shadowStrength = uShadowStrength * pow(diffuse, 1.5);\n  if (diffuse > 0.0) {\n    // note: the diffuse term is also the cosine between the surface normal and the\n    // light direction\n    float bias = clamp(0.0007*tan(acos(diffuse)), 0.0, 0.01);\n    \n    vec2 pos = fract( vSunRelPosition.xy * uShadowTexDimensions);\n    \n    vec2 tl = floor(vSunRelPosition.xy * uShadowTexDimensions) / uShadowTexDimensions;\n    float tlVal = isSeenBySun( tl,                           vSunRelPosition.z, bias);\n    float trVal = isSeenBySun( tl + vec2(1.0, 0.0) / uShadowTexDimensions, vSunRelPosition.z, bias);\n    float blVal = isSeenBySun( tl + vec2(0.0, 1.0) / uShadowTexDimensions, vSunRelPosition.z, bias);\n    float brVal = isSeenBySun( tl + vec2(1.0, 1.0) / uShadowTexDimensions, vSunRelPosition.z, bias);\n    diffuse = mix( mix(tlVal, trVal, pos.x), \n                   mix(blVal, brVal, pos.x),\n                   pos.y);\n  }\n  diffuse = mix(1.0, diffuse, shadowStrength);\n  \n  float fogIntensity = (verticalDistanceToLowerEdge - uFogDistance) / uFogBlurDistance;\n  fogIntensity = clamp(fogIntensity, 0.0, 1.0);\n  float darkness = (1.0 - diffuse);\n  darkness *=  (1.0 - fogIntensity);\n  gl_FragColor = vec4(vec3(1.0 - darkness), 1.0);\n}\n"},d={vertex:"precision highp float;  //is default in vertex shaders anyway, using highp fixes #49\nattribute vec4 aPosition;\nattribute vec2 aTexCoord;\nuniform mat4 uMatrix;\nvarying vec2 vTexCoord;\nvoid main() {\n  gl_Position = uMatrix * aPosition;\n  vTexCoord = aTexCoord;\n}\n",fragment:"#ifdef GL_FRAGMENT_PRECISION_HIGH\n  // we need high precision for the depth values\n  precision highp float;\n#else\n  precision mediump float;\n#endif\nuniform sampler2D uDepthTexIndex;\nuniform sampler2D uFogNormalTexIndex;\nuniform sampler2D uIdTexIndex;\nuniform vec2 uInverseTexSize;   //in 1/pixels, e.g. 1/512 if the texture is 512px wide\nuniform float uEffectStrength;\nuniform float uNearPlane;\nuniform float uFarPlane;\nvarying vec2 vTexCoord;\n/* Retrieves the depth value 'offset' pixels away from 'pos' from texture 'uDepthTexIndex'. */\nfloat getDepth(vec2 pos, vec2 offset)\n{\n  float z = texture2D(uDepthTexIndex, pos + offset * uInverseTexSize).x;\n  return (2.0 * uNearPlane) / (uFarPlane + uNearPlane - z * (uFarPlane - uNearPlane)); // linearize depth\n}\nvec3 getNormal(vec2 pos, vec2 offset)\n{\n  return normalize(texture2D(uFogNormalTexIndex, pos + offset * uInverseTexSize).xyz * 2.0 - 1.0);\n}\nvec3 getEncodedId(vec2 pos, vec2 offset)\n{\n  return texture2D(uIdTexIndex, pos + offset * uInverseTexSize).xyz;\n}\nvoid main() {\n  float fogIntensity = texture2D(uFogNormalTexIndex, vTexCoord).w;\n  vec3 normalHere =  getNormal(vTexCoord, vec2(0, 0));\n  vec3 normalRight = getNormal(vTexCoord, vec2(1, 0));\n  vec3 normalAbove = getNormal(vTexCoord, vec2(0,-1));\n  \n  float edgeStrengthFromNormal = \n    step( dot(normalHere, normalRight), 0.9) +\n    step( dot(normalHere, normalAbove), 0.9);\n  float depthHere =  getDepth(vTexCoord, vec2(0,  0));\n  float depthRight = getDepth(vTexCoord, vec2(1,  0));\n  float depthAbove = getDepth(vTexCoord, vec2(0, -1));\n  float depthDiffRight = abs(depthHere - depthRight) * 7500.0;\n  float depthDiffAbove = abs(depthHere - depthAbove) * 7500.0;\n  float edgeStrengthFromDepth = step(10.0, depthDiffRight) + \n                                step(10.0, depthDiffAbove);\n  \n  vec3 idHere = getEncodedId(vTexCoord, vec2(0,0));\n  vec3 idRight = getEncodedId(vTexCoord, vec2(1,0));\n  vec3 idAbove = getEncodedId(vTexCoord, vec2(0,-1));\n  float edgeStrengthFromId = (idHere != idRight || idHere != idAbove) ? 1.0 : 0.0;\n  \n  float edgeStrength = max( edgeStrengthFromId, max( edgeStrengthFromNormal, edgeStrengthFromDepth));\n  float occlusionFactor = 1.0 - (edgeStrength * uEffectStrength);\n  occlusionFactor = 1.0 - ((1.0- occlusionFactor) * (1.0-fogIntensity));\n  gl_FragColor = vec4(vec3(occlusionFactor), 1.0);\n}\n"},c=function(){var e={getContext:function(e){var t={antialias:!y.options.fastMode,depth:!0,premultipliedAlpha:!1};try{M=e.getContext("webgl",t)}catch(e){}if(!M)try{M=e.getContext("experimental-webgl",t)}catch(e){}if(!M)throw new Error("WebGL not supported");return e.addEventListener("webglcontextlost",function(e){console.warn("context lost")}),e.addEventListener("webglcontextrestored",function(e){console.warn("context restored")}),M.viewport(0,0,y.width,y.height),M.cullFace(M.BACK),M.enable(M.CULL_FACE),M.enable(M.DEPTH_TEST),M.clearColor(.5,.5,.5,1),y.options.fastMode||(M.anisotropyExtension=M.getExtension("EXT_texture_filter_anisotropic"),M.anisotropyExtension&&(M.anisotropyExtension.maxAnisotropyLevel=M.getParameter(M.anisotropyExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),M.depthTextureExtension=M.getExtension("WEBGL_depth_texture")),M},start:function(e){return setInterval(function(){requestAnimationFrame(e)},17)},stop:function(e){clearInterval(e)},destroy:function(){void 0!==M&&(M.canvas.parentNode.removeChild(M.canvas),M=void 0)},util:{}};return e.util.nextPowerOf2=function(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e},e.util.calcNormal=function(e,t,i,r,n,o,a,s,u){var f=e-r,l=t-n,h=i-o,d=r-a,c=n-s,m=o-u,v=l*m-h*c,x=h*d-f*m,g=f*c-l*d;return this.calcUnit(v,x,g)},e.util.calcUnit=function(e,t,i){var r=Math.sqrt(e*e+t*t+i*i);return 0===r&&(r=1e-5),[e/r,t/r,i/r]},e.Buffer=class{constructor(e,t){this.id=M.createBuffer(),this.itemSize=e,this.numItems=t.length/e,M.bindBuffer(M.ARRAY_BUFFER,this.id),M.bufferData(M.ARRAY_BUFFER,t,M.STATIC_DRAW),t=null}enable(){M.bindBuffer(M.ARRAY_BUFFER,this.id)}use(){M.bindBuffer(M.ARRAY_BUFFER,this.id)}destroy(){M.deleteBuffer(this.id),this.id=null}},e.Framebuffer=function(e,t,i){if(i&&!M.depthTextureExtension)throw"Depth textures are not supported by your GPU";this.useDepthTexture=!!i,this.setSize(e,t)},e.Framebuffer.prototype={setSize:function(t,i){if(this.frameBuffer){if(t===this.width&&i===this.height)return}else this.frameBuffer=M.createFramebuffer();if(M.bindFramebuffer(M.FRAMEBUFFER,this.frameBuffer),this.width=t,this.height=i,this.depthRenderBuffer&&(M.deleteRenderbuffer(this.depthRenderBuffer),this.depthRenderBuffer=null),this.depthTexture&&(this.depthTexture.destroy(),this.depthTexture=null),this.useDepthTexture?(this.depthTexture=new e.texture.Image,this.depthTexture.enable(0),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_MIN_FILTER,M.NEAREST),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_MAG_FILTER,M.NEAREST),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_WRAP_S,M.CLAMP_TO_EDGE),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_WRAP_T,M.CLAMP_TO_EDGE),M.texImage2D(M.TEXTURE_2D,0,M.DEPTH_STENCIL,t,i,0,M.DEPTH_STENCIL,M.depthTextureExtension.UNSIGNED_INT_24_8_WEBGL,null),M.framebufferTexture2D(M.FRAMEBUFFER,M.DEPTH_STENCIL_ATTACHMENT,M.TEXTURE_2D,this.depthTexture.id,0)):(this.depthRenderBuffer=M.createRenderbuffer(),M.bindRenderbuffer(M.RENDERBUFFER,this.depthRenderBuffer),M.renderbufferStorage(M.RENDERBUFFER,M.DEPTH_COMPONENT16,t,i),M.framebufferRenderbuffer(M.FRAMEBUFFER,M.DEPTH_ATTACHMENT,M.RENDERBUFFER,this.depthRenderBuffer)),this.renderTexture&&this.renderTexture.destroy(),this.renderTexture=new e.texture.Data(t,i),M.bindTexture(M.TEXTURE_2D,this.renderTexture.id),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_WRAP_S,M.CLAMP_TO_EDGE),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_WRAP_T,M.CLAMP_TO_EDGE),M.framebufferTexture2D(M.FRAMEBUFFER,M.COLOR_ATTACHMENT0,M.TEXTURE_2D,this.renderTexture.id,0),M.checkFramebufferStatus(M.FRAMEBUFFER)!==M.FRAMEBUFFER_COMPLETE)throw new Error("This combination of framebuffer attachments does not work");M.bindRenderbuffer(M.RENDERBUFFER,null),M.bindFramebuffer(M.FRAMEBUFFER,null)},enable:function(){M.bindFramebuffer(M.FRAMEBUFFER,this.frameBuffer),this.useDepthTexture||M.bindRenderbuffer(M.RENDERBUFFER,this.depthRenderBuffer)},disable:function(){M.bindFramebuffer(M.FRAMEBUFFER,null),this.useDepthTexture||M.bindRenderbuffer(M.RENDERBUFFER,null)},getPixel:function(e,t){var i=new Uint8Array(4);if(!(e<0||t<0||e>=this.width||t>=this.height))return M.readPixels(e,t,1,1,M.RGBA,M.UNSIGNED_BYTE,i),i},getData:function(){var e=new Uint8Array(this.width*this.height*4);return M.readPixels(0,0,this.width,this.height,M.RGBA,M.UNSIGNED_BYTE,e),e},destroy:function(){this.renderTexture&&this.renderTexture.destroy(),this.depthTexture&&this.depthTexture.destroy()}},e.Shader=function(e){var t;if(this.shaderName=e.shaderName,this.id=M.createProgram(),this.attach(M.VERTEX_SHADER,e.vertexShader),this.attach(M.FRAGMENT_SHADER,e.fragmentShader),M.linkProgram(this.id),!M.getProgramParameter(this.id,M.LINK_STATUS))throw new Error(M.getProgramParameter(this.id,M.VALIDATE_STATUS)+"\n"+M.getError());for(this.attributeNames=e.attributes||[],this.uniformNames=e.uniforms||[],M.useProgram(this.id),this.attributes={},t=0;t<this.attributeNames.length;t++)this.locateAttribute(this.attributeNames[t]);for(this.uniforms={},t=0;t<this.uniformNames.length;t++)this.locateUniform(this.uniformNames[t])},e.Shader.warned={},e.Shader.prototype={locateAttribute:function(e){var t=M.getAttribLocation(this.id,e);t<0?console.warn('unable to locate attribute "%s" in shader "%s"',e,this.shaderName):this.attributes[e]=t},locateUniform:function(e){var t=M.getUniformLocation(this.id,e);t?this.uniforms[e]=t:console.warn('unable to locate uniform "%s" in shader "%s"',e,this.shaderName)},attach:function(e,t){var i=M.createShader(e);if(M.shaderSource(i,t),M.compileShader(i),!M.getShaderParameter(i,M.COMPILE_STATUS))throw new Error(M.getShaderInfoLog(i));M.attachShader(this.id,i)},enable:function(){for(var e in M.useProgram(this.id),this.attributes)M.enableVertexAttribArray(this.attributes[e]);return this},disable:function(){if(this.attributes)for(var e in this.attributes)M.disableVertexAttribArray(this.attributes[e])},bindBuffer:function(t,i){if(void 0!==this.attributes[i])t.enable(),M.vertexAttribPointer(this.attributes[i],t.itemSize,M.FLOAT,!1,0,0);else{var r=this.shaderName+":"+i;e.Shader.warned[r]||(console.warn('attempt to bind VBO to invalid attribute "%s" in shader "%s"',i,this.shaderName),e.Shader.warned[r]=!0)}},setUniform:function(t,i,r){if(void 0!==this.uniforms[t])M["uniform"+i](this.uniforms[t],r);else{var n=this.shaderName+":"+t;e.Shader.warned[n]||(console.warn('attempt to bind to invalid uniform "%s" in shader "%s"',t,this.shaderName),e.Shader.warned[n]=!0)}},setUniforms:function(e){for(var t in e)this.setUniform(e[t][0],e[t][1],e[t][2])},setUniformMatrix:function(t,i,r){if(void 0!==this.uniforms[t])M["uniformMatrix"+i](this.uniforms[t],!1,r);else{var n=this.shaderName+":"+t;e.Shader.warned[n]||(console.warn('attempt to bind to invalid uniform "%s" in shader "%s"',t,this.shaderName),e.Shader.warned[n]=!0)}},setUniformMatrices:function(e){for(var t in e)this.setUniformMatrix(e[t][0],e[t][1],e[t][2])},bindTexture:function(e,t,i){i.enable(t),this.setUniform(e,"1i",t)},destroy:function(){this.disable(),this.id=null}},e.Matrix=function(e){this.data=new Float32Array(e||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},e.Matrix.identity=function(){return new e.Matrix([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},e.Matrix.identity3=function(){return new e.Matrix([1,0,0,0,1,0,0,0,1])},function(){function t(e){return e*Math.PI/180}function i(e,t,i){var r=t[0],n=t[1],o=t[2],a=t[3],s=t[4],u=t[5],f=t[6],l=t[7],h=t[8],d=t[9],c=t[10],m=t[11],v=t[12],x=t[13],g=t[14],p=t[15],T=i[0],b=i[1],w=i[2],y=i[3],M=i[4],E=i[5],F=i[6],B=i[7],S=i[8],D=i[9],P=i[10],I=i[11],C=i[12],R=i[13],A=i[14],_=i[15];e[0]=r*T+n*M+o*S+a*C,e[1]=r*b+n*E+o*D+a*R,e[2]=r*w+n*F+o*P+a*A,e[3]=r*y+n*B+o*I+a*_,e[4]=s*T+u*M+f*S+l*C,e[5]=s*b+u*E+f*D+l*R,e[6]=s*w+u*F+f*P+l*A,e[7]=s*y+u*B+f*I+l*_,e[8]=h*T+d*M+c*S+m*C,e[9]=h*b+d*E+c*D+m*R,e[10]=h*w+d*F+c*P+m*A,e[11]=h*y+d*B+c*I+m*_,e[12]=v*T+x*M+g*S+p*C,e[13]=v*b+x*E+g*D+p*R,e[14]=v*w+x*F+g*P+p*A,e[15]=v*y+x*B+g*I+p*_}e.Matrix.prototype={multiply:function(e){return i(this.data,this.data,e.data),this},translate:function(e,t,r){return i(this.data,this.data,[1,0,0,0,0,1,0,0,0,0,1,0,e,t,r,1]),this},rotateX:function(e){var r=t(e),n=Math.cos(r),o=Math.sin(r);return i(this.data,this.data,[1,0,0,0,0,n,o,0,0,-o,n,0,0,0,0,1]),this},rotateY:function(e){var r=t(e),n=Math.cos(r),o=Math.sin(r);return i(this.data,this.data,[n,0,-o,0,0,1,0,0,o,0,n,0,0,0,0,1]),this},rotateZ:function(e){var r=t(e),n=Math.cos(r),o=Math.sin(r);return i(this.data,this.data,[n,-o,0,0,o,n,0,0,0,0,1,0,0,0,0,1]),this},scale:function(e,t,r){return i(this.data,this.data,[e,0,0,0,0,t,0,0,0,0,r,0,0,0,0,1]),this}},e.Matrix.multiply=function(e,t){var r=new Float32Array(16);return i(r,e.data,t.data),r},e.Matrix.Perspective=function(t,i,r,n){var o=1/Math.tan(t*(Math.PI/180)/2),a=1/(r-n);return new e.Matrix([o/i,0,0,0,0,o,0,0,0,0,(n+r)*a,-1,0,0,2*n*r*a,0])},e.Matrix.Frustum=function(t,i,r,n,o,a){var s=1/(i-t),u=1/(r-n),f=1/(o-a);return new e.Matrix([2*o*s,0,0,0,0,2*o*u,0,0,(i+t)*s,(r+n)*u,(a+o)*f,-1,0,0,a*o*2*f,0])},e.Matrix.OffCenterProjection=function(t,i,r,n,o,a){var s=Ee(be(r,t)),u=Ee(be(i,t)),f=re(t,i,r),l=be(t,n),h=be(i,n),d=be(r,n),c=-Te(l,f),m=Te(s,l)*o/c,v=Te(s,d)*o/c,x=Te(u,l)*o/c,g=Te(u,h)*o/c;return e.Matrix.Frustum(m,v,g,x,o,a)},e.Matrix.Ortho=function(t,i,r,n,o,a){return new e.Matrix([2/(i-t),0,0,0,0,2/(r-n),0,0,0,0,-2/(a-o),0,-(i+t)/(i-t),-(r+n)/(r-n),-(a+o)/(a-o),1])},e.Matrix.invert3=function(e){var t=e[0],i=e[1],r=e[2],n=e[4],o=e[5],a=e[6],s=e[8],u=e[9],f=e[10],l=f*o-a*u,h=-f*n+a*s,d=u*n-o*s,c=t*l+i*h+r*d;return c?[l*(c=1/c),(-f*i+r*u)*c,(a*i-r*o)*c,h*c,(f*t-r*s)*c,(-a*t+r*n)*c,d*c,(-u*t+i*s)*c,(o*t-i*n)*c]:null},e.Matrix.transpose3=function(e){return new Float32Array([e[0],e[3],e[6],e[1],e[4],e[7],e[2],e[5],e[8]])},e.Matrix.transpose=function(e){return new Float32Array([e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]])},e.Matrix.transform=function(e){var t=e[12],i=e[13],r=e[14],n=e[15];return{x:(t/n+1)/2,y:(i/n+1)/2,z:(r/n+1)/2}},e.Matrix.invert=function(e){var t=new Float32Array(16),i=e[0],r=e[1],n=e[2],o=e[3],a=e[4],s=e[5],u=e[6],f=e[7],l=e[8],h=e[9],d=e[10],c=e[11],m=e[12],v=e[13],x=e[14],g=e[15],p=i*s-r*a,T=i*u-n*a,b=i*f-o*a,w=r*u-n*s,y=r*f-o*s,M=n*f-o*u,E=l*v-h*m,F=l*x-d*m,B=l*g-c*m,S=h*x-d*v,D=h*g-c*v,P=d*g-c*x,I=p*P-T*D+b*S+w*B-y*F+M*E;if(I)return I=1/I,t[0]=(s*P-u*D+f*S)*I,t[1]=(n*D-r*P-o*S)*I,t[2]=(v*M-x*y+g*w)*I,t[3]=(d*y-h*M-c*w)*I,t[4]=(u*B-a*P-f*F)*I,t[5]=(i*P-n*B+o*F)*I,t[6]=(x*b-m*M-g*T)*I,t[7]=(l*M-d*b+c*T)*I,t[8]=(a*D-s*B+f*E)*I,t[9]=(r*B-i*D-o*E)*I,t[10]=(m*y-v*b+g*p)*I,t[11]=(h*b-l*y-c*p)*I,t[12]=(s*F-a*S-u*E)*I,t[13]=(i*S-r*F+n*E)*I,t[14]=(v*T-m*w-x*p)*I,t[15]=(l*w-h*T+d*p)*I,t}}(),e.texture={},e.texture.Image=function(){this.id=M.createTexture(),M.bindTexture(M.TEXTURE_2D,this.id),M.bindTexture(M.TEXTURE_2D,null)},e.texture.Image.prototype={clamp:function(e,t){if(e.width<=t&&e.height<=t)return e;var i=t,r=t,n=e.width/e.height;n<1?i=Math.round(r*n):r=Math.round(i/n);var o=k.createElement("CANVAS");return o.width=i,o.height=r,o.getContext("2d").drawImage(e,0,0,o.width,o.height),o},load:function(e,t){var i=new Image;return i.crossOrigin="*",i.onload=function(){this.set(i),t&&t(i)}.bind(this),i.onerror=function(){t&&t()},i.src=e,this},color:function(e){return M.bindTexture(M.TEXTURE_2D,this.id),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_MIN_FILTER,M.LINEAR),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_MAG_FILTER,M.LINEAR),M.texImage2D(M.TEXTURE_2D,0,M.RGBA,1,1,0,M.RGBA,M.UNSIGNED_BYTE,new Uint8Array([255*e[0],255*e[1],255*e[2],255*(void 0===e[3]?1:e[3])])),M.bindTexture(M.TEXTURE_2D,null),this},set:function(e){if(this.id)return e=this.clamp(e,M.getParameter(M.MAX_TEXTURE_SIZE)),M.bindTexture(M.TEXTURE_2D,this.id),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_MIN_FILTER,M.LINEAR_MIPMAP_NEAREST),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_MAG_FILTER,M.LINEAR),M.texImage2D(M.TEXTURE_2D,0,M.RGBA,M.RGBA,M.UNSIGNED_BYTE,e),M.generateMipmap(M.TEXTURE_2D),M.anisotropyExtension&&M.texParameterf(M.TEXTURE_2D,M.anisotropyExtension.TEXTURE_MAX_ANISOTROPY_EXT,M.anisotropyExtension.maxAnisotropyLevel),M.bindTexture(M.TEXTURE_2D,null),this},enable:function(e){if(this.id)return M.activeTexture(M.TEXTURE0+(e||0)),M.bindTexture(M.TEXTURE_2D,this.id),this},destroy:function(){M.bindTexture(M.TEXTURE_2D,null),M.deleteTexture(this.id),this.id=null}},e.texture.Data=function(e,t,i,r){this.id=M.createTexture(),M.bindTexture(M.TEXTURE_2D,this.id),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_MIN_FILTER,M.NEAREST),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_MAG_FILTER,M.NEAREST);var n=null;if(i){var o=e*t*4;(n=new Uint8Array(o)).set(i.subarray(0,o))}M.texImage2D(M.TEXTURE_2D,0,M.RGBA,e,t,0,M.RGBA,M.UNSIGNED_BYTE,n),M.bindTexture(M.TEXTURE_2D,null)},e.texture.Data.prototype={enable:function(e){return M.activeTexture(M.TEXTURE0+(e||0)),M.bindTexture(M.TEXTURE_2D,this.id),this},destroy:function(){M.bindTexture(M.TEXTURE_2D,null),M.deleteTexture(this.id),this.id=null}},e}();var m,v=function(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1])},x=function(e,t){return[e[0]-t[0],e[1]-t[1]]},g={len:function(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])},sub:function(e,t){return[e[0]-t[0],e[1]-t[1],e[2]-t[2]]},unit:function(e){var t=this.len(e);return[e[0]/t,e[1]/t,e[2]/t]},normal:function(e,t,i){var r=this.sub(e,t),n=this.sub(t,i);return this.unit([r[1]*n[2]-r[2]*n[1],r[2]*n[0]-r[0]*n[2],r[0]*n[1]-r[1]*n[0]])}},p=function(){function e(e,n,o){o=o||2;var a,s,l,d,c,m,v,x=n&&n.length,g=x?n[0]*o:e.length,p=t(e,0,g,o,!0),T=[];if(!p)return T;if(x&&(p=function(e,r,n,o){var a,s,l,d,c,m=[];for(a=0,s=r.length;a<s;a++)l=r[a]*o,d=a<s-1?r[a+1]*o:e.length,(c=t(e,l,d,o,!1))===c.next&&(c.steiner=!0),m.push(h(c));for(m.sort(u),a=0;a<m.length;a++)f(m[a],n),n=i(n,n.next);return n}(e,n,p,o)),e.length>80*o){a=l=e[0],s=d=e[1];for(var b=o;b<g;b+=o)c=e[b],m=e[b+1],c<a&&(a=c),m<s&&(s=m),c>l&&(l=c),m>d&&(d=m);v=Math.max(l-a,d-s)}return r(p,T,o,a,s,v),T}function t(e,t,i,r,n){var o,a;if(n===y(e,t,i,r)>0)for(o=t;o<i;o+=r)a=T(o,e[o],e[o+1],a);else for(o=i-r;o>=t;o-=r)a=T(o,e[o],e[o+1],a);return a&&v(a,a.next)&&(b(a),a=a.next),a}function i(e,t){if(!e)return e;t||(t=e);var i,r=e;do{if(i=!1,r.steiner||!v(r,r.next)&&0!==m(r.prev,r,r.next))r=r.next;else{if(b(r),(r=t=r.prev)===r.next)return null;i=!0}}while(i||r!==t);return t}function r(e,t,u,f,h,d,c){if(e){!c&&d&&function(e,t,i,r){var n=e;do{null===n.z&&(n.z=l(n.x,n.y,t,i,r)),n.prevZ=n.prev,n.nextZ=n.next,n=n.next}while(n!==e);n.prevZ.nextZ=null,n.prevZ=null,function(e){var t,i,r,n,o,a,s,u,f=1;do{for(i=e,e=null,o=null,a=0;i;){for(a++,r=i,s=0,t=0;t<f&&(s++,r=r.nextZ);t++);for(u=f;s>0||u>0&&r;)0===s?(n=r,r=r.nextZ,u--):0!==u&&r?i.z<=r.z?(n=i,i=i.nextZ,s--):(n=r,r=r.nextZ,u--):(n=i,i=i.nextZ,s--),o?o.nextZ=n:e=n,n.prevZ=o,o=n;i=r}o.nextZ=null,f*=2}while(a>1)}(n)}(e,f,h,d);for(var m,v,x=e;e.prev!==e.next;)if(m=e.prev,v=e.next,d?o(e,f,h,d):n(e))t.push(m.i/u),t.push(e.i/u),t.push(v.i/u),b(e),e=v.next,x=v.next;else if((e=v)===x){c?1===c?r(e=a(e,t,u),t,u,f,h,d,2):2===c&&s(e,t,u,f,h,d):r(i(e),t,u,f,h,d,1);break}}}function n(e){var t=e.prev,i=e,r=e.next;if(m(t,i,r)>=0)return!1;for(var n=e.next.next;n!==e.prev;){if(d(t.x,t.y,i.x,i.y,r.x,r.y,n.x,n.y)&&m(n.prev,n,n.next)>=0)return!1;n=n.next}return!0}function o(e,t,i,r){var n=e.prev,o=e,a=e.next;if(m(n,o,a)>=0)return!1;for(var s=n.x<o.x?n.x<a.x?n.x:a.x:o.x<a.x?o.x:a.x,u=n.y<o.y?n.y<a.y?n.y:a.y:o.y<a.y?o.y:a.y,f=n.x>o.x?n.x>a.x?n.x:a.x:o.x>a.x?o.x:a.x,h=n.y>o.y?n.y>a.y?n.y:a.y:o.y>a.y?o.y:a.y,c=l(s,u,t,i,r),v=l(f,h,t,i,r),x=e.nextZ;x&&x.z<=v;){if(x!==e.prev&&x!==e.next&&d(n.x,n.y,o.x,o.y,a.x,a.y,x.x,x.y)&&m(x.prev,x,x.next)>=0)return!1;x=x.nextZ}for(x=e.prevZ;x&&x.z>=c;){if(x!==e.prev&&x!==e.next&&d(n.x,n.y,o.x,o.y,a.x,a.y,x.x,x.y)&&m(x.prev,x,x.next)>=0)return!1;x=x.prevZ}return!0}function a(e,t,i){var r=e;do{var n=r.prev,o=r.next.next;!v(n,o)&&x(n,r,r.next,o)&&g(n,o)&&g(o,n)&&(t.push(n.i/i),t.push(r.i/i),t.push(o.i/i),b(r),b(r.next),r=e=o),r=r.next}while(r!==e);return r}function s(e,t,n,o,a,s){var u=e;do{for(var f=u.next.next;f!==u.prev;){if(u.i!==f.i&&c(u,f)){var l=p(u,f);return u=i(u,u.next),l=i(l,l.next),r(u,t,n,o,a,s),void r(l,t,n,o,a,s)}f=f.next}u=u.next}while(u!==e)}function u(e,t){return e.x-t.x}function f(e,t){if(t=function(e,t){var i,r=t,n=e.x,o=e.y,a=-1/0;do{if(o<=r.y&&o>=r.next.y){var s=r.x+(o-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(s<=n&&s>a){if(a=s,s===n){if(o===r.y)return r;if(o===r.next.y)return r.next}i=r.x<r.next.x?r:r.next}}r=r.next}while(r!==t);if(!i)return null;if(n===a)return i.prev;var u,f=i,l=i.x,h=i.y,c=1/0;r=i.next;for(;r!==f;)n>=r.x&&r.x>=l&&d(o<h?n:a,o,l,h,o<h?a:n,o,r.x,r.y)&&((u=Math.abs(o-r.y)/(n-r.x))<c||u===c&&r.x>i.x)&&g(r,e)&&(i=r,c=u),r=r.next;return i}(e,t)){var r=p(t,e);i(r,r.next)}}function l(e,t,i,r,n){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-i)/n)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-r)/n)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function h(e){var t=e,i=e;do{t.x<i.x&&(i=t),t=t.next}while(t!==e);return i}function d(e,t,i,r,n,o,a,s){return(n-a)*(t-s)-(e-a)*(o-s)>=0&&(e-a)*(r-s)-(i-a)*(t-s)>=0&&(i-a)*(o-s)-(n-a)*(r-s)>=0}function c(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var i=e;do{if(i.i!==e.i&&i.next.i!==e.i&&i.i!==t.i&&i.next.i!==t.i&&x(i,i.next,e,t))return!0;i=i.next}while(i!==e);return!1}(e,t)&&g(e,t)&&g(t,e)&&function(e,t){var i=e,r=!1,n=(e.x+t.x)/2,o=(e.y+t.y)/2;do{i.y>o!=i.next.y>o&&n<(i.next.x-i.x)*(o-i.y)/(i.next.y-i.y)+i.x&&(r=!r),i=i.next}while(i!==e);return r}(e,t)}function m(e,t,i){return(t.y-e.y)*(i.x-t.x)-(t.x-e.x)*(i.y-t.y)}function v(e,t){return e.x===t.x&&e.y===t.y}function x(e,t,i,r){return!!(v(e,t)&&v(i,r)||v(e,r)&&v(i,t))||m(e,t,i)>0!=m(e,t,r)>0&&m(i,r,e)>0!=m(i,r,t)>0}function g(e,t){return m(e.prev,e,e.next)<0?m(e,t,e.next)>=0&&m(e,e.prev,t)>=0:m(e,t,e.prev)<0||m(e,e.next,t)<0}function p(e,t){var i=new w(e.i,e.x,e.y),r=new w(t.i,t.x,t.y),n=e.next,o=t.prev;return e.next=t,t.prev=e,i.next=n,n.prev=i,r.next=i,i.prev=r,o.next=r,r.prev=o,r}function T(e,t,i,r){var n=new w(e,t,i);return r?(n.next=r.next,n.prev=r,r.next.prev=n,r.next=n):(n.prev=n,n.next=n),n}function b(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function w(e,t,i){this.i=e,this.x=t,this.y=i,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function y(e,t,i,r){for(var n=0,o=t,a=i-r;o<i;o+=r)n+=(e[a]-e[o])*(e[o+1]+e[a+1]),a=o;return n}return e.deviation=function(e,t,i,r){var n,o,a=t&&t.length,s=a?t[0]*i:e.length,u=Math.abs(y(e,0,s,i));if(a)for(n=0,o=t.length;n<o;n++){var f=t[n]*i,l=n<o-1?t[n+1]*i:e.length;u-=Math.abs(y(e,f,l,i))}var h=0;for(n=0,o=r.length;n<o;n+=3){var d=r[n]*i,c=r[n+1]*i,m=r[n+2]*i;h+=Math.abs((e[d]-e[m])*(e[c+1]-e[d+1])-(e[d]-e[c])*(e[m+1]-e[d+1]))}return 0===u&&0===h?0:Math.abs((h-u)/u)},e.flatten=function(e){for(var t=e[0][0].length,i={vertices:[],holes:[],dimensions:t},r=0,n=0;n<e.length;n++){for(var o=0;o<e[n].length;o++)for(var a=0;a<t;a++)i.vertices.push(e[n][o][a]);n>0&&(r+=e[n-1].length,i.holes.push(r))}return i},e}();function T(e,t){return e[0]>=Math.min(t[0][0],t[1][0])&&e[0]<=Math.max(t[1][0],t[0][0])&&e[1]>=Math.min(t[0][1],t[1][1])&&e[1]<=Math.max(t[1][1],t[0][1])}function b(e,t,i){var r,n,o,a,s,u=i[0],f=[i[1][0]-i[0][0],i[1][1]-i[0][1]];if(0!==t[0]||0!==f[0]){if(0!==t[0]&&(o=t[1]/t[0],r=e[1]-o*e[0]),0!==f[0]&&(a=f[1]/f[0],n=u[1]-a*u[0]),0===t[0]&&T(s=[e[0],a*e[0]+n],i))return s;if(0===f[0]&&T(s=[u[0],o*u[0]+r],i))return s;if(o!==a){var l=(n-r)/(o-a);return T(s=[l,o*l+r],i)?s:void 0}}}function w(e,t){var i=t[0],r=t[1];if(i[0]!==r[0]||i[1]!==r[1]){var n=(r[1]-i[1])/(r[0]-i[0]),o=i[1]-n*i[0];if(0===n)return Math.abs(o-e[1]);if(n===1/0)return Math.abs(i[0]-e[0]);var a=-1/n,s=(e[1]-a*e[0]-o)/(n-a),u=n*s+o,f=e[0]-s,l=e[1]-u;return Math.sqrt(f*f+l*l)}}!function(){function e(e,i,r,n,o,a,s){if(0,r.length>1||void 0===i.roofDirection)return t(e,i,r,o,a);var u=(i.roofDirection/180-.5)*Math.PI,f=[Math.cos(u),Math.sin(u)],l=function(e,t,i){for(var r,n=[],o=0;o<i.length-1;o++)if(void 0!==(r=b(e,t,[i[o],i[o+1]]))){if(2===n.length)return;o++,i.splice(o,0,r),n.push(o)}if(!(n.length<2))return{index:n,roof:i}}(o.center,f,r[0]);if(!l)return t(e,i,r,o,a);for(var h,d=l.index,c=l.roof,m=[],v=0,x=[c[d[0]],c[d[1]]],g=0;g<c.length;g++)m[g]=w(c[g],x),v=Math.max(v,m[g]);for(g=0;g<c.length;g++)c[g][2]=(1-m[g]/v)*o.roofHeight;for(h=c.slice(d[0],d[1]+1),E.polygon(e,[h],o.roofZ,a),h=(h=c.slice(d[1],c.length-1)).concat(c.slice(0,d[0]+1)),E.polygon(e,[h],o.roofZ,a),g=0;g<c.length-1;g++)0===c[g][2]&&0===c[g+1][2]||E.quad(e,[c[g][0],c[g][1],o.roofZ+c[g][2]],[c[g][0],c[g][1],o.roofZ],[c[g+1][0],c[g+1][1],o.roofZ],[c[g+1][0],c[g+1][1],o.roofZ+c[g+1][2]],s)}function t(e,t,i,r,n){"cylinder"===t.shape?E.circle(e,r.center,r.radius,r.roofZ,n):E.polygon(e,i,r.roofZ,n)}m=function(i,r,n,o,a,s){switch(r.roofShape){case"cone":return function(e,t,i,r){E.polygon(e,t,i.roofZ,r),E.cylinder(e,i.center,i.radius,0,i.roofHeight,i.roofZ,r)}(i,n,o,a);case"dome":return function(e,t,i,r){E.polygon(e,t,i.roofZ,r),E.dome(e,i.center,i.radius,i.roofHeight,i.roofZ,r)}(i,n,o,a);case"pyramid":return function(e,t,i,r,n){"cylinder"===t.shape?E.cylinder(e,r.center,r.radius,0,r.roofHeight,r.roofZ,n):E.pyramid(e,i,r.center,r.roofHeight,r.roofZ,n)}(i,r,n,o,a);case"skillion":return function(e,i,r,n,o,a){if(void 0===i.roofDirection)return t(e,i,r,n,o);var s,u,f=i.roofDirection/180*Math.PI,l=1/0,h=-1/0;r[0].forEach(function(e){var t=e[1]*Math.cos(-f)+e[0]*Math.sin(-f);t<l&&(l=t,s=e),t>h&&(h=t,u=e)});var d=r[0],c=[Math.cos(f),Math.sin(f)],m=[s,[s[0]+c[0],s[1]+c[1]]],v=w(u,m);r.forEach(function(e){e.forEach(function(e){var t=w(e,m);e[2]=t/v*n.roofHeight})}),E.polygon(e,[d],n.roofZ,o),r.forEach(function(t){for(var i=0;i<d.length-1;i++)0===t[i][2]&&0===t[i+1][2]||E.quad(e,[t[i][0],t[i][1],n.roofZ+t[i][2]],[t[i][0],t[i][1],n.roofZ],[t[i+1][0],t[i+1][1],n.roofZ],[t[i+1][0],t[i+1][1],n.roofZ+t[i+1][2]],a)})}(i,r,n,o,a,s);case"gabled":return e(i,r,n,0,o,a,s);case"hipped":case"half-hipped":return t(i,r,n,o,a);case"gambrel":case"mansard":return e(i,r,n,0,o,a,s);case"round":return function(e,i,r,n,o,a){if(r.length>1||void 0===i.roofDirection)return t(e,i,r,n,o);return t(e,i,r,n,o)}(i,r,n,o,a);case"onion":return function(e,t,i,r){E.polygon(e,t,i.roofZ,r);for(var n,o,a=[{rScale:.8,hScale:0},{rScale:.9,hScale:.18},{rScale:.9,hScale:.35},{rScale:.8,hScale:.47},{rScale:.6,hScale:.59},{rScale:.5,hScale:.65},{rScale:.2,hScale:.82},{rScale:0,hScale:1}],s=0,u=a.length-1;s<u;s++)n=i.roofHeight*a[s].hScale,o=i.roofHeight*a[s+1].hScale,E.cylinder(e,i.center,i.radius*a[s].rScale,i.radius*a[s+1].rScale,o-n,i.roofZ+n,r)}(i,n,o,a);default:return t(i,r,n,o,a)}}}();var y,M,E={NUM_Y_SEGMENTS:24,NUM_X_SEGMENTS:32,quad:function(e,t,i,r,n,o){this.triangle(e,t,i,r,o),this.triangle(e,r,n,t,o)},triangle:function(e,t,i,r,n){var o=g.normal(t,i,r);[].push.apply(e.vertices,[].concat(t,r,i)),[].push.apply(e.normals,[].concat(o,o,o)),[].push.apply(e.colors,[].concat(n,n,n)),e.texCoords.push(0,0,0,0,0,0)},circle:function(e,t,i,r,n){var o,a;r=r||0;for(var s=0;s<this.NUM_X_SEGMENTS;s++)o=s/this.NUM_X_SEGMENTS,a=(s+1)/this.NUM_X_SEGMENTS,this.triangle(e,[t[0]+i*Math.sin(o*Math.PI*2),t[1]+i*Math.cos(o*Math.PI*2),r],[t[0],t[1],r],[t[0]+i*Math.sin(a*Math.PI*2),t[1]+i*Math.cos(a*Math.PI*2),r],n)},polygon:function(e,t,i,r){i=i||0;var n,o,a,s,u,f=[],l=[],h=0;for(n=0,o=t.length;n<o;n++){for(s=t[n],a=0;a<s.length;a++)u=s[a],f.push(u[0],u[1],i+(u[2]||0));n&&(h+=t[n-1].length,l.push(h))}var d,c,m,v=p(f,l,3);for(n=0,o=v.length-2;n<o;n+=3)d=3*v[n],c=3*v[n+1],m=3*v[n+2],this.triangle(e,[f[d],f[d+1],f[d+2]],[f[c],f[c+1],f[c+2]],[f[m],f[m+1],f[m+2]],r)},cube:function(e,t,i,r,n,o,a,s){var u=[n=n||0,o=o||0,a=a||0],f=[n+t,o,a],l=[n+t,o+i,a],h=[n,o+i,a],d=[n,o,a+r],c=[n+t,o,a+r],m=[n+t,o+i,a+r],v=[n,o+i,a+r];this.quad(e,f,u,h,l,s),this.quad(e,d,c,m,v,s),this.quad(e,u,f,c,d,s),this.quad(e,f,l,m,c,s),this.quad(e,l,h,v,m,s),this.quad(e,h,u,d,v,s)},cylinder:function(e,t,i,r,n,o,a){o=o||0;for(var s,u,f,l,h,d,c=this.NUM_X_SEGMENTS,m=2*Math.PI,v=0;v<c;v++)s=v/c*m,u=(v+1)/c*m,f=Math.sin(s),l=Math.cos(s),h=Math.sin(u),d=Math.cos(u),this.triangle(e,[t[0]+i*f,t[1]+i*l,o],[t[0]+r*h,t[1]+r*d,o+n],[t[0]+i*h,t[1]+i*d,o],a),0!==r&&this.triangle(e,[t[0]+r*f,t[1]+r*l,o+n],[t[0]+r*h,t[1]+r*d,o+n],[t[0]+i*f,t[1]+i*l,o],a)},dome:function(e,t,i,r,n,o,a){n=n||0;for(var s,u,f,l,h,d,c,m,v,x=this.NUM_Y_SEGMENTS/2,g=Math.PI/2,p=a?0:-g,T=0;T<x;T++)s=T/x*g+p,u=(T+1)/x*g+p,f=Math.cos(s),l=Math.sin(s),d=f*i,c=Math.cos(u)*i,m=((h=Math.sin(u))-l)*r,v=n-h*r,this.cylinder(e,t,c,d,m,v,o)},sphere:function(e,t,i,r,n,o){n=n||0;var a=0;return a+=this.dome(e,t,i,r/2,n+r/2,o,!0),a+=this.dome(e,t,i,r/2,n+r/2,o)},pyramid:function(e,t,i,r,n,o){n=n||0;for(var a=0,s=(t=t[0]).length-1;a<s;a++)this.triangle(e,[t[a][0],t[a][1],n],[t[a+1][0],t[a+1][1],n],[i[0],i[1],n+r],o)},extrusion:function(e,t,i,r,n,o){r=r||0;var a,s,u,f,l,h,d,c,m,p,T,b,w,y,M,E=o[2]*i,F=o[3]*i;for(b=0,w=t.length;b<w;b++)for(y=0,M=(a=t[b]).length-1;y<M;y++)s=a[y],u=a[y+1],f=v(x(s,u)),l=[s[0],s[1],r],h=[u[0],u[1],r],d=[u[0],u[1],r+i],c=[s[0],s[1],r+i],m=g.normal(l,h,d),[].push.apply(e.vertices,[].concat(l,d,h,l,c,d)),[].push.apply(e.normals,[].concat(m,m,m,m,m,m)),[].push.apply(e.colors,[].concat(n,n,n,n,n,n)),p=o[0]*f<<0,T=o[1]*f<<0,e.texCoords.push(p,F,T,E,T,F,p,F,p,E,T,E)}};!function(){var t=10,i=[.8627450980392157,.8235294117647058,.7843137254901961];METERS_PER_LEVEL=3;var r={brick:"#cc7755",bronze:"#ffeecc",canvas:"#fff8f0",concrete:"#999999",copper:"#a0e0d0",glass:"#e8f8f8",gold:"#ffcc00",plants:"#009933",metal:"#aaaaaa",panel:"#fff8f0",plaster:"#999999",roof_tiles:"#f08060",silver:"#cccccc",slate:"#666666",stone:"#996666",tar_paper:"#333333",wood:"#deb887"},n={asphalt:"tar_paper",bitumen:"tar_paper",block:"stone",bricks:"brick",glas:"glass",glassfront:"glass",grass:"plants",masonry:"stone",granite:"stone",panels:"panel",paving_stones:"stone",plastered:"plaster",rooftiles:"roof_tiles",roofingfelt:"tar_paper",sandstone:"stone",sheet:"canvas",sheets:"canvas",shingle:"tar_paper",shingles:"tar_paper",slates:"slate",steel:"metal",tar:"tar_paper",tent:"canvas",thatch:"plants",tile:"roof_tiles",tiles:"roof_tiles"},o=.5,a=6378137*Math.PI/180;function s(e){return"string"!=typeof e?null:"#"===(e=e.toLowerCase())[0]?e:r[n[e]||e]||null}function u(t,r){r=r||0;var n,o=e.parse(t);return[(n=o.isValid()?o.saturation(.7).toArray():i)[0]+r,n[1]+r,n[2]+r]}}();if(void 0===F){var F=function(e,t){t=t||{bubbles:!1,cancelable:!1,detail:void 0};var i=k.createEvent("CustomEvent");return i.initCustomEvent(e,t.bubbles,t.cancelable,t.detail),i};F.prototype=window.Event.prototype}const B=function(t){if((y=this).options=t||{},y.options.style){var i=y.options.style;(i.color||i.wallColor)&&(z=e.parse(i.color||i.wallColor).toArray())}Be.backgroundColor=e.parse(y.options.backgroundColor||G).toArray(),Be.fogColor=e.parse(y.options.fogColor||H).toArray(),y.options.highlightColor&&(Z=e.parse(y.options.highlightColor).toArray()),Be.effects={};for(var r=y.options.effects||[],n=0;n<r.length;n++)Be.effects[r[n]]=!0;y.attribution=y.options.attribution||B.ATTRIBUTION,y.minZoom=Math.max(parseFloat(y.options.minZoom||U),U),y.maxZoom=Math.min(parseFloat(y.options.maxZoom||O),O),y.maxZoom<y.minZoom&&(y.minZoom=U,y.maxZoom=O),y.bounds=y.options.bounds,y.position=y.options.position||{latitude:52.52,longitude:13.41},y.zoom=y.options.zoom||y.minZoom+(y.maxZoom-y.minZoom)/2,y.rotation=y.options.rotation||0,y.tilt=y.options.tilt||0,y.options.disabled&&y.setDisabled(!0);const o=window.navigator.hardwareConcurrency;y.workers=new class{constructor(e,t){this.items=[];for(let i=0;i<t;i++)this.items[i]={busy:!1,worker:new Worker(e)};this.status()}get(e){for(let t=0;t<this.items.length;t++)if(!this.items[t].busy)return this.items[t].busy=!0,e(this.items[t].worker),void this.status();setTimeout(()=>{this.get(e)},20)}free(e){for(let t=0;t<this.items.length;t++)if(this.items[t].worker===e)return this.items[t].busy=!1,void this.status()}status(){console.log(this.items.map(e=>e.busy?"A":"_").join(""))}}("./../src/workers/worker.js",4*o)};function S(e,t){return[e[0]+t[0],e[1]+t[1]]}function D(e,t){return[e[0]*t,e[1]*t]}function P(e){var t=e.target;if(t.getBoundingClientRect){var i=t.getBoundingClientRect();if(void 0!==i)return{x:e.x-i.left,y:e.y-i.top}}for(var r={x:0,y:0};1===t.nodeType;)r.x+=t.offsetLeft,r.y+=t.offsetTop,t=t.parentNode;return{x:e.x-r.s,y:e.y-r.y}}function I(e){e.preventDefault&&e.preventDefault(),e.returnValue=!1}function C(e,t,i){e.addEventListener(t,i,!1)}B.VERSION="4.0.0",B.ATTRIBUTION='<a href="https://osmbuildings.org/"> OSM Buildings</a>',B.prototype={appendTo:function(e,t,i){"string"==typeof e&&(e=k.getElementById(e)),y.container=k.createElement("DIV"),y.container.className="osmb",0===e.offsetHeight&&(e.style.height="100%",console.warn("Map container height should be set. Now defaults to 100%.")),e.appendChild(y.container),y.width=void 0!==t?t:e.offsetWidth,y.height=void 0!==i?i:e.offsetHeight;var r=k.createElement("CANVAS");r.className="osmb-viewport",r.width=y.width,r.height=y.width,y.container.appendChild(r),M=c.getContext(r),R.init(r),y._getStateFromUrl(),y.options.state&&(y._setStateToUrl(),y.on("change",y._setStateToUrl)),y._attribution=k.createElement("DIV"),y._attribution.className="osmb-attribution",y.container.appendChild(y._attribution),y._updateAttribution(),y.setDate(new Date),Be.start()},on:function(e,t){M.canvas.addEventListener(e,t)},off:function(e,t){M.canvas.removeEventListener(e,t)},emit:function(e,t){if(void 0!==M){var i=new F(e,{detail:t});M.canvas.dispatchEvent(i)}},setDate:function(e){Se.setDate("string"==typeof e?new Date(e):e)},project:function(e,t,i){var r=V*Math.cos(y.position.latitude/180*Math.PI),n=[(t-y.position.longitude)*r,-(e-y.position.latitude)*V,i*L],o=ne(Be.viewProjMatrix.data,n);return{x:(o=ye(we(o,[1,1,1]),.5))[0]*y.width,y:(1-o[1])*y.height,z:o[2]}},unproject:function(e,t){var i=c.Matrix.invert(Be.viewProjMatrix.data),r=[e/y.width,1-t/y.height],n=oe((r=S(D(r,2),[-1,-1,-1]))[0],r[1],i);if(void 0!==n){var o=V*Math.cos(y.position.latitude/180*Math.PI);return{latitude:y.position.latitude-n[1]/V,longitude:y.position.longitude+n[0]/o}}},addOBJ:function(e,t,i){return new $.OBJ(e,t,i)},addGeoJSON:function(e,t){return new $.GeoJSON(e,t)},addGeoJSONTiles:function(e,t){return(t=t||{}).fixedZoom=t.fixedZoom||15,y.dataGrid=new Q(e,K.Tile,t),y.dataGrid},addMapTiles:function(e){return y.basemapGrid=new Q(e,De.Tile),y.basemapGrid},highlight:function(t,i){Be.Buildings.highlightId=t?Be.Picking.idToColor(t):null,Be.Buildings.highlightColor=t&&i?e.parse(i).toArray():Z},show:function(e,t){J.remove("hidden",e,t)},hide:function(e,t){J.add("hidden",e,t)},getTarget:function(e,t,i){Be.Picking.getTarget(e,t,i)},screenshot:function(e){Be.screenshotCallback=e},_updateAttribution:function(){var e=[];y.attribution&&e.push(y.attribution),y._attribution.innerHTML=e.join("  ")},_getStateFromUrl:function(){var e=location.search,t={};e&&e.substring(1).replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(e,i,r){i&&(t[i]=r)}),y.setPosition(void 0!==t.lat&&void 0!==t.lon?{latitude:t.lat,longitude:t.lon}:y.position),y.setZoom(void 0!==t.zoom?t.zoom:y.zoom),y.setRotation(void 0!==t.rotation?t.rotation:y.rotation),y.setTilt(void 0!==t.tilt?t.tilt:y.tilt)},_setStateToUrl:function(){history.replaceState&&!y.stateDebounce&&(y.stateDebounce=setTimeout(function(){y.stateDebounce=null;var e=[];e.push("lat="+y.position.latitude.toFixed(6)),e.push("lon="+y.position.longitude.toFixed(6)),e.push("zoom="+y.zoom.toFixed(1)),e.push("tilt="+y.tilt.toFixed(1)),e.push("rotation="+y.rotation.toFixed(1)),history.replaceState({},"","?"+e.join("&"))},1e3))},setDisabled:function(e){R.disabled=!!e},isDisabled:function(){return!!R.disabled},getBounds:function(){var e=Be.getViewQuad(),t=[];for(var i in e)t[i]=fe(e[i]);return t},setZoom:function(e,t){e=parseFloat(e),e=Math.max(e,y.minZoom),e=Math.min(e,y.maxZoom),y.zoom!==e&&(y.zoom=e,y.emit("zoom",{zoom:e}),y.emit("change"))},getZoom:function(){return y.zoom},setPosition:function(e){var t=parseFloat(e.latitude),i=parseFloat(e.longitude);isNaN(t)||isNaN(i)||(y.position={latitude:W(t,-90,90),longitude:W(i,-180,180)},y.emit("change"))},getPosition:function(){return y.position},setSize:function(e){e.width===y.width&&e.height===y.height||(y.width=e.width,y.height=e.height,y.emit("resize",{width:y.width,height:y.height}))},getSize:function(){return{width:y.width,height:y.height}},setRotation:function(e){e=parseFloat(e)%360,y.rotation!==e&&(y.rotation=e,y.emit("rotate",{rotation:e}),y.emit("change"))},getRotation:function(){return y.rotation},setTilt:function(e){e=W(parseFloat(e),0,45),y.tilt!==e&&(y.tilt=e,y.emit("tilt",{tilt:e}),y.emit("change"))},getTilt:function(){return y.tilt},destroy:function(){Be.destroy(),c.destroy(),K.Index.destroy(),y.container.innerHTML=""}},"function"==typeof define?define([],B):"object"==typeof module?module.exports=B:window.OSMBuildings=B;var R={disabled:!1};R.init=function(e){var t,i=top||window;"ontouchstart"in i?(C(e,"touchstart",function(e){u=1,I(e);var t=e.touches[0];if(2===e.touches.length&&!("ongesturechange"in i)){var f=e.touches[1],l=t.clientX-f.clientX,h=t.clientY-f.clientY;d=l*l+h*h,c=Math.atan2(h,l),!0}o=y.zoom,a=y.rotation,s=y.tilt,r=t.clientX,n=t.clientY,y.emit("pointerdown",{x:e.x,y:e.y,button:0,buttons:1})}),C(i.document,"touchmove",function(e){if(!u)return;var t=e.touches[0];e.touches.length>1?(y.setTilt(s+(n-t.clientY)*(360/innerHeight)),s=y.tilt,"ongesturechange"in i||function(e){var t=e.touches[0],i=e.touches[1],r=t.clientX-i.clientX,n=t.clientY-i.clientY,o=r*r+n*n;m({rotation:(Math.atan2(n,r)-c)*(180/Math.PI)%360,scale:Math.sqrt(o/d)})}(e)):l(t);r=t.clientX,n=t.clientY}),C(e,"touchmove",function(e){if(1===e.touches.length){var t=P(e.touches[0]);y.emit("pointermove",{x:t.x,y:t.y,button:0,buttons:1})}}),C(i.document,"touchend",function(e){if(!u)return;!1;var t=e.touches[0];0===e.touches.length?(u=0,y.emit("pointerup",{button:0,buttons:1})):1===e.touches.length&&(r=t.clientX,n=t.clientY)}),C(i.document,"gesturechange",m)):(C(e,"mousedown",function(e){I(e),o=y.zoom,a=y.rotation,s=y.tilt,r=e.clientX,n=e.clientY,1===e.buttons&&e.altKey||2===e.buttons?u=2:1===e.buttons&&(u=1);var t=P(e);y.emit("pointerdown",{x:t.x,y:t.y,button:e.button,buttons:e.buttons})}),C(i.document,"mousemove",function(e){1===u?l(e):2===u&&h(e);r=e.clientX,n=e.clientY}),C(e,"mousemove",function(e){y.emit("pointermove",P(e))}),C(i.document,"mouseup",function(e){if(!u)return;1===u?l(e):2===u&&h(e);u=0,y.emit("pointerup",{button:e.button,buttons:e.buttons})}),C(e,"dblclick",function(e){I(e),R.disabled||y.setZoom(y.zoom+1,e);var t=P(e);y.emit("doubleclick",{x:t.x,y:t.y,button:e.button,buttons:e.buttons})}),C(e,"mousewheel",f),C(e,"DOMMouseScroll",f),C(e,"contextmenu",function(e){e.preventDefault()})),C(window,"resize",function(){t||(t=setTimeout(function(){t=null,y.setSize({width:e.offsetWidth,height:e.offsetHeight})},250))});var r=0,n=0,o=0,a=0,s=0,u=0;function f(e){I(e);var t=0;if(e.wheelDeltaY?t=e.wheelDeltaY:e.wheelDelta?t=e.wheelDelta:e.detail&&(t=-e.detail),!R.disabled){var i=.2*(t>0?1:t<0?-1:0);y.setZoom(y.zoom+i,e)}}function l(e){if(!R.disabled){var t=.86*Math.pow(2,-y.zoom),i=1/Math.cos(y.position.latitude/180*Math.PI),o=e.clientX-r,a=e.clientY-n,s=y.rotation*Math.PI/180,u=[Math.cos(s),Math.sin(s)],f=[Math.cos(s-Math.PI/2),Math.sin(s-Math.PI/2)],l=S(D(u,o),D(f,-a)),h={longitude:y.position.longitude-l[0]*t*i,latitude:y.position.latitude+l[1]*t};y.setPosition(h),y.emit("move",h)}}function h(e){R.disabled||(a+=(e.clientX-r)*(360/innerWidth),s-=(e.clientY-n)*(360/innerHeight),y.setRotation(a),y.setTilt(s))}var d=0,c=0;function m(e){u&&(I(e),R.disabled||(y.setZoom(o+(e.scale-1)),y.setRotation(a-e.rotation)),y.emit("gesture",e))}};var A,_,N={};_=0,N.setBusy=function(){_||(A?(clearTimeout(A),A=null):y.emit("busy")),_++},N.setIdle=function(){_&&(--_||(A=setTimeout(function(){A=null,y.emit("idle")},33)))},N.isBusy=function(){return!!_};var L=1,U=14.5,O=22,z=e.parse("rgb(220, 210, 200)").toArray(),Z=e.parse("#f08000").toArray(),H="#e8e0d8",G="#efe8e0",k=window.document,X=6378137*Math.PI*2,V=X/360;class j{static load(e,t){const i=new XMLHttpRequest;return i.onreadystatechange=(()=>{4===i.readyState&&(!i.status||i.status<200||i.status>299||t(i))}),i.open("GET",e),i.send(null),{abort:()=>{i.abort()}}}static getText(e,t){return this.load(e,e=>{void 0!==e.responseText&&t(e.responseText)})}static getXML(e,t){return this.load(e,e=>{void 0!==e.responseXML&&t(e.responseXML)})}static getJSON(e,t){return this.load(e,e=>{if(e.responseText){let i;try{i=JSON.parse(e.responseText)}catch(e){console.warn("Could not parse JSON from {url}\n{ex.message}")}t(i)}})}}function q(e,t){if(!e)throw t}function Y(e,t){var i=[];for(var r in e)i.push([e[r][0],e[r][1],t]);return i}function W(e,t,i){return Math.min(i,Math.max(e,t))}var Q=function(e,t,i){this.tiles={},this.buffer=1,this.source=e,this.tileClass=t,i=i||{},this.bounds=i.bounds,this.fixedZoom=i.fixedZoom,this.tileOptions={color:i.color,fadeIn:i.fadeIn},this.minZoom=Math.max(parseFloat(i.minZoom||U),y.minZoom),this.maxZoom=Math.min(parseFloat(i.maxZoom||O),y.maxZoom),this.maxZoom<this.minZoom&&(this.minZoom=U,this.maxZoom=O),y.on("change",this._onChange=function(){this.update(500)}.bind(this)),y.on("resize",this._onResize=this.update.bind(this)),this.update()};Q.prototype={update:function(e){y.zoom<this.minZoom||y.zoom>this.maxZoom||(e?this.debounce||(this.debounce=setTimeout(function(){this.debounce=null,this.loadTiles()}.bind(this),e)):this.loadTiles())},getURL:function(e,t,i){var r,n,o="abcd"[(e+t)%4];return r=this.source,n={s:o,x:e,y:t,z:i},r.replace(/\{(\w+)\}/g,function(e,t){return n[t]||e})},getClosestTiles:function(e,t){var i,r;return e.sort(function(e,i){return Math.pow(e[0]+.5-t[0],2)+Math.pow(e[1]+.5-t[1],2)>Math.pow(i[0]+.5-t[0],2)+Math.pow(i[1]+.5-t[1],2)}),e.filter(function(e){return(e[0]!==i||e[1]!==r)&&(i=e[0],r=e[1],!0)})},mergeTiles:function(e,t,i){var r,n={},o={},a=[];if(0===t||t<=this.minZoom){for(r in e)e[r][2]=t;return e}for(r in e){var s=e[r],u=(s[0]<<0)/2,f=(s[1]<<0)/2;if(void 0===n[[u,f]]){var l=ae(u,f,t-1,Be.viewProjMatrix);n[[u,f]]=l<i}n[[u,f]]||void 0===o[[s[0],s[1]]]&&(o[[s[0],s[1]]]=!0,a.push([s[0],s[1],t]))}var h=[];for(r in n)if(n[r]){var d=r.split(",");h.push([parseInt(d[0]),parseInt(d[1]),t-1])}return h.length>0&&(h=this.mergeTiles(h,t-1,i)),a.concat(h)},loadTiles:function(){var e,t,i,r,n,o=Math.round(this.fixedZoom||y.zoom),a=[],s=Be.getViewQuad(Be.viewProjMatrix.data),u=[he(y.position.longitude,o),de(y.position.latitude,o)];for(n=0;n<4;n++)s[n]=le(s[n],o);var f,l,h,d,c=function(e){q(4==e.length,"Error: Quadrilateral with more or less than four vertices");var t=te(e[0],e[1],e[2]),i=te(e[0],e[2],e[3]);return t.concat(i)}(s);for(c=this.fixedZoom?this.getClosestTiles(c,u):this.mergeTiles(c,o,32768),this.visibleTiles={},n=0;n<c.length;n++)void 0===c[n][2]&&(c[n][2]=o),this.visibleTiles[c[n]]=!0;for(var m in this.visibleTiles)e=m.split(","),t=parseInt(e[0]),i=parseInt(e[1]),r=parseInt(e[2]),this.tiles[m]||(this.tiles[m]=new this.tileClass(t,i,r,this.tileOptions,this.tiles),a.push({tile:this.tiles[m],dist:(f=[t,i],l=u,void 0,void 0,h=f[0]-l[0],d=f[1]-l[1],h*h+d*d)}));for(this.purge(),a.sort(function(e,t){return e.dist-t.dist}),n=0;n<a.length;n++)(e=a[n].tile).load(this.getURL(e.x,e.y,e.zoom))},purge:function(){var e,t,i=Math.round(y.zoom);for(var r in this.tiles)e=this.tiles[r],this.visibleTiles[r]||(this.fixedZoom?(this.tiles[r].destroy(),delete this.tiles[r]):e.zoom===i+1&&(t=[e.x/2<<0,e.y/2<<0,i].join(","),this.visibleTiles[t])||e.zoom===i-1&&(this.visibleTiles[[2*e.x,2*e.y,i].join(",")]||this.visibleTiles[[2*e.x+1,2*e.y,i].join(",")]||this.visibleTiles[[2*e.x,2*e.y+1,i].join(",")]||this.visibleTiles[[2*e.x+1,2*e.y+1,i].join(",")])||delete this.tiles[r])},destroy:function(){for(var e in y.off("change",this._onChange),y.off("resize",this._onResize),clearTimeout(this.debounce),this.tiles)this.tiles[e].destroy();this.tiles=[],this.visibleTiles={}}};var J={start:Date.now(),now:0,items:[],add:function(e,t,i){i=i||0;var r,n,o,a,s=this.items;for(l=0,h=s.length;l<h;l++)if(s[l].type===e&&s[l].selector===t)return;s.push({type:e,selector:t,duration:i});for(var u=this.getTime(),f=u+i,l=0,h=K.Index.items.length;l<h;l++)if((r=K.Index.items[l]).applyFilter){for(o=0,a=r.items.length;o<a;o++)t((n=r.items[o]).id,n.data)&&(n.filter=[u,f,n.filter?n.filter[3]:1,0]);r.applyFilter()}},remove:function(e,t,i){var r,n,o,a,s,u;i=i||0,this.items=this.items.filter(function(i){return i.type!==e||i.selector!==t});var f=this.getTime(),l=f+i;for(r=0,n=K.Index.items.length;r<n;r++)if((o=K.Index.items[r]).applyFilter){for(s=0,u=o.items.length;s<u;s++)a=o.items[s],t(a.id,a.data)&&(a.filter=[f,l,a.filter?a.filter[3]:0,1]);o.applyFilter()}},apply:function(e){var t,i,r,n,o=this.items;if(e.applyFilter){for(var a=0,s=o.length;a<s;a++)for(o[a].type,t=o[a].selector,r=0,n=e.items.length;r<n;r++)t((i=e.items[r]).id,i.data)&&(i.filter=[0,0,0,0]);e.applyFilter()}},getTime:function(){return this.now},nextTick:function(){this.now=Date.now()-this.start},destroy:function(){this.items=[]}},K={Index:{items:[],add:function(e){this.items.push(e)},remove:function(e){this.items=this.items.filter(function(t){return t!==e})},destroy:function(){this.items=[]}},Tile:function(e,t,i,r){this.x=e,this.y=t,this.zoom=i,this.key=[e,t,i].join(","),this.options=r}};K.Tile.prototype={load:function(e){this.mesh=new $.GeoJSON(e,this.options)},destroy:function(){this.mesh&&this.mesh.destroy()}};var $={};function q(e,t){if(!e)throw t}function ee(e,t,i){var r=[e[0]<t[0]?1:-1,e[1]<t[1]?1:-1],n=i[0]+(e[0]<t[0]?1:0),o=i[1]+(e[1]<t[1]?1:0),a=(n-e[0])/(t[0]-e[0]),s=(o-e[1])/(t[1]-e[1]);return(a<=0||a>1)&&(s<=0||s>1)?[void 0,void 0]:a<=0||a>1?[i[0],i[1]+r[1]]:s<=0||s>1?[i[0]+r[0],i[1]]:a<s?[i[0]+r[0],i[1]]:[i[0],i[1]+r[1]]}function te(e,t,i){var r=[e,t,i];if(r.sort(function(e,t){return e[1]<t[1]}),e=r[0],t=r[1],i=r[2],e[1]==t[1])return ie(e,t,i);if(t[1]==i[1])return ie(t,i,e);var n=(t[1]-e[1])/(i[1]-e[1]),o=[e[0]+n*(i[0]-e[0]),t[1]];return ie(o,t,e).concat(ie(o,t,i))}function ie(e,t,i){var r=[];if(q(e[1]===t[1],"not a flat triangle"),q(i[1]!==e[1],"not a triangle"),q(e[0]!==t[0],"not a triangle"),e[0]>t[0]){var n=e;e=t,t=n}var o=[i[0]<<0,i[1]<<0],a=o.slice(0);r.push(o.slice(0));for(var s,u,f=i[1]<e[1]?1:-1,l=o[1],h=(e[1]<<0)+f,d=l;d*f<h*f;d+=f){do{r.push(o.slice(0)),s=o,o=ee(i,e,o)}while(o[1]*f<=d*f);o=s;do{r.push(a.slice(0)),u=a,a=ee(i,t,a)}while(a[1]*f<=d*f);a=u;for(var c=o[0];c<=a[0];c++)r.push([c,d])}return r}function re(e,t,i){var r=be(e,t),n=be(t,i);return Ee([r[1]*n[2]-r[2]*n[1],r[2]*n[0]-r[0]*n[2],r[0]*n[1]-r[1]*n[0]])}function ne(e,t){var i=t[0]*e[0]+t[1]*e[4]+t[2]*e[8]+e[12],r=t[0]*e[1]+t[1]*e[5]+t[2]*e[9]+e[13],n=t[0]*e[2]+t[1]*e[6]+t[2]*e[10]+e[14],o=t[0]*e[3]+t[1]*e[7]+t[2]*e[11]+e[15];return[i/o,r/o,n/o]}function oe(e,t,i){var r=ne(i,[e,t,0]),n=be(ne(i,[e,t,1]),r);if(!(n[2]>=0)){var o=we(r,ye(n,-r[2]/n[2]));return[o[0],o[1]]}}function ae(e,t,i,r){var n=V*Math.cos(y.position.latitude/180*Math.PI),o=ce(e,i),a=me(t,i),s=new c.Matrix;s.translate((o-y.position.longitude)*n,-(a-y.position.latitude)*V,0);var u,f=ue(y.position.latitude,i),l=c.Matrix.multiply(s,r),h=ne(l,[0,0,0]),d=ne(l,[f,0,0]),m=ne(l,[0,f,0]),v=ne(l,[f,f,0]),x=[h,d,m,v];for(var g in x)x[g][0]=(x[g][0]+1)/2*y.width,x[g][1]=(x[g][1]+1)/2*y.height;return se((u=[h,d,v,m])[0],u[1],u[2])+se(u[0],u[2],u[3])}function se(e,t,i){var r=ve(ge(e,t)),n=ve(ge(e,i)),o=ve(ge(t,i)),a=.5*(r+n+o);return Math.sqrt(a*(a-r)*(a-n)*(a-o))}function ue(e,t){return X*Math.cos(e/180*Math.PI)/Math.pow(2,t)}function fe(e){var t=V*Math.cos(y.position.latitude/180*Math.PI);return{longitude:y.position.longitude+e[0]/t,latitude:y.position.latitude-e[1]/V}}function le(e,t){var i=fe(e);return[he(i.longitude,t),de(i.latitude,t)]}function he(e,t){return(e+180)/360*Math.pow(2,t)}function de(e,t){return(1-Math.log(Math.tan(e*Math.PI/180)+1/Math.cos(e*Math.PI/180))/Math.PI)/2*Math.pow(2,t)}function ce(e,t){return e/Math.pow(2,t)*360-180}function me(e,t){var i=Math.PI-2*Math.PI*e/Math.pow(2,t);return 180/Math.PI*Math.atan(.5*(Math.exp(i)-Math.exp(-i)))}function ve(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1])}function xe(e,t){return e[0]*t[0]+e[1]*t[1]}function ge(e,t){return[e[0]-t[0],e[1]-t[1]]}function S(e,t){return[e[0]+t[0],e[1]+t[1]]}function D(e,t){return[e[0]*t,e[1]*t]}function pe(e){var t=ve(e);return[e[0]/t,e[1]/t]}function Te(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function be(e,t){return[e[0]-t[0],e[1]-t[1],e[2]-t[2]]}function we(e,t){return[e[0]+t[0],e[1]+t[1],e[2]+t[2]]}function ye(e,t){return[e[0]*t,e[1]*t,e[2]*t]}function Me(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])}function Ee(e){var t=Me(e);return[e[0]/t,e[1]/t,e[2]/t]}function Fe(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}$.GeoJSON=class{constructor(e,t){t=t||{},this.options=t,this.number=Math.floor(1e5*Math.random()+1),this.forcedId=t.id,this.forcedColor=t.color,this.replace=!!t.replace,this.scale=t.scale||1,this.rotation=t.rotation||0,this.elevation=t.elevation||0,this.shouldFadeIn=!("fadeIn"in t)||!!t.fadeIn,this.minZoom=Math.max(parseFloat(t.minZoom||U),y.minZoom),this.maxZoom=Math.min(parseFloat(t.maxZoom||O),y.maxZoom),this.maxZoom<this.minZoom&&(this.minZoom=U,this.maxZoom=O),this.items=[],N.setBusy(),y.workers.get(t=>{this.worker=t;const i=function(e){this.setData(e.data),t.removeEventListener("message",i,!1),y.workers.free(t)}.bind(this);this.worker.addEventListener("message",i,!1),"object"==typeof e?t.postMessage({action:"process",geojson:e,options:this.options}):t.postMessage({action:"load",url:e,options:this.options})})}setData(e){this.items=e.items,this.position=e.position,this.vertexBuffer=new c.Buffer(3,e.vertices),this.normalBuffer=new c.Buffer(3,e.normals),this.colorBuffer=new c.Buffer(3,e.colors),this.texCoordBuffer=new c.Buffer(2,e.texCoords),this.idBuffer=new c.Buffer(3,e.idColors),this.initBuffers(),J.apply(this),K.Index.add(this),this.isReady=!0,N.setIdle()}initBuffers(){let e=J.getTime(),t=e;this.shouldFadeIn&&(e+=250,t+=750);const i=[],r=[];this.items.forEach(n=>{n.filter=[e,t,0,1];for(let e=0;e<n.vertexCount;e++)i.push.apply(i,n.filter),r.push(n.height)}),this.filterBuffer=new c.Buffer(4,new Float32Array(i)),this.heightBuffer=new c.Buffer(1,new Float32Array(r))}applyFilter(){const e=[];this.items.forEach(t=>{for(let i=0;i<t.vertexCount;i++)e.push.apply(e,t.filter)}),this.filterBuffer=new c.Buffer(4,new Float32Array(e))}getMatrix(){const e=new c.Matrix;this.elevation&&e.translate(0,0,this.elevation),e.scale(this.scale,this.scale,this.scale*L),this.rotation&&e.rotateZ(-this.rotation);const t=this.position.latitude-y.position.latitude,i=this.position.longitude-y.position.longitude,r=V*Math.cos(y.position.latitude/180*Math.PI);return e.translate(i*r,-t*V,0),e}destroy(){this.isReady=!1,clearTimeout(this.relaxTimer),K.Index.remove(this),this.request&&this.request.abort(),this.items=[],this.isReady&&(this.vertexBuffer.destroy(),this.normalBuffer.destroy(),this.colorBuffer.destroy(),this.texCoordBuffer.destroy(),this.idBuffer.destroy(),this.heightBuffer.destroy())}},$.MapPlane=function(){function e(e){e=e||{},this.id=e.id,this.radius=e.radius||5e3,this.createGlGeometry(),this.minZoom=y.minZoom,this.maxZoom=y.maxZoom}return e.prototype={createGlGeometry:function(){var e=2*this.radius/50;this.vertexBuffer=[],this.normalBuffer=[],this.filterBuffer=[];for(var t=[0,0,1],i=[].concat(t,t,t,t,t,t),r=[0,1,1,1],n=[].concat(r,r,r,r,r,r),o=0;o<50;o++)for(var a=0;a<50;a++){var s=-this.radius+o*e,u=-this.radius+a*e;this.vertexBuffer.push(s,u,0,s+e,u+e,0,s+e,u,0,s,u,0,s,u+e,0,s+e,u+e,0),this.vertexBuffer.push(s,u,0,s+e,u,0,s+e,u+e,0,s,u,0,s+e,u+e,0,s,u+e,0),[].push.apply(this.normalBuffer,i),[].push.apply(this.normalBuffer,i),[].push.apply(this.filterBuffer,n),[].push.apply(this.filterBuffer,n)}this.vertexBuffer=new c.Buffer(3,new Float32Array(this.vertexBuffer)),this.normalBuffer=new c.Buffer(3,new Float32Array(this.normalBuffer)),this.filterBuffer=new c.Buffer(4,new Float32Array(this.filterBuffer))},getMatrix:function(){return new c.Matrix},destroy:function(){this.vertexBuffer.destroy(),this.normalBuffer.destroy(),this.colorBuffer.destroy(),this.idBuffer.destroy()}},e}(),$.DebugQuad=function(){function e(e){e=e||{},this.id=e.id,this.v1=this.v2=this.v3=this.v4=[!1,!1,!1],this.updateGeometry([0,0,0],[0,0,0],[0,0,0],[0,0,0]),this.minZoom=y.minZoom,this.maxZoom=y.maxZoom}return e.prototype={updateGeometry:function(e,t,i,r){if(!(Fe(e,this.v1)&&Fe(t,this.v2)&&Fe(i,this.v3)&&Fe(r,this.v4))){this.v1=e,this.v2=t,this.v3=i,this.v4=r,this.vertexBuffer&&this.vertexBuffer.destroy();var n=[].concat(e,t,i,e,i,r);this.vertexBuffer=new c.Buffer(3,new Float32Array(n)),this.normalBuffer&&this.normalBuffer.destroy(),this.normalBuffer=new c.Buffer(3,new Float32Array([0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1]));var o=[1,.5,.25];this.colorBuffer&&this.colorBuffer.destroy(),this.colorBuffer=new c.Buffer(3,new Float32Array([].concat(o,o,o,o,o,o))),this.texCoordBuffer=new c.Buffer(2,new Float32Array([0,0,0,0,0,0,0,0,0,0,0,0])),this.idBuffer&&this.idBuffer.destroy(),this.idBuffer=new c.Buffer(3,new Float32Array([].concat(o,o,o,o,o,o))),this.heightBuffer&&this.heightBuffer.destroy(),this.heightBuffer=new c.Buffer(1,new Float32Array([].concat(0,0)));var a=[0,1,1,1];this.filterBuffer=new c.Buffer(4,new Float32Array([].concat(a,a,a,a,a,a)))}},getMatrix:function(){return new c.Matrix},destroy:function(){this.vertexBuffer.destroy(),this.normalBuffer.destroy(),this.colorBuffer.destroy(),this.texCoordBuffer.destroy(),this.idBuffer.destroy(),this.heightBuffer.destroy()}},e}(),$.OBJ=function(){function t(e,t){null!==t&&(e[t.id]=t.color)}function i(e,t,i,r,n){if(n.length){var o=function(e,t){for(var i,r,n,o,a=[],s=[],u=[],f=-1/0,l=0,h=t.length;l<h;l++)i=e[t[l][0]],r=e[t[l][1]],n=e[t[l][2]],o=re(i,r,n),a.push(i[0],i[2],i[1],r[0],r[2],r[1],n[0],n[2],n[1]),s.push(o[0],o[1],o[2],o[0],o[1],o[2],o[0],o[1],o[2]),u.push(0,0,0,0,0,0),f=Math.max(f,i[1],r[1],n[1]);return{vertices:a,normals:s,texCoords:u,height:f}}(e,n);t.push({vertices:o.vertices,normals:o.normals,color:r,texCoords:o.texCoords,id:i,height:o.height})}}function r(i,r,n){n=n||{},this.forcedId=n.id,n.color&&(this.forcedColor=e.parse(n.color).toArray()),this.replace=!!n.replace,this.scale=n.scale||1,this.rotation=n.rotation||0,this.elevation=n.elevation||0,this.position=r,this.shouldFadeIn=!("fadeIn"in n)||!!n.fadeIn,this.minZoom=Math.max(parseFloat(n.minZoom||U),y.minZoom),this.maxZoom=Math.min(parseFloat(n.maxZoom||O),y.maxZoom),this.maxZoom<this.minZoom&&(this.minZoom=U,this.maxZoom=O),this.data={vertices:[],normals:[],colors:[],texCoords:[],ids:[]},N.setBusy(),this.request=j.getText(i,function(e){var r;this.request=null,(r=e.match(/^mtllib\s+(.*)$/m))?this.request=j.getText(i.replace(/[^\/]+$/,"")+r[1],function(i){this.request=null,this.onLoad(e,function(e){for(var i,r=e.split(/[\r\n]/g),n={},o=null,a=0,s=r.length;a<s;a++)switch((i=r[a].trim().split(/\s+/))[0]){case"newmtl":t(n,o),o={id:i[1],color:{}};break;case"Kd":o.color=[parseFloat(i[1]),parseFloat(i[2]),parseFloat(i[3])];break;case"d":o.color[3]=parseFloat(i[1])}return t(n,o),e=null,n}(i))}.bind(this)):this.onLoad(e,null)}.bind(this))}return r.prototype={onLoad:function(e,t){this.items=[],this.addItems(function(e,t){for(var r,n,o,a=[],s=e.split(/[\r\n]/g),u=[],f=[],l=0,h=s.length;l<h;l++)switch((r=s[l].trim().split(/\s+/))[0]){case"g":case"o":i(a,u,n,o,f),n=r[1],f=[];break;case"usemtl":i(a,u,n,o,f),t[r[1]]&&(o=t[r[1]]),f=[];break;case"v":a.push([parseFloat(r[1]),parseFloat(r[2]),parseFloat(r[3])]);break;case"f":f.push([parseFloat(r[1])-1,parseFloat(r[2])-1,parseFloat(r[3])-1])}return i(a,u,n,o,f),e=null,u}(e,t)),this.onReady()},addItems:function(e){e.forEach(function(e){y.emit("loadfeature",e),[].push.apply(this.data.vertices,e.vertices),[].push.apply(this.data.normals,e.normals),[].push.apply(this.data.texCoords,e.texCoords);for(var t,i,r=this.forcedId||e.id,n=Be.Picking.idToColor(r),o=(r/2%2?-1:1)*(r%2?.03:.06),a=this.forcedColor||e.color||z,s=0;s<e.vertices.length-2;s+=3)[].push.apply(this.data.colors,(i=o,[(t=a)[0]+i,t[1]+i,t[2]+i])),[].push.apply(this.data.ids,n);this.items.push({id:r,vertexCount:e.vertices.length/3,height:e.height,data:e.data})}.bind(this))},_initItemBuffers:function(){var e=J.getTime(),t=e;this.shouldFadeIn&&(e+=250,t+=750);var i=[],r=[];this.items.forEach(function(n){n.filter=[e,t,0,1];for(var o=0;o<n.vertexCount;o++)i.push.apply(i,n.filter),r.push(n.height)}),this.filterBuffer=new c.Buffer(4,new Float32Array(i)),this.heightBuffer=new c.Buffer(1,new Float32Array(r))},applyFilter:function(){var e=[];this.items.forEach(function(t){for(var i=0;i<t.vertexCount;i++)e.push.apply(e,t.filter)}),this.filterBuffer=new c.Buffer(4,new Float32Array(e))},onReady:function(){this.vertexBuffer=new c.Buffer(3,new Float32Array(this.data.vertices)),this.normalBuffer=new c.Buffer(3,new Float32Array(this.data.normals)),this.colorBuffer=new c.Buffer(3,new Float32Array(this.data.colors)),this.texCoordBuffer=new c.Buffer(2,new Float32Array(this.data.texCoords)),this.idBuffer=new c.Buffer(3,new Float32Array(this.data.ids)),this._initItemBuffers(),this.data=null,J.apply(this),K.Index.add(this),this.isReady=!0,N.setIdle()},getMatrix:function(){var e=new c.Matrix;this.elevation&&e.translate(0,0,this.elevation),e.scale(this.scale,this.scale,this.scale),this.rotation&&e.rotateZ(-this.rotation);var t=V*Math.cos(y.position.latitude/180*Math.PI),i=this.position.latitude-y.position.latitude,r=this.position.longitude-y.position.longitude;return e.translate(r*t,-i*V,0),e},destroy:function(){K.Index.remove(this),this.request&&this.request.abort(),this.items=[],this.isReady&&(this.vertexBuffer.destroy(),this.normalBuffer.destroy(),this.colorBuffer.destroy(),this.texCoordBuffer.destroy(),this.idBuffer.destroy(),this.heightBuffer.destroy())}},r}();var Be={getViewQuad:function(){return function(e,t,i){var r,n,o,a=c.Matrix.invert(e),s=oe(-1,-1,a),u=oe(1,-1,a),f=oe(1,1,a),l=oe(-1,1,a);if(s&&u)return l&&f||(o=xe(r=pe(ge(oe(-1,-.9,a),s)),i),l=S(s,D(r,t/o)),o=xe(n=pe(ge(oe(1,-.9,a),u)),i),f=S(u,D(n,t/o))),xe(i,ge(l,s))>t&&(o=xe(r=pe(ge(l,s)),i),l=S(s,D(r,t/o))),xe(i,ge(f,u))>t&&(o=xe(n=pe(ge(f,u)),i),f=S(u,D(n,t/o))),[s,u,f,l]}(this.viewProjMatrix.data,this.fogDistance+this.fogBlurDistance,this.viewDirOnMap)},start:function(){M.depthTextureExtension||(console.log("Shadows and ground shading are disabled, because your GPU does not support WEBGL_depth_texture"),delete Be.effects.shadows,delete Be.effects.outlines),y.on("change",this._onChange=this.onChange.bind(this)),y.on("resize",this._onResize=this.onResize.bind(this)),this.onResize(),M.cullFace(M.BACK),M.enable(M.CULL_FACE),M.enable(M.DEPTH_TEST),Be.Picking.init(),Be.Buildings.init(),Be.Basemap.init(),Be.Overlay.init(),Be.AmbientMap.init(),Be.OutlineMap.init(),Be.blurredAmbientMap=new Be.Blur,Be.blurredOutlineMap=new Be.Blur,Be.MapShadows.init(),(Be.effects.shadows||Be.effects.outlines)&&(Be.cameraGBuffer=new Be.DepthFogNormalMap),Be.effects.shadows&&(Be.sunGBuffer=new Be.DepthFogNormalMap,Be.sunGBuffer.framebufferSize=[2048,2048]),requestAnimationFrame(this.renderFrame.bind(this))},renderFrame:function(){if(void 0!==M&&(J.nextTick(),requestAnimationFrame(this.renderFrame.bind(this)),this.onChange(),M.clearColor(this.fogColor[0],this.fogColor[1],this.fogColor[2],0),M.clear(M.COLOR_BUFFER_BIT|M.DEPTH_BUFFER_BIT),!(y.zoom<y.minZoom||y.zoom>y.maxZoom))){var e=this.getViewQuad();Se.updateView(e);var t=[y.width,y.height];Be.effects.shadows?(Be.cameraGBuffer.render(this.viewMatrix,this.projMatrix,t,!0),Be.sunGBuffer.render(Se.viewMatrix,Se.projMatrix),Be.AmbientMap.render(Be.cameraGBuffer.getDepthTexture(),Be.cameraGBuffer.getFogNormalTexture(),t,2),Be.blurredAmbientMap.render(Be.AmbientMap.framebuffer.renderTexture,t),Be.Buildings.render(Be.sunGBuffer.framebuffer,.5),Be.Basemap.render(),Be.effects.outlines&&(Be.Picking.render(t),Be.OutlineMap.render(Be.cameraGBuffer.getDepthTexture(),Be.cameraGBuffer.getFogNormalTexture(),Be.Picking.framebuffer.renderTexture,t,1),Be.blurredOutlineMap.render(Be.OutlineMap.framebuffer.renderTexture,t)),M.enable(M.BLEND),M.blendFuncSeparate(M.ZERO,M.SRC_COLOR,M.ZERO,M.ONE),Be.effects.outlines&&Be.Overlay.render(Be.blurredOutlineMap.framebuffer.renderTexture,t),Be.MapShadows.render(Se,Be.sunGBuffer.framebuffer,.5),Be.Overlay.render(Be.blurredAmbientMap.framebuffer.renderTexture,t),M.blendFuncSeparate(M.ONE_MINUS_DST_ALPHA,M.DST_ALPHA,M.ONE,M.ONE),M.disable(M.DEPTH_TEST),M.enable(M.DEPTH_TEST),M.disable(M.BLEND)):(Be.Buildings.render(),Be.Basemap.render(),Be.effects.outlines&&(Be.cameraGBuffer.render(this.viewMatrix,this.projMatrix,t,!0),Be.Picking.render(t),Be.OutlineMap.render(Be.cameraGBuffer.getDepthTexture(),Be.cameraGBuffer.getFogNormalTexture(),Be.Picking.framebuffer.renderTexture,t,1),Be.blurredOutlineMap.render(Be.OutlineMap.framebuffer.renderTexture,t)),M.enable(M.BLEND),Be.effects.outlines&&(M.blendFuncSeparate(M.ZERO,M.SRC_COLOR,M.ZERO,M.ONE),Be.Overlay.render(Be.blurredOutlineMap.framebuffer.renderTexture,t)),M.blendFuncSeparate(M.ONE_MINUS_DST_ALPHA,M.DST_ALPHA,M.ONE,M.ONE),M.disable(M.DEPTH_TEST),M.disable(M.BLEND),M.enable(M.DEPTH_TEST)),this.screenshotCallback&&(this.screenshotCallback(M.canvas.toDataURL()),this.screenshotCallback=null)}},onChange:function(){var e=1.3567*Math.pow(2,y.zoom-17),t=y.width,i=y.height;M.viewport(0,0,t,i),this.viewMatrix=(new c.Matrix).rotateZ(y.rotation).rotateX(y.tilt).translate(0,8/e,0).translate(0,0,-1220/e),this.viewDirOnMap=[Math.sin(y.rotation/180*Math.PI),-Math.cos(y.rotation/180*Math.PI)];var r=1024/(2*Math.tan(.125*Math.PI)),n=2*Math.atan(i/2/r)/Math.PI*180;if(this.projMatrix=(new c.Matrix).translate(0,-i/(2*e),0).scale(1,-1,1).multiply(new c.Matrix.Perspective(n,t/i,1,7500)).translate(0,-1,0),this.viewProjMatrix=new c.Matrix(c.Matrix.multiply(this.viewMatrix,this.projMatrix)),this.lowerLeftOnMap=oe(-1,-1,c.Matrix.invert(this.viewProjMatrix.data)),void 0!==this.lowerLeftOnMap){var o=ve(this.lowerLeftOnMap);this.fogDistance=Math.max(3e3,o),this.fogBlurDistance=500}},onResize:function(){M.canvas.width=y.width,M.canvas.height=y.height,this.onChange()},destroy:function(){y.off("change",this._onChange),y.off("resize",this._onResize),Be.Picking.destroy(),Be.Buildings.destroy(),Be.Basemap.destroy(),Be.cameraGBuffer&&Be.cameraGBuffer.destroy(),Be.sunGBuffer&&Be.sunGBuffer.destroy(),Be.AmbientMap.destroy(),Be.blurredAmbientMap.destroy(),Be.blurredOutlineMap.destroy()}};Be.Picking={idMapping:[null],viewportSize:512,init:function(){this.shader=new c.Shader({vertexShader:i.vertex,fragmentShader:i.fragment,shaderName:"picking shader",attributes:["aPosition","aId","aFilter"],uniforms:["uModelMatrix","uMatrix","uFogRadius","uTime"]}),this.framebuffer=new c.Framebuffer(this.viewportSize,this.viewportSize)},render:function(e){var t=this.shader,i=this.framebuffer;i.setSize(e[0],e[1]),t.enable(),i.enable(),M.viewport(0,0,e[0],e[1]),M.clearColor(0,0,0,1),M.clear(M.COLOR_BUFFER_BIT|M.DEPTH_BUFFER_BIT),t.setUniforms([["uFogRadius","1f",Be.fogDistance],["uTime","1f",J.getTime()]]);for(var r,n,o=K.Index.items,a=0,s=o.length;a<s;a++)r=o[a],y.zoom<r.minZoom||y.zoom>r.maxZoom||(n=r.getMatrix())&&(t.setUniformMatrices([["uModelMatrix","4fv",n.data],["uMatrix","4fv",c.Matrix.multiply(n,Be.viewProjMatrix)]]),t.bindBuffer(r.vertexBuffer,"aPosition"),t.bindBuffer(r.idBuffer,"aId"),t.bindBuffer(r.filterBuffer,"aFilter"),M.drawArrays(M.TRIANGLES,0,r.vertexBuffer.numItems));this.shader.disable(),this.framebuffer.disable(),M.viewport(0,0,y.width,y.height)},getTarget:function(e,t,i){requestAnimationFrame(function(){this.render([this.viewportSize,this.viewportSize]),e=e/y.width*this.viewportSize<<0,t=t/y.height*this.viewportSize<<0,this.framebuffer.enable();var r=this.framebuffer.getPixel(e,this.viewportSize-1-t);if(this.framebuffer.disable(),void 0!==r){var n=r[0]|r[1]<<8|r[2]<<16;i(this.idMapping[n])}else i(void 0)}.bind(this))},idToColor:function(e){var t=this.idMapping.indexOf(e);return-1===t&&(this.idMapping.push(e),t=this.idMapping.length-1),[(255&t)/255,(t>>8&255)/255,(t>>16&255)/255]},destroy:function(){}};var Se={setDate:function(e){var i=t(e,y.position.latitude,y.position.longitude);this.direction=[-Math.sin(i.azimuth)*Math.cos(i.altitude),Math.cos(i.azimuth)*Math.cos(i.altitude),Math.sin(i.altitude)];var r=i.azimuth/(Math.PI/180),n=90-i.altitude/(Math.PI/180);this.viewMatrix=(new c.Matrix).rotateZ(r).rotateX(n).translate(0,0,-5e3).scale(1,-1,1)},updateView:function(e){this.projMatrix=function(e,t,i,r,n){for(var o=ne(t.data,e[0]),a=o[0],s=o[0],u=o[1],f=o[1],l=0;l<e.length;l++){var h=ne(t.data,e[l]);a=Math.min(a,h[0]),s=Math.max(s,h[0]),u=Math.max(u,h[1]),f=Math.min(f,h[1])}return new c.Matrix.Ortho(a,s,u,f,i,r)}(Y(e,0).concat(Y(e,100)),this.viewMatrix,1e3,7500),this.viewProjMatrix=new c.Matrix(c.Matrix.multiply(this.viewMatrix,this.projMatrix))}};Be.Buildings={init:function(){this.shader=Be.effects.shadows?new c.Shader({vertexShader:n.vertex,fragmentShader:n.fragment,shaderName:"quality building shader",attributes:["aPosition","aTexCoord","aColor","aFilter","aNormal","aId","aHeight"],uniforms:["uFogDistance","uFogBlurDistance","uHighlightColor","uHighlightId","uLightColor","uLightDirection","uLowerEdgePoint","uMatrix","uModelMatrix","uSunMatrix","uShadowTexIndex","uShadowTexDimensions","uTime","uViewDirOnMap","uWallTexIndex"]}):new c.Shader({vertexShader:r.vertex,fragmentShader:r.fragment,shaderName:"building shader",attributes:["aPosition","aTexCoord","aColor","aFilter","aNormal","aId","aHeight"],uniforms:["uModelMatrix","uViewDirOnMap","uMatrix","uNormalTransform","uLightColor","uLightDirection","uLowerEdgePoint","uFogDistance","uFogBlurDistance","uHighlightColor","uHighlightId","uTime","uWallTexIndex"]}),this.wallTexture=new c.texture.Image,this.wallTexture.color([1,1,1]),this.wallTexture.load("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABAAQMAAACQp+OdAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3wwCCAUQLpaUSQAAABl0RVh0Q29tbWVudABDcmVhdGVkIHdpdGggR0lNUFeBDhcAAAAGUExURebm5v///zFES9kAAAAcSURBVCjPY/gPBQyUMh4wAAH/KAPCoFaoDnYGAAKtZsamTRFlAAAAAElFTkSuQmCC")},render:function(e){var t=this.shader;t.enable(),this.showBackfaces&&M.disable(M.CULL_FACE),t.setUniforms([["uFogDistance","1f",Be.fogDistance],["uFogBlurDistance","1f",Be.fogBlurDistance],["uHighlightColor","3fv",this.highlightColor||[0,0,0]],["uHighlightId","3fv",this.highlightId||[0,0,0]],["uLightColor","3fv",[.5,.5,.5]],["uLightDirection","3fv",Se.direction],["uLowerEdgePoint","2fv",Be.lowerLeftOnMap],["uTime","1f",J.getTime()],["uViewDirOnMap","2fv",Be.viewDirOnMap]]),Be.effects.shadows||t.setUniformMatrix("uNormalTransform","3fv",c.Matrix.identity3().data),t.bindTexture("uWallTexIndex",0,this.wallTexture),e&&(t.setUniform("uShadowTexDimensions","2fv",[e.width,e.height]),t.bindTexture("uShadowTexIndex",1,e.depthTexture));for(var i,r,n=K.Index.items,o=0,a=n.length;o<a;o++)i=n[o],y.zoom<i.minZoom||y.zoom>i.maxZoom||!(r=i.getMatrix())||(t.setUniformMatrices([["uModelMatrix","4fv",r.data],["uMatrix","4fv",c.Matrix.multiply(r,Be.viewProjMatrix)]]),Be.effects.shadows&&t.setUniformMatrix("uSunMatrix","4fv",c.Matrix.multiply(r,Se.viewProjMatrix)),t.bindBuffer(i.vertexBuffer,"aPosition"),t.bindBuffer(i.texCoordBuffer,"aTexCoord"),t.bindBuffer(i.normalBuffer,"aNormal"),t.bindBuffer(i.colorBuffer,"aColor"),t.bindBuffer(i.idBuffer,"aId"),t.bindBuffer(i.filterBuffer,"aFilter"),t.bindBuffer(i.heightBuffer,"aHeight"),M.drawArrays(M.TRIANGLES,0,i.vertexBuffer.numItems));this.showBackfaces&&M.enable(M.CULL_FACE),t.disable()},destroy:function(){}},Be.MapShadows={init:function(){this.shader=new c.Shader({vertexShader:h.vertex,fragmentShader:h.fragment,shaderName:"map shadows shader",attributes:["aPosition","aNormal"],uniforms:["uModelMatrix","uViewDirOnMap","uMatrix","uDirToSun","uLowerEdgePoint","uFogDistance","uFogBlurDistance","uShadowTexDimensions","uShadowStrength","uShadowTexIndex","uSunMatrix"]}),this.mapPlane=new $.MapPlane},render:function(e,t,i){var r=this.shader;r.enable(),M.disable(M.CULL_FACE),r.setUniforms([["uDirToSun","3fv",e.direction],["uViewDirOnMap","2fv",Be.viewDirOnMap],["uLowerEdgePoint","2fv",Be.lowerLeftOnMap],["uFogDistance","1f",Be.fogDistance],["uFogBlurDistance","1f",Be.fogBlurDistance],["uShadowTexDimensions","2fv",[t.width,t.height]],["uShadowStrength","1f",i]]),r.bindTexture("uShadowTexIndex",0,t.depthTexture);var n,o=this.mapPlane;y.zoom<o.minZoom||y.zoom>o.maxZoom||(n=o.getMatrix())&&(r.setUniformMatrices([["uModelMatrix","4fv",n.data],["uMatrix","4fv",c.Matrix.multiply(n,Be.viewProjMatrix)],["uSunMatrix","4fv",c.Matrix.multiply(n,e.viewProjMatrix)]]),r.bindBuffer(o.vertexBuffer,"aPosition"),r.bindBuffer(o.normalBuffer,"aNormal"),M.drawArrays(M.TRIANGLES,0,o.vertexBuffer.numItems),r.disable())},destroy:function(){}},Be.Basemap={init:function(){this.shader=new c.Shader({vertexShader:o.vertex,fragmentShader:o.fragment,shaderName:"basemap shader",attributes:["aPosition","aTexCoord"],uniforms:["uModelMatrix","uMatrix","uTexIndex","uFogDistance","uFogBlurDistance","uLowerEdgePoint","uViewDirOnMap"]})},render:function(){var e=y.basemapGrid;if(e&&!(y.zoom<e.minZoom||y.zoom>e.maxZoom)){var t,i=this.shader,r=Math.round(y.zoom);for(var n in i.enable(),i.setUniforms([["uFogDistance","1f",Be.fogDistance],["uFogBlurDistance","1f",Be.fogBlurDistance],["uViewDirOnMap","2fv",Be.viewDirOnMap],["uLowerEdgePoint","2fv",Be.lowerLeftOnMap]]),e.visibleTiles)if((t=e.tiles[n])&&t.isReady)this.renderTile(t,i);else{var o=[t.x/2<<0,t.y/2<<0,r-1].join(",");if(e.tiles[o]&&e.tiles[o].isReady)this.renderTile(e.tiles[o],i);else for(var a=[[2*t.x,2*t.y,t.zoom+1].join(","),[2*t.x+1,2*t.y,t.zoom+1].join(","),[2*t.x,2*t.y+1,t.zoom+1].join(","),[2*t.x+1,2*t.y+1,t.zoom+1].join(",")],s=0;s<4;s++)e.tiles[a[s]]&&e.tiles[a[s]].isReady&&this.renderTile(e.tiles[a[s]],i)}i.disable()}},renderTile:function(e,t){var i=V*Math.cos(y.position.latitude/180*Math.PI),r=new c.Matrix;r.translate((e.longitude-y.position.longitude)*i,-(e.latitude-y.position.latitude)*V,0),M.enable(M.POLYGON_OFFSET_FILL),M.polygonOffset(25-e.zoom,25-e.zoom),t.setUniforms([["uViewDirOnMap","2fv",Be.viewDirOnMap],["uLowerEdgePoint","2fv",Be.lowerLeftOnMap]]),t.setUniformMatrices([["uModelMatrix","4fv",r.data],["uMatrix","4fv",c.Matrix.multiply(r,Be.viewProjMatrix)]]),t.bindBuffer(e.vertexBuffer,"aPosition"),t.bindBuffer(e.texCoordBuffer,"aTexCoord"),t.bindTexture("uTexIndex",0,e.texture),M.drawArrays(M.TRIANGLE_STRIP,0,e.vertexBuffer.numItems),M.disable(M.POLYGON_OFFSET_FILL)},destroy:function(){}},Be.HudRect={init:function(){var e=this.createGeometry();this.vertexBuffer=new c.Buffer(3,new Float32Array(e.vertices)),this.texCoordBuffer=new c.Buffer(2,new Float32Array(e.texCoords)),this.shader=new c.Shader({vertexShader:s.vertex,fragmentShader:s.fragment,shaderName:"HUD rectangle shader",attributes:["aPosition","aTexCoord"],uniforms:["uMatrix","uTexIndex"]})},createGeometry:function(){var e=[],t=[];return e.push(0,0,1e-5,1,0,1e-5,1,1,1e-5),e.push(0,0,1e-5,1,1,1e-5,0,1,1e-5),t.push(.5,.5,1,.5,1,1),t.push(.5,.5,1,1,.5,1),{vertices:e,texCoords:t}},render:function(e){var t=this.shader;t.enable(),M.uniformMatrix4fv(t.uniforms.uMatrix,!1,c.Matrix.identity().data),this.vertexBuffer.enable(),M.vertexAttribPointer(t.attributes.aPosition,this.vertexBuffer.itemSize,M.FLOAT,!1,0,0),this.texCoordBuffer.enable(),M.vertexAttribPointer(t.attributes.aTexCoord,this.texCoordBuffer.itemSize,M.FLOAT,!1,0,0),e.enable(0),M.uniform1i(t.uniforms.uTexIndex,0),M.drawArrays(M.TRIANGLES,0,this.vertexBuffer.numItems),t.disable()},destroy:function(){}},Be.DepthFogNormalMap=function(){this.shader=new c.Shader({vertexShader:u.vertex,fragmentShader:u.fragment,shaderName:"fog/normal shader",attributes:["aPosition","aFilter","aNormal"],uniforms:["uMatrix","uModelMatrix","uNormalMatrix","uTime","uFogDistance","uFogBlurDistance","uViewDirOnMap","uLowerEdgePoint"]}),this.framebuffer=new c.Framebuffer(128,128,!0),this.mapPlane=new $.MapPlane},Be.DepthFogNormalMap.prototype.getDepthTexture=function(){return this.framebuffer.depthTexture},Be.DepthFogNormalMap.prototype.getFogNormalTexture=function(){return this.framebuffer.renderTexture},Be.DepthFogNormalMap.prototype.render=function(e,t,i,r){var n,o,a=this.shader,s=this.framebuffer,u=new c.Matrix(c.Matrix.multiply(e,t));i=i||this.framebufferSize,s.setSize(i[0],i[1]),a.enable(),s.enable(),M.viewport(0,0,i[0],i[1]),M.clearColor(0,0,0,1),M.clear(M.COLOR_BUFFER_BIT|M.DEPTH_BUFFER_BIT),a.setUniform("uTime","1f",J.getTime());for(var f=K.Index.items.concat([this.mapPlane]),l=0;l<f.length;l++)n=f[l],y.zoom<n.minZoom||y.zoom>n.maxZoom||(o=n.getMatrix())&&(a.setUniforms([["uViewDirOnMap","2fv",Be.viewDirOnMap],["uLowerEdgePoint","2fv",Be.lowerLeftOnMap],["uFogDistance","1f",Be.fogDistance],["uFogBlurDistance","1f",Be.fogBlurDistance]]),a.setUniformMatrices([["uMatrix","4fv",c.Matrix.multiply(o,u)],["uModelMatrix","4fv",o.data],["uNormalMatrix","3fv",c.Matrix.transpose3(c.Matrix.invert3(c.Matrix.multiply(o,e)))]]),a.bindBuffer(n.vertexBuffer,"aPosition"),a.bindBuffer(n.normalBuffer,"aNormal"),a.bindBuffer(n.filterBuffer,"aFilter"),M.drawArrays(M.TRIANGLES,0,n.vertexBuffer.numItems));a.disable(),s.disable(),M.viewport(0,0,y.width,y.height)},Be.DepthFogNormalMap.prototype.destroy=function(){},Be.AmbientMap={init:function(){this.shader=new c.Shader({vertexShader:f.vertex,fragmentShader:f.fragment,shaderName:"SSAO shader",attributes:["aPosition","aTexCoord"],uniforms:["uInverseTexSize","uNearPlane","uFarPlane","uDepthTexIndex","uFogTexIndex","uEffectStrength"]}),this.framebuffer=new c.Framebuffer(128,128),this.vertexBuffer=new c.Buffer(3,new Float32Array([-1,-1,1e-5,1,-1,1e-5,1,1,1e-5,-1,-1,1e-5,1,1,1e-5,-1,1,1e-5])),this.texCoordBuffer=new c.Buffer(2,new Float32Array([0,0,1,0,1,1,0,0,1,1,0,1]))},render:function(e,t,i,r){var n=this.shader,o=this.framebuffer;void 0===r&&(r=1),o.setSize(i[0],i[1]),M.viewport(0,0,i[0],i[1]),n.enable(),o.enable(),M.clearColor(1,0,0,1),M.clear(M.COLOR_BUFFER_BIT|M.DEPTH_BUFFER_BIT),n.setUniforms([["uInverseTexSize","2fv",[1/i[0],1/i[1]]],["uEffectStrength","1f",r],["uNearPlane","1f",1],["uFarPlane","1f",7500]]),n.bindBuffer(this.vertexBuffer,"aPosition"),n.bindBuffer(this.texCoordBuffer,"aTexCoord"),n.bindTexture("uDepthTexIndex",0,e),n.bindTexture("uFogTexIndex",1,t),M.drawArrays(M.TRIANGLES,0,this.vertexBuffer.numItems),n.disable(),o.disable(),M.viewport(0,0,y.width,y.height)},destroy:function(){}},Be.Overlay={init:function(){var e=this.createGeometry();this.vertexBuffer=new c.Buffer(3,new Float32Array(e.vertices)),this.texCoordBuffer=new c.Buffer(2,new Float32Array(e.texCoords)),this.shader=new c.Shader({vertexShader:s.vertex,fragmentShader:s.fragment,shaderName:"overlay texture shader",attributes:["aPosition","aTexCoord"],uniforms:["uMatrix","uTexIndex"]})},createGeometry:function(){var e=[],t=[];return e.push(-1,-1,1e-5,1,-1,1e-5,1,1,1e-5),e.push(-1,-1,1e-5,1,1,1e-5,-1,1,1e-5),t.push(0,0,1,0,1,1),t.push(0,0,1,1,0,1),{vertices:e,texCoords:t}},render:function(e,t){var i=this.shader;i.enable(),M.disable(M.DEPTH_TEST),i.setUniformMatrix("uMatrix","4fv",c.Matrix.identity().data),i.bindBuffer(this.vertexBuffer,"aPosition"),i.bindBuffer(this.texCoordBuffer,"aTexCoord"),i.bindTexture("uTexIndex",0,e),M.drawArrays(M.TRIANGLES,0,this.vertexBuffer.numItems),M.enable(M.DEPTH_TEST),i.disable()},destroy:function(){}},Be.OutlineMap={init:function(){this.shader=new c.Shader({vertexShader:d.vertex,fragmentShader:d.fragment,shaderName:"outline map shader",attributes:["aPosition","aTexCoord"],uniforms:["uMatrix","uInverseTexSize","uNearPlane","uFarPlane","uDepthTexIndex","uFogNormalTexIndex","uIdTexIndex","uEffectStrength"]}),this.framebuffer=new c.Framebuffer(128,128),this.vertexBuffer=new c.Buffer(3,new Float32Array([-1,-1,1e-5,1,-1,1e-5,1,1,1e-5,-1,-1,1e-5,1,1,1e-5,-1,1,1e-5])),this.texCoordBuffer=new c.Buffer(2,new Float32Array([0,0,1,0,1,1,0,0,1,1,0,1]))},render:function(e,t,i,r,n){var o=this.shader,a=this.framebuffer;void 0===n&&(n=1),a.setSize(r[0],r[1]),M.viewport(0,0,r[0],r[1]),o.enable(),a.enable(),M.clearColor(1,0,0,1),M.clear(M.COLOR_BUFFER_BIT|M.DEPTH_BUFFER_BIT),M.uniformMatrix4fv(o.uniforms.uMatrix,!1,c.Matrix.identity().data),o.setUniforms([["uInverseTexSize","2fv",[1/r[0],1/r[1]]],["uEffectStrength","1f",n],["uNearPlane","1f",1],["uFarPlane","1f",7500]]),o.bindBuffer(this.vertexBuffer,"aPosition"),o.bindBuffer(this.texCoordBuffer,"aTexCoord"),o.bindTexture("uDepthTexIndex",0,e),o.bindTexture("uFogNormalTexIndex",1,t),o.bindTexture("uIdTexIndex",2,i),M.drawArrays(M.TRIANGLES,0,this.vertexBuffer.numItems),o.disable(),a.disable(),M.viewport(0,0,y.width,y.height)},destroy:function(){}},Be.Blur=function(){this.shader=new c.Shader({vertexShader:l.vertex,fragmentShader:l.fragment,shaderName:"blur shader",attributes:["aPosition","aTexCoord"],uniforms:["uInverseTexSize","uTexIndex"]}),this.framebuffer=new c.Framebuffer(128,128),this.vertexBuffer=new c.Buffer(3,new Float32Array([-1,-1,1e-5,1,-1,1e-5,1,1,1e-5,-1,-1,1e-5,1,1,1e-5,-1,1,1e-5])),this.texCoordBuffer=new c.Buffer(2,new Float32Array([0,0,1,0,1,1,0,0,1,1,0,1]))},Be.Blur.prototype.render=function(e,t){var i=this.shader,r=this.framebuffer;r.setSize(t[0],t[1]),M.viewport(0,0,t[0],t[1]),i.enable(),r.enable(),M.clearColor(1,0,0,1),M.clear(M.COLOR_BUFFER_BIT|M.DEPTH_BUFFER_BIT),i.setUniform("uInverseTexSize","2fv",[1/r.width,1/r.height]),i.bindBuffer(this.vertexBuffer,"aPosition"),i.bindBuffer(this.texCoordBuffer,"aTexCoord"),i.bindTexture("uTexIndex",0,e),M.drawArrays(M.TRIANGLES,0,this.vertexBuffer.numItems),i.disable(),r.disable(),M.viewport(0,0,y.width,y.height)},Be.Blur.prototype.destroy=function(){this.framebuffer&&this.framebuffer.destroy()};var De={Tile:function(e,t,i){this.x=e,this.y=t,this.latitude=me(t,i),this.longitude=ce(e,i),this.zoom=i,this.key=[e,t,i].join(",");var r=ue(this.latitude,i),n=[r,r,0,r,0,0,0,r,0,0,0,0];this.vertexBuffer=new c.Buffer(3,new Float32Array(n)),this.texCoordBuffer=new c.Buffer(2,new Float32Array([1,0,1,1,0,0,0,1]))}};De.Tile.prototype={load:function(e){N.setBusy(),this.texture=(new c.texture.Image).load(e,function(e){N.setIdle(),e&&(this.isReady=!0,M.bindTexture(M.TEXTURE_2D,this.texture.id),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_WRAP_S,M.CLAMP_TO_EDGE),M.texParameteri(M.TEXTURE_2D,M.TEXTURE_WRAP_T,M.CLAMP_TO_EDGE))}.bind(this))},destroy:function(){this.vertexBuffer.destroy(),this.texCoordBuffer.destroy(),this.texture&&this.texture.destroy()}}}();
//# sourceMappingURL=OSMBuildings.js.map