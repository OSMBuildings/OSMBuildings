!function(){var e=function(){var e={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgrey:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkslategrey:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgray:"#d3d3d3",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370db",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#db7093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",slategrey:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};function t(e,t,r){return r<0&&(r+=1),r>1&&(r-=1),r<1/6?e+6*(t-e)*r:r<.5?t:r<2/3?e+(t-e)*(2/3-r)*6:e}function r(e,t){if(void 0!==e)return Math.min(t,Math.max(0,e||0))}var i=function(e,t,i,n){this.r=r(e,1),this.g=r(t,1),this.b=r(i,1),this.a=r(n,1)||1};return i.parse=function(t){if("string"==typeof t){var r;if(t=t.toLowerCase(),r=(t=e[t]||t).match(/^#?(\w{2})(\w{2})(\w{2})$/))return new i(parseInt(r[1],16)/255,parseInt(r[2],16)/255,parseInt(r[3],16)/255);if(r=t.match(/^#?(\w)(\w)(\w)$/))return new i(parseInt(r[1]+r[1],16)/255,parseInt(r[2]+r[2],16)/255,parseInt(r[3]+r[3],16)/255);if(r=t.match(/rgba?\((\d+)\D+(\d+)\D+(\d+)(\D+([\d.]+))?\)/))return new i(parseFloat(r[1])/255,parseFloat(r[2])/255,parseFloat(r[3])/255,r[4]?parseFloat(r[5]):1)}return new i},i.fromHSL=function(e,t,r){var n=(new i).fromHSL(e,t,r);return n.a=a,n},i.prototype={isValid:function(){return void 0!==this.r&&void 0!==this.g&&void 0!==this.b},toHSL:function(){if(this.isValid()){var e,t,r=Math.max(this.r,this.g,this.b),i=Math.min(this.r,this.g,this.b),n=(r+i)/2,o=r-i;if(o){switch(t=n>.5?o/(2-r-i):o/(r+i),r){case this.r:e=(this.g-this.b)/o+(this.g<this.b?6:0);break;case this.g:e=(this.b-this.r)/o+2;break;case this.b:e=(this.r-this.g)/o+4}e*=60}else e=t=0;return{h:e,s:t,l:n}}},fromHSL:function(e,r,i){if(0===r)return this.r=this.g=this.b=i,this;var n=i<.5?i*(1+r):i+r-i*r,o=2*i-n;return e/=360,this.r=t(o,n,e+1/3),this.g=t(o,n,e),this.b=t(o,n,e-1/3),this},toString:function(){if(this.isValid())return 1===this.a?"#"+((1<<24)+(Math.round(255*this.r)<<16)+(Math.round(255*this.g)<<8)+Math.round(255*this.b)).toString(16).slice(1,7):"rgba("+[Math.round(255*this.r),Math.round(255*this.g),Math.round(255*this.b),this.a.toFixed(2)].join(",")+")"},toArray:function(){if(this.isValid)return[this.r,this.g,this.b]},hue:function(e){var t=this.toHSL();return this.fromHSL(t.h+e,t.s,t.l)},saturation:function(e){var t=this.toHSL();return this.fromHSL(t.h,t.s*e,t.l)},lightness:function(e){var t=this.toHSL();return this.fromHSL(t.h,t.s,t.l*e)},clone:function(){return new i(this.r,this.g,this.b,this.a)}},i}();"object"==typeof module&&(module.exports=e);var t=function(){"use strict";var e=Math.PI,t=Math.sin,r=Math.cos,i=Math.tan,n=Math.asin,o=Math.atan2,a=e/180,s=864e5,u=2440588,h=2451545;function l(e){return function(e){return e.valueOf()/s-.5+u}(e)-h}var f=23.4397*a;function d(s){var u,h,l=function(r){return r+a*(1.9148*t(r)+.02*t(2*r)+3e-4*t(3*r))+102.9372*a+e}(function(e){return a*(357.5291+.98560028*e)}(s));return{dec:(u=l,h=0,n(t(h)*r(f)+r(h)*t(f)*t(u))),ra:function(e,n){return o(t(e)*r(f)-i(n)*t(f),r(e))}(l,0)}}return function(e,s,u){var h=a*-u,f=a*s,c=l(e),m=d(c),g=function(e,t){return a*(280.16+360.9856235*e)-t}(c,h)-m.ra;return{azimuth:function(e,n,a){return o(t(e),r(e)*t(n)-i(a)*r(n))}(g,f,m.dec),altitude:function(e,i,o){return n(t(i)*t(o)+r(i)*r(o)*r(e))}(g,f,m.dec)}}}();const r={picking:{vertex:"precision highp float; //is default in vertex shaders anyway, using highp fixes #49\n#define halfPi 1.57079632679\nattribute vec4 aPosition;\nattribute vec3 aPickingColor;\nattribute float aZScale;\nuniform mat4 uModelMatrix;\nuniform mat4 uMatrix;\nuniform float uFogDistance;\nuniform float uFade;\nuniform float uIndex;\nvarying vec4 vColor;\nvoid main() {\nfloat f = clamp(uFade*aZScale, 0.0, 1.0);\nif (f == 0.0) {\ngl_Position = vec4(0.0, 0.0, 0.0, 0.0);\nvColor = vec4(0.0, 0.0, 0.0, 0.0);\n} else {\nvec4 pos = vec4(aPosition.x, aPosition.y, aPosition.z*f, aPosition.w);\ngl_Position = uMatrix * pos;\nvec4 mPosition = vec4(uModelMatrix * pos);\nfloat distance = length(mPosition);\nif (distance > uFogDistance) {\nvColor = vec4(0.0, 0.0, 0.0, 0.0);\n} else {\nvColor = vec4(clamp(uIndex, 0.0, 1.0), aPickingColor.g, aPickingColor.b, 1.0);\n}\n}\n}\n",fragment:"#ifdef GL_ES\nprecision mediump float;\n#endif\nvarying vec4 vColor;\nvoid main() {\ngl_FragColor = vColor;\n}\n"},buildings:{vertex:"precision highp float; //is default in vertex shaders anyway, using highp fixes #49\n#define halfPi 1.57079632679\nattribute vec4 aPosition;\nattribute vec2 aTexCoord;\nattribute vec3 aNormal;\nattribute vec3 aColor;\nattribute float aHeight;\nattribute vec4 aTintColor;\nattribute float aZScale;\nuniform mat4 uModelMatrix;\nuniform mat4 uMatrix;\nuniform mat3 uNormalTransform;\nuniform vec3 uLightDirection;\nuniform vec3 uLightColor;\nuniform vec2 uViewDirOnMap;\nuniform vec2 uLowerEdgePoint;\nuniform float uFade;\nvarying vec3 vColor;\nvarying vec2 vTexCoord;\nvarying float verticalDistanceToLowerEdge;\nconst float gradientStrength = 0.4;\nvoid main() {\nfloat f = clamp(uFade*aZScale, 0.0, 1.0);\nif (f == 0.0) {\ngl_Position = vec4(0.0, 0.0, 0.0, 0.0);\nvColor = vec3(0.0, 0.0, 0.0);\n} else {\nvec4 pos = vec4(aPosition.x, aPosition.y, aPosition.z*f, aPosition.w);\ngl_Position = uMatrix * pos;\nvec3 color = aColor;\n// tint ***********************************************\nif (aTintColor.a > 0.0) {\ncolor = mix(aColor, aTintColor.rgb, 0.5);\n}\n//*** light intensity, defined by light direction on surface ****************\nvec3 transformedNormal = aNormal * uNormalTransform;\nfloat lightIntensity = max( dot(transformedNormal, uLightDirection), 0.0) / 1.5;\ncolor = color + uLightColor * lightIntensity;\nvTexCoord = aTexCoord;\n//*** vertical shading ******************************************************\nfloat verticalShading = clamp(gradientStrength - ((pos.z*gradientStrength) / (aHeight * f)), 0.0, gradientStrength);\n//***************************************************************************\nvColor = color-verticalShading;\nvec4 worldPos = uModelMatrix * pos;\nvec2 dirFromLowerEdge = worldPos.xy / worldPos.w - uLowerEdgePoint;\nverticalDistanceToLowerEdge = dot(dirFromLowerEdge, uViewDirOnMap);\n}\n}\n",fragment:"#ifdef GL_ES\nprecision mediump float;\n#endif\nvarying vec3 vColor;\nvarying vec2 vTexCoord;\nvarying float verticalDistanceToLowerEdge;\nuniform vec3 uFogColor;\nuniform float uFogDistance;\nuniform float uFogBlurDistance;\nuniform sampler2D uWallTexIndex;\nvoid main() {\n\nfloat fogIntensity = (verticalDistanceToLowerEdge - uFogDistance) / uFogBlurDistance;\nfogIntensity = clamp(fogIntensity, 0.0, 1.0);\ngl_FragColor = vec4( vColor* texture2D(uWallTexIndex, vTexCoord).rgb, 1.0-fogIntensity);\n}\n"},buildings_with_shadows:{vertex:"precision highp float; //is default in vertex shaders anyway, using highp fixes #49\n#define halfPi 1.57079632679\nattribute vec4 aPosition;\nattribute vec3 aNormal;\nattribute vec3 aColor;\nattribute vec2 aTexCoord;\nattribute float aHeight;\nattribute vec4 aTintColor;\nattribute float aZScale;\nuniform mat4 uModelMatrix;\nuniform mat4 uMatrix;\nuniform mat4 uSunMatrix;\nuniform mat3 uNormalTransform;\nuniform vec2 uViewDirOnMap;\nuniform vec2 uLowerEdgePoint;\nuniform float uFade;\nvarying vec3 vColor;\nvarying vec2 vTexCoord;\nvarying vec3 vNormal;\nvarying vec3 vSunRelPosition;\nvarying float verticalDistanceToLowerEdge;\nfloat gradientStrength = 0.4;\nvoid main() {\nfloat f = clamp(uFade*aZScale, 0.0, 1.0);\nif (f == 0.0) {\ngl_Position = vec4(0.0, 0.0, 0.0, 0.0);\nvColor = vec3(0.0, 0.0, 0.0);\n} else {\nvec4 pos = vec4(aPosition.x, aPosition.y, aPosition.z*f, aPosition.w);\ngl_Position = uMatrix * pos;\nvec3 color = aColor;\n// tint ***********************************************\nif (aTintColor.a > 0.0) {\ncolor = mix(aColor, aTintColor.rgb, 0.5);\n}\n//*** light intensity, defined by light direction on surface ****************\nvNormal = aNormal;\nvTexCoord = aTexCoord;\n//vec3 transformedNormal = aNormal * uNormalTransform;\n//float lightIntensity = max( dot(aNormal, uLightDirection), 0.0) / 1.5;\n//color = color + uLightColor * lightIntensity;\n//*** vertical shading ******************************************************\nfloat verticalShading = clamp(gradientStrength - ((pos.z*gradientStrength) / (aHeight * f)), 0.0, gradientStrength);\n//***************************************************************************\nvColor = color-verticalShading;\nvec4 worldPos = uModelMatrix * pos;\nvec2 dirFromLowerEdge = worldPos.xy / worldPos.w - uLowerEdgePoint;\nverticalDistanceToLowerEdge = dot(dirFromLowerEdge, uViewDirOnMap);\n// *** shadow mapping ********\nvec4 sunRelPosition = uSunMatrix * pos;\nvSunRelPosition = (sunRelPosition.xyz / sunRelPosition.w + 1.0) / 2.0;\n}\n}\n",fragment:"\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nprecision highp float;\n#else\nprecision mediump float;\n#endif\nvarying vec2 vTexCoord;\nvarying vec3 vColor;\nvarying vec3 vNormal;\nvarying vec3 vSunRelPosition;\nvarying float verticalDistanceToLowerEdge;\nuniform vec3 uFogColor;\nuniform vec2 uShadowTexDimensions;\nuniform sampler2D uShadowTexIndex;\nuniform sampler2D uWallTexIndex;\nuniform float uFogDistance;\nuniform float uFogBlurDistance;\nuniform float uShadowStrength;\nuniform vec3 uLightDirection;\nuniform vec3 uLightColor;\nfloat isSeenBySun(const vec2 sunViewNDC, const float depth, const float bias) {\nif ( clamp( sunViewNDC, 0.0, 1.0) != sunViewNDC) //not inside sun's viewport\nreturn 1.0;\n\nfloat depthFromTexture = texture2D( uShadowTexIndex, sunViewNDC.xy).x;\n\n//compare depth values not in reciprocal but in linear depth\nreturn step(1.0/depthFromTexture, 1.0/depth + bias);\n}\nvoid main() {\nvec3 normal = normalize(vNormal); //may degenerate during per-pixel interpolation\nfloat diffuse = dot(uLightDirection, normal);\ndiffuse = max(diffuse, 0.0);\n// reduce shadow strength with:\n// - lowering sun positions, to be consistent with the shadows on the basemap (there,\n// shadows are faded out with lowering sun positions to hide shadow artifacts caused\n// when sun direction and map surface are almost perpendicular\n// - large angles between the sun direction and the surface normal, to hide shadow\n// artifacts that occur when surface normal and sun direction are almost perpendicular\nfloat shadowStrength = pow( max( min(\ndot(uLightDirection, vec3(0.0, 0.0, 1.0)),\ndot(uLightDirection, normal)\n), 0.0), 1.5);\nif (diffuse > 0.0 && shadowStrength > 0.0) {\n// note: the diffuse term is also the cosine between the surface normal and the\n// light direction\nfloat bias = clamp(0.0007*tan(acos(diffuse)), 0.0, 0.01);\nvec2 pos = fract( vSunRelPosition.xy * uShadowTexDimensions);\n\nvec2 tl = floor(vSunRelPosition.xy * uShadowTexDimensions) / uShadowTexDimensions;\nfloat tlVal = isSeenBySun( tl, vSunRelPosition.z, bias);\nfloat trVal = isSeenBySun( tl + vec2(1.0, 0.0) / uShadowTexDimensions, vSunRelPosition.z, bias);\nfloat blVal = isSeenBySun( tl + vec2(0.0, 1.0) / uShadowTexDimensions, vSunRelPosition.z, bias);\nfloat brVal = isSeenBySun( tl + vec2(1.0, 1.0) / uShadowTexDimensions, vSunRelPosition.z, bias);\nfloat occludedBySun = mix(\nmix(tlVal, trVal, pos.x),\nmix(blVal, brVal, pos.x),\npos.y);\ndiffuse *= 1.0 - (shadowStrength * (1.0 - occludedBySun));\n}\nvec3 color = vColor* texture2D( uWallTexIndex, vTexCoord.st).rgb +\n(diffuse/1.5) * uLightColor;\nfloat fogIntensity = (verticalDistanceToLowerEdge - uFogDistance) / uFogBlurDistance;\nfogIntensity = clamp(fogIntensity, 0.0, 1.0);\n//gl_FragColor = vec4( mix(color, uFogColor, fogIntensity), 1.0);\ngl_FragColor = vec4( color, 1.0-fogIntensity);\n}\n"},basemap:{vertex:"precision highp float; // is default in vertex shaders anyway, using highp fixes #49\n#define halfPi 1.57079632679\nattribute vec4 aPosition;\nattribute vec2 aTexCoord;\nuniform mat4 uViewMatrix;\nuniform mat4 uModelMatrix;\nuniform vec2 uViewDirOnMap;\nuniform vec2 uLowerEdgePoint;\nvarying vec2 vTexCoord;\nvarying float verticalDistanceToLowerEdge;\nvoid main() {\ngl_Position = uViewMatrix * aPosition;\nvTexCoord = aTexCoord;\nvec4 worldPos = uModelMatrix * aPosition;\nvec2 dirFromLowerEdge = worldPos.xy / worldPos.w - uLowerEdgePoint;\nverticalDistanceToLowerEdge = dot(dirFromLowerEdge, uViewDirOnMap);\n}\n",fragment:"#ifdef GL_ES\nprecision mediump float;\n#endif\nuniform sampler2D uTexIndex;\nuniform vec3 uFogColor;\nvarying vec2 vTexCoord;\nvarying float verticalDistanceToLowerEdge;\nuniform float uFogDistance;\nuniform float uFogBlurDistance;\nvoid main() {\nfloat fogIntensity = (verticalDistanceToLowerEdge - uFogDistance) / uFogBlurDistance;\nfogIntensity = clamp(fogIntensity, 0.0, 1.0);\ngl_FragColor = vec4(texture2D(uTexIndex, vec2(vTexCoord.x, 1.0-vTexCoord.y)).rgb, 1.0-fogIntensity);\n}\n"},basemap_with_shadows:{vertex:"precision highp float; //is default in vertex shaders anyway, using highp fixes #49\nattribute vec3 aPosition;\nattribute vec3 aNormal;\nuniform mat4 uModelMatrix;\nuniform mat4 uMatrix;\nuniform mat4 uSunMatrix;\nuniform vec2 uViewDirOnMap;\nuniform vec2 uLowerEdgePoint;\n//varying vec2 vTexCoord;\nvarying vec3 vSunRelPosition;\nvarying vec3 vNormal;\nvarying float verticalDistanceToLowerEdge;\nvoid main() {\nvec4 pos = vec4(aPosition.xyz, 1.0);\ngl_Position = uMatrix * pos;\nvec4 sunRelPosition = uSunMatrix * pos;\nvSunRelPosition = (sunRelPosition.xyz / sunRelPosition.w + 1.0) / 2.0;\nvNormal = aNormal;\nvec4 worldPos = uModelMatrix * pos;\nvec2 dirFromLowerEdge = worldPos.xy / worldPos.w - uLowerEdgePoint;\nverticalDistanceToLowerEdge = dot(dirFromLowerEdge, uViewDirOnMap);\n}\n",fragment:"\n#ifdef GL_FRAGMENT_PRECISION_HIGH\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n/* This shader computes the diffuse brightness of the map layer. It does *not*\n* render the map texture itself, but is instead intended to be blended on top\n* of an already rendered map.\n* Note: this shader is not (and does not attempt to) be physically correct.\n* It is intented to be a blend between a useful illustration of cast\n* shadows and a mitigation of shadow casting artifacts occuring at\n* low angles on incidence.\n* Map brightness is only affected by shadows, not by light direction.\n* Shadows are darkest when light comes from straight above (and thus\n* shadows can be computed reliably) and become less and less visible\n* with the light source close to horizon (where moirC) and offset\n* artifacts would otherwise be visible).\n*/\n//uniform sampler2D uTexIndex;\nuniform sampler2D uShadowTexIndex;\nuniform vec3 uFogColor;\nuniform vec3 uDirToSun;\nuniform vec2 uShadowTexDimensions;\nuniform float uShadowStrength;\nvarying vec2 vTexCoord;\nvarying vec3 vSunRelPosition;\nvarying vec3 vNormal;\nvarying float verticalDistanceToLowerEdge;\nuniform float uFogDistance;\nuniform float uFogBlurDistance;\nfloat isSeenBySun( const vec2 sunViewNDC, const float depth, const float bias) {\nif ( clamp( sunViewNDC, 0.0, 1.0) != sunViewNDC) //not inside sun's viewport\nreturn 1.0;\n\nfloat depthFromTexture = texture2D( uShadowTexIndex, sunViewNDC.xy).x;\n\n//compare depth values not in reciprocal but in linear depth\nreturn step(1.0/depthFromTexture, 1.0/depth + bias);\n}\nvoid main() {\n//vec2 tl = floor(vSunRelPosition.xy * uShadowTexDimensions) / uShadowTexDimensions;\n//gl_FragColor = vec4(vec3(texture2D( uShadowTexIndex, tl).x), 1.0);\n//return;\nfloat diffuse = dot(uDirToSun, normalize(vNormal));\ndiffuse = max(diffuse, 0.0);\n\nfloat shadowStrength = uShadowStrength * pow(diffuse, 1.5);\nif (diffuse > 0.0) {\n// note: the diffuse term is also the cosine between the surface normal and the\n// light direction\nfloat bias = clamp(0.0007*tan(acos(diffuse)), 0.0, 0.01);\n\nvec2 pos = fract( vSunRelPosition.xy * uShadowTexDimensions);\n\nvec2 tl = floor(vSunRelPosition.xy * uShadowTexDimensions) / uShadowTexDimensions;\nfloat tlVal = isSeenBySun( tl, vSunRelPosition.z, bias);\nfloat trVal = isSeenBySun( tl + vec2(1.0, 0.0) / uShadowTexDimensions, vSunRelPosition.z, bias);\nfloat blVal = isSeenBySun( tl + vec2(0.0, 1.0) / uShadowTexDimensions, vSunRelPosition.z, bias);\nfloat brVal = isSeenBySun( tl + vec2(1.0, 1.0) / uShadowTexDimensions, vSunRelPosition.z, bias);\ndiffuse = mix( mix(tlVal, trVal, pos.x),\nmix(blVal, brVal, pos.x),\npos.y);\n}\ndiffuse = mix(1.0, diffuse, shadowStrength);\n\nfloat fogIntensity = (verticalDistanceToLowerEdge - uFogDistance) / uFogBlurDistance;\nfogIntensity = clamp(fogIntensity, 0.0, 1.0);\nfloat darkness = (1.0 - diffuse);\ndarkness *= (1.0 - fogIntensity);\ngl_FragColor = vec4(vec3(1.0 - darkness), 1.0);\n}\n"},texture:{vertex:"precision highp float; //is default in vertex shaders anyway, using highp fixes #49\nattribute vec4 aPosition;\nattribute vec2 aTexCoord;\nuniform mat4 uMatrix;\nvarying vec2 vTexCoord;\nvoid main() {\ngl_Position = uMatrix * aPosition;\nvTexCoord = aTexCoord;\n}\n",fragment:"#ifdef GL_ES\nprecision mediump float;\n#endif\nuniform sampler2D uTexIndex;\nvarying vec2 vTexCoord;\nvoid main() {\ngl_FragColor = vec4(texture2D(uTexIndex, vTexCoord.st).rgb, 1.0);\n}\n"},depth_normal:{vertex:"precision highp float; //is default in vertex shaders anyway, using highp fixes #49\nattribute vec4 aPosition;\nattribute vec3 aNormal;\nattribute float aZScale;\nuniform mat4 uMatrix;\nuniform mat4 uModelMatrix;\nuniform mat3 uNormalMatrix;\nuniform vec2 uViewDirOnMap;\nuniform vec2 uLowerEdgePoint;\nuniform float uFade;\nvarying float verticalDistanceToLowerEdge;\nvarying vec3 vNormal;\nvoid main() {\nfloat f = clamp(uFade*aZScale, 0.0, 1.0);\nif (f == 0.0) {\ngl_Position = vec4(0.0, 0.0, 0.0, 0.0);\nverticalDistanceToLowerEdge = 0.0;\n} else {\nvec4 pos = vec4(aPosition.x, aPosition.y, aPosition.z*f, aPosition.w);\ngl_Position = uMatrix * pos;\nvNormal = uNormalMatrix * aNormal;\nvec4 worldPos = uModelMatrix * pos;\nvec2 dirFromLowerEdge = worldPos.xy / worldPos.w - uLowerEdgePoint;\nverticalDistanceToLowerEdge = dot(dirFromLowerEdge, uViewDirOnMap);\n}\n}\n",fragment:"\n#ifdef GL_ES\nprecision mediump float;\n#endif\nuniform float uFogDistance;\nuniform float uFogBlurDistance;\nvarying float verticalDistanceToLowerEdge;\nvarying vec3 vNormal;\nvoid main() {\nfloat fogIntensity = (verticalDistanceToLowerEdge - uFogDistance) / uFogBlurDistance;\ngl_FragColor = vec4(normalize(vNormal) / 2.0 + 0.5, clamp(fogIntensity, 0.0, 1.0));\n}\n"},ambient_from_depth:{vertex:"precision highp float; //is default in vertex shaders anyway, using highp fixes #49\nattribute vec4 aPosition;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\nvoid main() {\ngl_Position = aPosition;\nvTexCoord = aTexCoord;\n}\n",fragment:"#ifdef GL_FRAGMENT_PRECISION_HIGH\n// we need high precision for the depth values\nprecision highp float;\n#else\nprecision mediump float;\n#endif\nuniform sampler2D uDepthTexIndex;\nuniform sampler2D uFogTexIndex;\nuniform vec2 uInverseTexSize; //in 1/pixels, e.g. 1/512 if the texture is 512px wide\nuniform float uEffectStrength;\nuniform float uNearPlane;\nuniform float uFarPlane;\nvarying vec2 vTexCoord;\n/* Retrieves the depth value 'offset' pixels away from 'pos' from texture 'uDepthTexIndex'. */\nfloat getDepth(vec2 pos, ivec2 offset)\n{\nfloat z = texture2D(uDepthTexIndex, pos + float(offset) * uInverseTexSize).x;\nreturn (2.0 * uNearPlane) / (uFarPlane + uNearPlane - z * (uFarPlane - uNearPlane)); // linearize depth\n}\n/* getOcclusionFactor() determines a heuristic factor (from [0..1]) for how\n* much the fragment at 'pos' with depth 'depthHere'is occluded by the\n* fragment that is (dx, dy) texels away from it.\n*/\nfloat getOcclusionFactor(float depthHere, vec2 pos, ivec2 offset) {\nfloat depthThere = getDepth(pos, offset);\n/* if the fragment at (dx, dy) has no depth (i.e. there was nothing rendered there),\n* then 'here' is not occluded (result 1.0) */\nif (depthThere == 0.0)\nreturn 1.0;\n/* if the fragment at (dx, dy) is further away from the viewer than 'here', then\n* 'here is not occluded' */\nif (depthHere < depthThere )\nreturn 1.0;\nfloat relDepthDiff = depthThere / depthHere;\nfloat depthDiff = abs(depthThere - depthHere) * uFarPlane;\n/* if the fragment at (dx, dy) is closer to the viewer than 'here', then it occludes\n* 'here'. The occlusion is the higher the bigger the depth difference between the two\n* locations is.\n* However, if the depth difference is too high, we assume that 'there' lies in a\n* completely different depth region of the scene than 'here' and thus cannot occlude\n* 'here'. This last assumption gets rid of very dark artifacts around tall buildings.\n*/\nreturn depthDiff < 50.0 ? mix(0.99, 1.0, 1.0 - clamp(depthDiff, 0.0, 1.0)) : 1.0;\n}\n/* This shader approximates the ambient occlusion in screen space (SSAO).\n* It is based on the assumption that a pixel will be occluded by neighboring\n* pixels iff. those have a depth value closer to the camera than the original\n* pixel itself (the function getOcclusionFactor() computes this occlusion\n* by a single other pixel).\n*\n* A naive approach would sample all pixels within a given distance. For an\n* interesting-looking effect, the sampling area needs to be at least 9 pixels\n* wide (-/+ 4), requiring 81 texture lookups per pixel for ambient occlusion.\n* This overburdens many GPUs.\n* To make the ambient occlusion computation faster, we do not consider all\n* texels in the sampling area, but only 16. This causes some sampling artifacts\n* that are later removed by blurring the ambient occlusion texture (this is\n* done in a separate shader).\n*/\nvoid main() {\nfloat depthHere = getDepth(vTexCoord, ivec2(0, 0));\nfloat fogIntensity = texture2D(uFogTexIndex, vTexCoord).w;\nif (depthHere == 0.0)\n{\n\t//there was nothing rendered 'here' --\x3e it can't be occluded\ngl_FragColor = vec4(1.0);\nreturn;\n}\nfloat occlusionFactor = 1.0;\nocclusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2(-1, 0));\nocclusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2(+1, 0));\nocclusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2( 0, -1));\nocclusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2( 0, +1));\nocclusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2(-2, -2));\nocclusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2(+2, +2));\nocclusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2(+2, -2));\nocclusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2(-2, +2));\nocclusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2(-4, 0));\nocclusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2(+4, 0));\nocclusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2( 0, -4));\nocclusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2( 0, +4));\nocclusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2(-4, -4));\nocclusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2(+4, +4));\nocclusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2(+4, -4));\nocclusionFactor *= getOcclusionFactor(depthHere, vTexCoord, ivec2(-4, +4));\nocclusionFactor = pow(occlusionFactor, 4.0) + 55.0/255.0; // empirical bias determined to let SSAO have no effect on the map plane\nocclusionFactor = 1.0 - ((1.0 - occlusionFactor) * uEffectStrength * (1.0-fogIntensity));\ngl_FragColor = vec4(vec3(occlusionFactor), 1.0);\n}\n"},flat_color:{vertex:"precision highp float; // is default in vertex shaders anyway, using highp fixes #49\nattribute vec4 aPosition;\nuniform mat4 uMatrix;\nvoid main() {\ngl_Position = uMatrix * aPosition;\n}\n",fragment:"#ifdef GL_ES\nprecision mediump float;\n#endif\nuniform vec4 uColor;\nvoid main() {\ngl_FragColor = uColor;\n}\n"},horizon:{vertex:"precision highp float; // is default in vertex shaders anyway, using highp fixes #49\n#define halfPi 1.57079632679\nattribute vec4 aPosition;\nuniform mat4 uMatrix;\nuniform float uAbsoluteHeight;\nvarying vec2 vTexCoord;\nvarying float vRelativeHeight;\nvoid main() {\ngl_Position = uMatrix * aPosition;\nvRelativeHeight = aPosition.z / uAbsoluteHeight;\n}\n",fragment:"#ifdef GL_ES\nprecision mediump float;\n#endif\nuniform vec3 uFogColor;\nvarying float vRelativeHeight;\nvoid main() {\nfloat blendFactor = min(100.0 * vRelativeHeight, 1.0);\nvec4 skyColor = vec4(0.9, 0.85, 1.0, 1.0);\ngl_FragColor = mix(vec4(uFogColor, 1.0), skyColor, blendFactor);\n}\n"},blur:{vertex:"precision highp float; // is default in vertex shaders anyway, using highp fixes #49\nattribute vec4 aPosition;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\nvoid main() {\ngl_Position = aPosition;\nvTexCoord = aTexCoord;\n}\n",fragment:"#ifdef GL_ES\nprecision mediump float;\n#endif\nuniform sampler2D uTexIndex;\nuniform vec2 uInverseTexSize; // as 1/n pixels, e.g. 1/512 if the texture is 512px wide\nvarying vec2 vTexCoord;\n// Retrieves the texel color 'offset' pixels away from 'pos' from texture 'uTexIndex'.\nvec4 getTexel(vec2 pos, vec2 offset) {\nreturn texture2D(uTexIndex, pos + offset * uInverseTexSize);\n}\nvoid main() {\nvec4 center = texture2D(uTexIndex, vTexCoord);\nvec4 nonDiagonalNeighbors = getTexel(vTexCoord, vec2(-1.0, 0.0)) +\ngetTexel(vTexCoord, vec2(+1.0, 0.0)) +\ngetTexel(vTexCoord, vec2( 0.0, -1.0)) +\ngetTexel(vTexCoord, vec2( 0.0, +1.0));\nvec4 diagonalNeighbors = getTexel(vTexCoord, vec2(-1.0, -1.0)) +\ngetTexel(vTexCoord, vec2(+1.0, +1.0)) +\ngetTexel(vTexCoord, vec2(-1.0, +1.0)) +\ngetTexel(vTexCoord, vec2(+1.0, -1.0));\n\n// approximate Gaussian blur (mean 0.0, stdev 1.0)\ngl_FragColor = 0.2/1.0 * center +\n0.5/4.0 * nonDiagonalNeighbors +\n0.3/4.0 * diagonalNeighbors;\n}\n"},marker:{vertex:"precision highp float; // is default in vertex shaders anyway, using highp fixes #49\nattribute vec4 aPosition;\n// uniform mat4 uMatrix;\nuniform mat4 uProjMatrix;\nuniform mat4 uViewMatrix;\nuniform mat4 uModelMatrix;\nattribute vec2 aTexCoord;\nvarying vec2 vTexCoord;\nuniform float markerSize;\nvoid main() {\nmat4 modelView = uViewMatrix * uModelMatrix;\nmodelView[0][0] = 1.0;\nmodelView[0][1] = 0.0;\nmodelView[0][2] = 0.0;\nmodelView[1][0] = 0.0;\nmodelView[1][1] = 1.0;\nmodelView[1][2] = 0.0;\nmodelView[2][0] = 0.0;\nmodelView[2][1] = 0.0;\nmodelView[2][2] = 1.0;\nmat4 mvp = uProjMatrix * modelView;\nfloat reciprScaleOnscreen = 0.02;\nfloat w = (mvp * vec4(0,0,0,1)).w;\nw *= reciprScaleOnscreen;\n// marker size is needed for a new offset after scaling the marker\nvec4 pos = vec4((aPosition.x * w), (aPosition.y * w) - (markerSize/2.0*w), aPosition.z * w , 1);\ngl_Position = mvp * pos;\nvTexCoord = aTexCoord;\n}\n",fragment:"#ifdef GL_ES\nprecision mediump float;\n#endif\nuniform sampler2D uTexIndex;\nvarying vec2 vTexCoord;\nvoid main() {\ngl_FragColor = texture2D(uTexIndex, vTexCoord);\n}\n"}},i='class Request{static load(e,t){const r=new XMLHttpRequest,n=setTimeout(function(){4!==r.readyState&&(r.abort(),t("status"))},1e4);return r.onreadystatechange=(()=>{4===r.readyState&&(clearTimeout(n),!r.status||r.status<200||r.status>299?t("status"):t(null,r))}),r.open("GET",e),r.send(null),{abort:()=>{r.abort()}}}static getText(e,t){return this.load(e,(e,r)=>{e?t(e):void 0!==r.responseText?t(null,r.responseText):t("content")})}static getXML(e,t){return this.load(e,(e,r)=>{e?t(e):void 0!==r.responseXML?t(null,r.responseXML):t("content")})}static getJSON(e,t){return this.load(e,(r,n)=>{if(r)return void t(r);if(!n.responseText)return void t("content");let o;try{o=JSON.parse(n.responseText),t(null,o)}catch(r){console.warn(`Could not parse JSON from ${e}\\n${r.message}`),t("content")}})}}var Qolor=function(){var e={aliceblue:"#f0f8ff",antiquewhite:"#faebd7",aqua:"#00ffff",aquamarine:"#7fffd4",azure:"#f0ffff",beige:"#f5f5dc",bisque:"#ffe4c4",black:"#000000",blanchedalmond:"#ffebcd",blue:"#0000ff",blueviolet:"#8a2be2",brown:"#a52a2a",burlywood:"#deb887",cadetblue:"#5f9ea0",chartreuse:"#7fff00",chocolate:"#d2691e",coral:"#ff7f50",cornflowerblue:"#6495ed",cornsilk:"#fff8dc",crimson:"#dc143c",cyan:"#00ffff",darkblue:"#00008b",darkcyan:"#008b8b",darkgoldenrod:"#b8860b",darkgray:"#a9a9a9",darkgrey:"#a9a9a9",darkgreen:"#006400",darkkhaki:"#bdb76b",darkmagenta:"#8b008b",darkolivegreen:"#556b2f",darkorange:"#ff8c00",darkorchid:"#9932cc",darkred:"#8b0000",darksalmon:"#e9967a",darkseagreen:"#8fbc8f",darkslateblue:"#483d8b",darkslategray:"#2f4f4f",darkslategrey:"#2f4f4f",darkturquoise:"#00ced1",darkviolet:"#9400d3",deeppink:"#ff1493",deepskyblue:"#00bfff",dimgray:"#696969",dimgrey:"#696969",dodgerblue:"#1e90ff",firebrick:"#b22222",floralwhite:"#fffaf0",forestgreen:"#228b22",fuchsia:"#ff00ff",gainsboro:"#dcdcdc",ghostwhite:"#f8f8ff",gold:"#ffd700",goldenrod:"#daa520",gray:"#808080",grey:"#808080",green:"#008000",greenyellow:"#adff2f",honeydew:"#f0fff0",hotpink:"#ff69b4",indianred:"#cd5c5c",indigo:"#4b0082",ivory:"#fffff0",khaki:"#f0e68c",lavender:"#e6e6fa",lavenderblush:"#fff0f5",lawngreen:"#7cfc00",lemonchiffon:"#fffacd",lightblue:"#add8e6",lightcoral:"#f08080",lightcyan:"#e0ffff",lightgoldenrodyellow:"#fafad2",lightgray:"#d3d3d3",lightgrey:"#d3d3d3",lightgreen:"#90ee90",lightpink:"#ffb6c1",lightsalmon:"#ffa07a",lightseagreen:"#20b2aa",lightskyblue:"#87cefa",lightslategray:"#778899",lightslategrey:"#778899",lightsteelblue:"#b0c4de",lightyellow:"#ffffe0",lime:"#00ff00",limegreen:"#32cd32",linen:"#faf0e6",magenta:"#ff00ff",maroon:"#800000",mediumaquamarine:"#66cdaa",mediumblue:"#0000cd",mediumorchid:"#ba55d3",mediumpurple:"#9370db",mediumseagreen:"#3cb371",mediumslateblue:"#7b68ee",mediumspringgreen:"#00fa9a",mediumturquoise:"#48d1cc",mediumvioletred:"#c71585",midnightblue:"#191970",mintcream:"#f5fffa",mistyrose:"#ffe4e1",moccasin:"#ffe4b5",navajowhite:"#ffdead",navy:"#000080",oldlace:"#fdf5e6",olive:"#808000",olivedrab:"#6b8e23",orange:"#ffa500",orangered:"#ff4500",orchid:"#da70d6",palegoldenrod:"#eee8aa",palegreen:"#98fb98",paleturquoise:"#afeeee",palevioletred:"#db7093",papayawhip:"#ffefd5",peachpuff:"#ffdab9",peru:"#cd853f",pink:"#ffc0cb",plum:"#dda0dd",powderblue:"#b0e0e6",purple:"#800080",rebeccapurple:"#663399",red:"#ff0000",rosybrown:"#bc8f8f",royalblue:"#4169e1",saddlebrown:"#8b4513",salmon:"#fa8072",sandybrown:"#f4a460",seagreen:"#2e8b57",seashell:"#fff5ee",sienna:"#a0522d",silver:"#c0c0c0",skyblue:"#87ceeb",slateblue:"#6a5acd",slategray:"#708090",slategrey:"#708090",snow:"#fffafa",springgreen:"#00ff7f",steelblue:"#4682b4",tan:"#d2b48c",teal:"#008080",thistle:"#d8bfd8",tomato:"#ff6347",turquoise:"#40e0d0",violet:"#ee82ee",wheat:"#f5deb3",white:"#ffffff",whitesmoke:"#f5f5f5",yellow:"#ffff00",yellowgreen:"#9acd32"};function t(e,t,r){return r<0&&(r+=1),r>1&&(r-=1),r<1/6?e+6*(t-e)*r:r<.5?t:r<2/3?e+(t-e)*(2/3-r)*6:e}function r(e,t){if(void 0!==e)return Math.min(t,Math.max(0,e||0))}var n=function(e,t,n,o){this.r=r(e,1),this.g=r(t,1),this.b=r(n,1),this.a=r(o,1)||1};return n.parse=function(t){if("string"==typeof t){var r;if(t=t.toLowerCase(),r=(t=e[t]||t).match(/^#?(\\w{2})(\\w{2})(\\w{2})$/))return new n(parseInt(r[1],16)/255,parseInt(r[2],16)/255,parseInt(r[3],16)/255);if(r=t.match(/^#?(\\w)(\\w)(\\w)$/))return new n(parseInt(r[1]+r[1],16)/255,parseInt(r[2]+r[2],16)/255,parseInt(r[3]+r[3],16)/255);if(r=t.match(/rgba?\\((\\d+)\\D+(\\d+)\\D+(\\d+)(\\D+([\\d.]+))?\\)/))return new n(parseFloat(r[1])/255,parseFloat(r[2])/255,parseFloat(r[3])/255,r[4]?parseFloat(r[5]):1)}return new n},n.fromHSL=function(e,t,r){var o=(new n).fromHSL(e,t,r);return o.a=a,o},n.prototype={isValid:function(){return void 0!==this.r&&void 0!==this.g&&void 0!==this.b},toHSL:function(){if(this.isValid()){var e,t,r=Math.max(this.r,this.g,this.b),n=Math.min(this.r,this.g,this.b),o=(r+n)/2,a=r-n;if(a){switch(t=o>.5?a/(2-r-n):a/(r+n),r){case this.r:e=(this.g-this.b)/a+(this.g<this.b?6:0);break;case this.g:e=(this.b-this.r)/a+2;break;case this.b:e=(this.r-this.g)/a+4}e*=60}else e=t=0;return{h:e,s:t,l:o}}},fromHSL:function(e,r,n){if(0===r)return this.r=this.g=this.b=n,this;var o=n<.5?n*(1+r):n+r-n*r,a=2*n-o;return e/=360,this.r=t(a,o,e+1/3),this.g=t(a,o,e),this.b=t(a,o,e-1/3),this},toString:function(){if(this.isValid())return 1===this.a?"#"+((1<<24)+(Math.round(255*this.r)<<16)+(Math.round(255*this.g)<<8)+Math.round(255*this.b)).toString(16).slice(1,7):"rgba("+[Math.round(255*this.r),Math.round(255*this.g),Math.round(255*this.b),this.a.toFixed(2)].join(",")+")"},toArray:function(){if(this.isValid)return[this.r,this.g,this.b]},hue:function(e){var t=this.toHSL();return this.fromHSL(t.h+e,t.s,t.l)},saturation:function(e){var t=this.toHSL();return this.fromHSL(t.h,t.s*e,t.l)},lightness:function(e){var t=this.toHSL();return this.fromHSL(t.h,t.s,t.l*e)},clone:function(){return new n(this.r,this.g,this.b,this.a)}},n}();"object"==typeof module&&(module.exports=Qolor);class OBJ{constructor(e,t){this.materialIndex={},this.vertexIndex=[],t&&this.readMTL(t),this.meshes=[],this.readOBJ(e)}readMTL(e){let t,r=[];e.split(/[\\r\\n]/g).forEach(e=>{const n=e.trim().split(/\\s+/);switch(n[0]){case"newmtl":t&&(this.materialIndex[t]=r),t=n[1],r=[];break;case"Kd":r=[parseFloat(n[1]),parseFloat(n[2]),parseFloat(n[3])]}}),t&&(this.materialIndex[t]=r),e=null}readOBJ(e){let t,r,n=[];e.split(/[\\r\\n]/g).forEach(e=>{const o=e.trim().split(/\\s+/);switch(o[0]){case"g":case"o":this.storeMesh(t,r,n),t=o[1],n=[];break;case"usemtl":this.storeMesh(t,r,n),this.materialIndex[o[1]]&&(r=this.materialIndex[o[1]]),n=[];break;case"v":this.vertexIndex.push([parseFloat(o[1]),parseFloat(o[2]),parseFloat(o[3])]);break;case"f":n.push([parseFloat(o[1])-1,parseFloat(o[2])-1,parseFloat(o[3])-1])}}),this.storeMesh(t,r,n)}storeMesh(e,t,r){if(r.length){const n=this.createGeometry(r);this.meshes.push({...n,color:t,id:e})}}sub(e,t){return[e[0]-t[0],e[1]-t[1],e[2]-t[2]]}unit(e){const t=this.len(e);return[e[0]/t,e[1]/t,e[2]/t]}normal(e,t,r){const n=this.sub(e,t),o=this.sub(t,r);return this.unit([n[1]*o[2]-n[2]*o[1],n[2]*o[0]-n[0]*o[2],n[0]*o[1]-n[1]*o[0]])}createGeometry(e){const t=[],r=[],n=[];let o=-1/0;return e.forEach(e=>{const a=this.vertexIndex[e[0]],i=this.vertexIndex[e[1]],s=this.vertexIndex[e[2]],l=this.normal(a,i,s);t.push(a[0],a[2],a[1],i[0],i[2],i[1],s[0],s[2],s[1]),r.push(l[0],l[1],l[2],l[0],l[1],l[2],l[0],l[1],l[2]),n.push(0,0,0,0,0,0),o=Math.max(o,a[1],i[1],s[1])}),{vertices:t,normals:r,texCoords:n,height:o}}}OBJ.parse=function(e,t){return new OBJ(e,t).meshes};var createRoof,triangulate=function(){var e=10,t=[.8627450980392157,.8235294117647058,.7843137254901961];METERS_PER_LEVEL=3;var r={brick:"#cc7755",bronze:"#ffeecc",canvas:"#fff8f0",concrete:"#999999",copper:"#a0e0d0",glass:"#e8f8f8",gold:"#ffcc00",plants:"#009933",metal:"#aaaaaa",panel:"#fff8f0",plaster:"#999999",roof_tiles:"#f08060",silver:"#cccccc",slate:"#666666",stone:"#996666",tar_paper:"#333333",wood:"#deb887"},n={asphalt:"tar_paper",bitumen:"tar_paper",block:"stone",bricks:"brick",glas:"glass",glassfront:"glass",grass:"plants",masonry:"stone",granite:"stone",panels:"panel",paving_stones:"stone",plastered:"plaster",rooftiles:"roof_tiles",roofingfelt:"tar_paper",sandstone:"stone",sheet:"canvas",sheets:"canvas",shingle:"tar_paper",shingles:"tar_paper",slates:"slate",steel:"metal",tar:"tar_paper",tent:"canvas",thatch:"plants",tile:"roof_tiles",tiles:"roof_tiles"},o=.5,a=6378137*Math.PI/180;function i(e){return"string"!=typeof e?null:"#"===(e=e.toLowerCase())[0]?e:r[n[e]||e]||null}function s(e,r){r=r||0;var n,o=Qolor.parse(e);return[(n=o.isValid()?o.saturation(.7).toArray():t)[0]+r,n[1]+r,n[2]+r]}return function(t,r,n,l,f){var c=[a*Math.cos(n[1]/180*Math.PI),a];(function(e){switch(e.type){case"MultiPolygon":return e.coordinates;case"Polygon":return[e.coordinates];default:return[]}})(r.geometry).map(function(a){var u=function(e,t,r){return e.map(function(e,n){return 0===n!==function(e){return 0<e.reduce(function(e,t,r,n){return e+(r<n.length-1?(n[r+1][0]-t[0])*(n[r+1][1]+t[1]):0)},0)}(e)&&e.reverse(),e.map(function(e){return[(e[0]-t[0])*r[0],-(e[1]-t[1])*r[1]]})})}(a,n,c);!function(t,r,n,a,l){var f=function(t,r){var n,o={};switch(o.center=[r.minX+(r.maxX-r.minX)/2,r.minY+(r.maxY-r.minY)/2],o.radius=(r.maxX-r.minX)/2,o.roofHeight=t.roofHeight||(t.roofLevels?t.roofLevels*METERS_PER_LEVEL:0),t.roofShape){case"cone":case"pyramid":case"dome":case"onion":o.roofHeight=o.roofHeight||1*o.radius;break;case"gabled":case"hipped":case"half-hipped":case"skillion":case"gambrel":case"mansard":case"round":o.roofHeight=o.roofHeight||1*METERS_PER_LEVEL;break;case"flat":o.roofHeight=0;break;default:o.roofHeight=0}if(o.wallZ=t.minHeight||(t.minLevel?t.minLevel*METERS_PER_LEVEL:0),void 0!==t.height)n=t.height,o.roofHeight=Math.min(o.roofHeight,n),o.roofZ=n-o.roofHeight,o.wallHeight=n-o.roofHeight-o.wallZ;else if(void 0!==t.levels)n=t.levels*METERS_PER_LEVEL,o.roofZ=n,o.wallHeight=n-o.wallZ;else{switch(t.shape){case"cone":case"dome":case"pyramid":n=2*o.radius,o.roofHeight=0;break;case"sphere":n=4*o.radius,o.roofHeight=0;break;default:n=e}o.roofZ=n,o.wallHeight=n-o.wallZ}return o}(r,function(e){for(var t=1/0,r=1/0,n=-1/0,o=-1/0,a=0;a<e.length;a++)t=Math.min(t,e[a][0]),r=Math.min(r,e[a][1]),n=Math.max(n,e[a][0]),o=Math.max(o,e[a][1]);return{minX:t,minY:r,maxX:n,maxY:o}}(n[0])),c=s(a||r.wallColor||r.color||i(r.material),l),u=s(a||r.roofColor||i(r.roofMaterial),l);switch(r.shape){case"cone":return void split.cylinder(t,f.center,f.radius,0,f.wallHeight,f.wallZ,c);case"dome":return void split.dome(t,f.center,f.radius,f.wallHeight,f.wallZ,c);case"pyramid":return void split.pyramid(t,n,f.center,f.wallHeight,f.wallZ,c);case"sphere":return void split.sphere(t,f.center,f.radius,f.wallHeight,f.wallZ,c)}switch(createRoof(t,r,n,f,u,c),r.shape){case"none":return;case"cylinder":return void split.cylinder(t,f.center,f.radius,f.radius,f.wallHeight,f.wallZ,c);default:var h=.2,d=.4;"glass"!==r.material&&(h=0,d=0,r.levels&&(d=parseFloat(r.levels)-parseFloat(r.minLevel||0)<<0)),split.extrusion(t,n,f.wallHeight,f.wallZ,c,[0,o,h/f.wallHeight,d/f.wallHeight])}}(t,r.properties,u,l,f)})}}();function pointOnSegment(e,t){return e[0]>=Math.min(t[0][0],t[1][0])&&e[0]<=Math.max(t[1][0],t[0][0])&&e[1]>=Math.min(t[0][1],t[1][1])&&e[1]<=Math.max(t[1][1],t[0][1])}function getVectorSegmentIntersection(e,t,r){var n,o,a,i,s,l=r[0],f=[r[1][0]-r[0][0],r[1][1]-r[0][1]];if(0!==t[0]||0!==f[0]){if(0!==t[0]&&(a=t[1]/t[0],n=e[1]-a*e[0]),0!==f[0]&&(i=f[1]/f[0],o=l[1]-i*l[0]),0===t[0]&&pointOnSegment(s=[e[0],i*e[0]+o],r))return s;if(0===f[0]&&pointOnSegment(s=[l[0],a*l[0]+n],r))return s;if(a!==i){var c=(o-n)/(a-i);return pointOnSegment(s=[c,a*c+n],r)?s:void 0}}}function getDistanceToLine(e,t){var r=t[0],n=t[1];if(r[0]!==n[0]||r[1]!==n[1]){var o=(n[1]-r[1])/(n[0]-r[0]),a=r[1]-o*r[0];if(0===o)return Math.abs(a-e[1]);if(o===1/0)return Math.abs(r[0]-e[0]);var i=-1/o,s=(e[1]-i*e[0]-a)/(o-i),l=o*s+a,f=e[0]-s,c=e[1]-l;return Math.sqrt(f*f+c*c)}}!function(){function e(e,r,n,o,a,i,s){if(0,n.length>1||void 0===r.roofDirection)return t(e,r,n,a,i);var l=(r.roofDirection/180-.5)*Math.PI,f=[Math.cos(l),Math.sin(l)],c=function(e,t,r){for(var n,o=[],a=0;a<r.length-1;a++)if(void 0!==(n=getVectorSegmentIntersection(e,t,[r[a],r[a+1]]))){if(2===o.length)return;a++,r.splice(a,0,n),o.push(a)}if(!(o.length<2))return{index:o,roof:r}}(a.center,f,n[0]);if(!c)return t(e,r,n,a,i);for(var u,h=c.index,d=c.roof,p=[],g=0,v=[d[h[0]],d[h[1]]],x=0;x<d.length;x++)p[x]=getDistanceToLine(d[x],v),g=Math.max(g,p[x]);for(x=0;x<d.length;x++)d[x][2]=(1-p[x]/g)*a.roofHeight;for(u=d.slice(h[0],h[1]+1),split.polygon(e,[u],a.roofZ,i),u=(u=d.slice(h[1],d.length-1)).concat(d.slice(0,h[0]+1)),split.polygon(e,[u],a.roofZ,i),x=0;x<d.length-1;x++)0===d[x][2]&&0===d[x+1][2]||split.quad(e,[d[x][0],d[x][1],a.roofZ+d[x][2]],[d[x][0],d[x][1],a.roofZ],[d[x+1][0],d[x+1][1],a.roofZ],[d[x+1][0],d[x+1][1],a.roofZ+d[x+1][2]],s)}function t(e,t,r,n,o){"cylinder"===t.shape?split.circle(e,n.center,n.radius,n.roofZ,o):split.polygon(e,r,n.roofZ,o)}createRoof=function(r,n,o,a,i,s){switch(n.roofShape){case"cone":return function(e,t,r,n){split.polygon(e,t,r.roofZ,n),split.cylinder(e,r.center,r.radius,0,r.roofHeight,r.roofZ,n)}(r,o,a,i);case"dome":return function(e,t,r,n){split.polygon(e,t,r.roofZ,n),split.dome(e,r.center,r.radius,r.roofHeight,r.roofZ,n)}(r,o,a,i);case"pyramid":return function(e,t,r,n,o){"cylinder"===t.shape?split.cylinder(e,n.center,n.radius,0,n.roofHeight,n.roofZ,o):split.pyramid(e,r,n.center,n.roofHeight,n.roofZ,o)}(r,n,o,a,i);case"skillion":return function(e,r,n,o,a,i){if(void 0===r.roofDirection)return t(e,r,n,o,a);var s,l,f=r.roofDirection/180*Math.PI,c=1/0,u=-1/0;n[0].forEach(function(e){var t=e[1]*Math.cos(-f)+e[0]*Math.sin(-f);t<c&&(c=t,s=e),t>u&&(u=t,l=e)});var h=n[0],d=[Math.cos(f),Math.sin(f)],p=[s,[s[0]+d[0],s[1]+d[1]]],g=getDistanceToLine(l,p);n.forEach(function(e){e.forEach(function(e){var t=getDistanceToLine(e,p);e[2]=t/g*o.roofHeight})}),split.polygon(e,[h],o.roofZ,a),n.forEach(function(t){for(var r=0;r<t.length-1;r++)0===t[r][2]&&0===t[r+1][2]||split.quad(e,[t[r][0],t[r][1],o.roofZ+t[r][2]],[t[r][0],t[r][1],o.roofZ],[t[r+1][0],t[r+1][1],o.roofZ],[t[r+1][0],t[r+1][1],o.roofZ+t[r+1][2]],i)})}(r,n,o,a,i,s);case"gabled":return e(r,n,o,0,a,i,s);case"hipped":case"half-hipped":return t(r,n,o,a,i);case"gambrel":case"mansard":return e(r,n,o,0,a,i,s);case"round":return function(e,r,n,o,a,i){if(n.length>1||void 0===r.roofDirection)return t(e,r,n,o,a);return t(e,r,n,o,a)}(r,n,o,a,i);case"onion":return function(e,t,r,n){split.polygon(e,t,r.roofZ,n);for(var o,a,i=[{rScale:.8,hScale:0},{rScale:.9,hScale:.18},{rScale:.9,hScale:.35},{rScale:.8,hScale:.47},{rScale:.6,hScale:.59},{rScale:.5,hScale:.65},{rScale:.2,hScale:.82},{rScale:0,hScale:1}],s=0,l=i.length-1;s<l;s++)o=r.roofHeight*i[s].hScale,a=r.roofHeight*i[s+1].hScale,split.cylinder(e,r.center,r.radius*i[s].rScale,r.radius*i[s+1].rScale,a-o,r.roofZ+o,n)}(r,o,a,i);default:return t(r,n,o,a,i)}}}();var split={NUM_Y_SEGMENTS:24,NUM_X_SEGMENTS:32,quad:function(e,t,r,n,o,a){this.triangle(e,t,r,n,a),this.triangle(e,n,o,t,a)},triangle:function(e,t,r,n,o){var a=vec3.normal(t,r,n);[].push.apply(e.vertices,[].concat(t,n,r)),[].push.apply(e.normals,[].concat(a,a,a)),[].push.apply(e.colors,[].concat(o,o,o)),e.texCoords.push(0,0,0,0,0,0)},circle:function(e,t,r,n,o){var a,i;n=n||0;for(var s=0;s<this.NUM_X_SEGMENTS;s++)a=s/this.NUM_X_SEGMENTS,i=(s+1)/this.NUM_X_SEGMENTS,this.triangle(e,[t[0]+r*Math.sin(a*Math.PI*2),t[1]+r*Math.cos(a*Math.PI*2),n],[t[0],t[1],n],[t[0]+r*Math.sin(i*Math.PI*2),t[1]+r*Math.cos(i*Math.PI*2),n],o)},polygon:function(e,t,r,n){r=r||0;var o,a,i,s,l,f=[],c=[],u=0;for(o=0,a=t.length;o<a;o++){for(s=t[o],i=0;i<s.length;i++)l=s[i],f.push(l[0],l[1],r+(l[2]||0));o&&(u+=t[o-1].length,c.push(u))}var h,d,p,g=earcut(f,c,3);for(o=0,a=g.length-2;o<a;o+=3)h=3*g[o],d=3*g[o+1],p=3*g[o+2],this.triangle(e,[f[h],f[h+1],f[h+2]],[f[d],f[d+1],f[d+2]],[f[p],f[p+1],f[p+2]],n)},cube:function(e,t,r,n,o,a,i,s){var l=[o=o||0,a=a||0,i=i||0],f=[o+t,a,i],c=[o+t,a+r,i],u=[o,a+r,i],h=[o,a,i+n],d=[o+t,a,i+n],p=[o+t,a+r,i+n],g=[o,a+r,i+n];this.quad(e,f,l,u,c,s),this.quad(e,h,d,p,g,s),this.quad(e,l,f,d,h,s),this.quad(e,f,c,p,d,s),this.quad(e,c,u,g,p,s),this.quad(e,u,l,h,g,s)},cylinder:function(e,t,r,n,o,a,i){a=a||0;for(var s,l,f,c,u,h,d=this.NUM_X_SEGMENTS,p=2*Math.PI,g=0;g<d;g++)s=g/d*p,l=(g+1)/d*p,f=Math.sin(s),c=Math.cos(s),u=Math.sin(l),h=Math.cos(l),this.triangle(e,[t[0]+r*f,t[1]+r*c,a],[t[0]+n*u,t[1]+n*h,a+o],[t[0]+r*u,t[1]+r*h,a],i),0!==n&&this.triangle(e,[t[0]+n*f,t[1]+n*c,a+o],[t[0]+n*u,t[1]+n*h,a+o],[t[0]+r*f,t[1]+r*c,a],i)},dome:function(e,t,r,n,o,a,i){o=o||0;for(var s,l,f,c,u,h,d,p,g,v=this.NUM_Y_SEGMENTS/2,x=Math.PI/2,m=i?0:-x,y=0;y<v;y++)s=y/v*x+m,l=(y+1)/v*x+m,f=Math.cos(s),c=Math.sin(s),h=f*r,d=Math.cos(l)*r,p=((u=Math.sin(l))-c)*n,g=o-u*n,this.cylinder(e,t,d,h,p,g,a)},sphere:function(e,t,r,n,o,a){o=o||0;var i=0;return i+=this.dome(e,t,r,n/2,o+n/2,a,!0),i+=this.dome(e,t,r,n/2,o+n/2,a)},pyramid:function(e,t,r,n,o,a){o=o||0;for(var i=0,s=(t=t[0]).length-1;i<s;i++)this.triangle(e,[t[i][0],t[i][1],o],[t[i+1][0],t[i+1][1],o],[r[0],r[1],o+n],a)},extrusion:function(e,t,r,n,o,a){n=n||0;var i,s,l,f,c,u,h,d,p,g,v,x,m,y,b,M=a[2]*r,w=a[3]*r;for(x=0,m=t.length;x<m;x++)for(y=0,b=(i=t[x]).length-1;y<b;y++)s=i[y],l=i[y+1],f=vec2.len(vec2.sub(s,l)),c=[s[0],s[1],n],u=[l[0],l[1],n],h=[l[0],l[1],n+r],d=[s[0],s[1],n+r],p=vec3.normal(c,u,h),[].push.apply(e.vertices,[].concat(c,h,u,c,d,h)),[].push.apply(e.normals,[].concat(p,p,p,p,p,p)),[].push.apply(e.colors,[].concat(o,o,o,o,o,o)),g=a[0]*f<<0,v=a[1]*f<<0,e.texCoords.push(g,w,v,M,v,w,g,w,g,M,v,M)}},earcut=function(){function e(e,o,a){a=a||2;var i,s,c,h,d,p,g,v=o&&o.length,x=v?o[0]*a:e.length,m=t(e,0,x,a,!0),y=[];if(!m)return y;if(v&&(m=function(e,n,o,a){var i,s,c,h,d,p=[];for(i=0,s=n.length;i<s;i++)c=n[i]*a,h=i<s-1?n[i+1]*a:e.length,(d=t(e,c,h,a,!1))===d.next&&(d.steiner=!0),p.push(u(d));for(p.sort(l),i=0;i<p.length;i++)f(p[i],o),o=r(o,o.next);return o}(e,o,m,a)),e.length>80*a){i=c=e[0],s=h=e[1];for(var b=a;b<x;b+=a)d=e[b],p=e[b+1],d<i&&(i=d),p<s&&(s=p),d>c&&(c=d),p>h&&(h=p);g=Math.max(c-i,h-s)}return n(m,y,a,i,s,g),y}function t(e,t,r,n,o){var a,i;if(o===w(e,t,r,n)>0)for(a=t;a<r;a+=n)i=y(a,e[a],e[a+1],i);else for(a=r-n;a>=t;a-=n)i=y(a,e[a],e[a+1],i);return i&&g(i,i.next)&&(b(i),i=i.next),i}function r(e,t){if(!e)return e;t||(t=e);var r,n=e;do{if(r=!1,n.steiner||!g(n,n.next)&&0!==p(n.prev,n,n.next))n=n.next;else{if(b(n),(n=t=n.prev)===n.next)return null;r=!0}}while(r||n!==t);return t}function n(e,t,l,f,u,h,d){if(e){!d&&h&&function(e,t,r,n){var o=e;do{null===o.z&&(o.z=c(o.x,o.y,t,r,n)),o.prevZ=o.prev,o.nextZ=o.next,o=o.next}while(o!==e);o.prevZ.nextZ=null,o.prevZ=null,function(e){var t,r,n,o,a,i,s,l,f=1;do{for(r=e,e=null,a=null,i=0;r;){for(i++,n=r,s=0,t=0;t<f&&(s++,n=n.nextZ);t++);for(l=f;s>0||l>0&&n;)0===s?(o=n,n=n.nextZ,l--):0!==l&&n?r.z<=n.z?(o=r,r=r.nextZ,s--):(o=n,n=n.nextZ,l--):(o=r,r=r.nextZ,s--),a?a.nextZ=o:e=o,o.prevZ=a,a=o;r=n}a.nextZ=null,f*=2}while(i>1)}(o)}(e,f,u,h);for(var p,g,v=e;e.prev!==e.next;)if(p=e.prev,g=e.next,h?a(e,f,u,h):o(e))t.push(p.i/l),t.push(e.i/l),t.push(g.i/l),b(e),e=g.next,v=g.next;else if((e=g)===v){d?1===d?n(e=i(e,t,l),t,l,f,u,h,2):2===d&&s(e,t,l,f,u,h):n(r(e),t,l,f,u,h,1);break}}}function o(e){var t=e.prev,r=e,n=e.next;if(p(t,r,n)>=0)return!1;for(var o=e.next.next;o!==e.prev;){if(h(t.x,t.y,r.x,r.y,n.x,n.y,o.x,o.y)&&p(o.prev,o,o.next)>=0)return!1;o=o.next}return!0}function a(e,t,r,n){var o=e.prev,a=e,i=e.next;if(p(o,a,i)>=0)return!1;for(var s=o.x<a.x?o.x<i.x?o.x:i.x:a.x<i.x?a.x:i.x,l=o.y<a.y?o.y<i.y?o.y:i.y:a.y<i.y?a.y:i.y,f=o.x>a.x?o.x>i.x?o.x:i.x:a.x>i.x?a.x:i.x,u=o.y>a.y?o.y>i.y?o.y:i.y:a.y>i.y?a.y:i.y,d=c(s,l,t,r,n),g=c(f,u,t,r,n),v=e.nextZ;v&&v.z<=g;){if(v!==e.prev&&v!==e.next&&h(o.x,o.y,a.x,a.y,i.x,i.y,v.x,v.y)&&p(v.prev,v,v.next)>=0)return!1;v=v.nextZ}for(v=e.prevZ;v&&v.z>=d;){if(v!==e.prev&&v!==e.next&&h(o.x,o.y,a.x,a.y,i.x,i.y,v.x,v.y)&&p(v.prev,v,v.next)>=0)return!1;v=v.prevZ}return!0}function i(e,t,r){var n=e;do{var o=n.prev,a=n.next.next;!g(o,a)&&v(o,n,n.next,a)&&x(o,a)&&x(a,o)&&(t.push(o.i/r),t.push(n.i/r),t.push(a.i/r),b(n),b(n.next),n=e=a),n=n.next}while(n!==e);return n}function s(e,t,o,a,i,s){var l=e;do{for(var f=l.next.next;f!==l.prev;){if(l.i!==f.i&&d(l,f)){var c=m(l,f);return l=r(l,l.next),c=r(c,c.next),n(l,t,o,a,i,s),void n(c,t,o,a,i,s)}f=f.next}l=l.next}while(l!==e)}function l(e,t){return e.x-t.x}function f(e,t){if(t=function(e,t){var r,n=t,o=e.x,a=e.y,i=-1/0;do{if(a<=n.y&&a>=n.next.y){var s=n.x+(a-n.y)*(n.next.x-n.x)/(n.next.y-n.y);if(s<=o&&s>i){if(i=s,s===o){if(a===n.y)return n;if(a===n.next.y)return n.next}r=n.x<n.next.x?n:n.next}}n=n.next}while(n!==t);if(!r)return null;if(o===i)return r.prev;var l,f=r,c=r.x,u=r.y,d=1/0;n=r.next;for(;n!==f;)o>=n.x&&n.x>=c&&h(a<u?o:i,a,c,u,a<u?i:o,a,n.x,n.y)&&((l=Math.abs(a-n.y)/(o-n.x))<d||l===d&&n.x>r.x)&&x(n,e)&&(r=n,d=l),n=n.next;return r}(e,t)){var n=m(t,e);r(n,n.next)}}function c(e,t,r,n,o){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=32767*(e-r)/o)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=32767*(t-n)/o)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function u(e){var t=e,r=e;do{t.x<r.x&&(r=t),t=t.next}while(t!==e);return r}function h(e,t,r,n,o,a,i,s){return(o-i)*(t-s)-(e-i)*(a-s)>=0&&(e-i)*(n-s)-(r-i)*(t-s)>=0&&(r-i)*(a-s)-(o-i)*(n-s)>=0}function d(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var r=e;do{if(r.i!==e.i&&r.next.i!==e.i&&r.i!==t.i&&r.next.i!==t.i&&v(r,r.next,e,t))return!0;r=r.next}while(r!==e);return!1}(e,t)&&x(e,t)&&x(t,e)&&function(e,t){var r=e,n=!1,o=(e.x+t.x)/2,a=(e.y+t.y)/2;do{r.y>a!=r.next.y>a&&o<(r.next.x-r.x)*(a-r.y)/(r.next.y-r.y)+r.x&&(n=!n),r=r.next}while(r!==e);return n}(e,t)}function p(e,t,r){return(t.y-e.y)*(r.x-t.x)-(t.x-e.x)*(r.y-t.y)}function g(e,t){return e.x===t.x&&e.y===t.y}function v(e,t,r,n){return!!(g(e,t)&&g(r,n)||g(e,n)&&g(r,t))||p(e,t,r)>0!=p(e,t,n)>0&&p(r,n,e)>0!=p(r,n,t)>0}function x(e,t){return p(e.prev,e,e.next)<0?p(e,t,e.next)>=0&&p(e,e.prev,t)>=0:p(e,t,e.prev)<0||p(e,e.next,t)<0}function m(e,t){var r=new M(e.i,e.x,e.y),n=new M(t.i,t.x,t.y),o=e.next,a=t.prev;return e.next=t,t.prev=e,r.next=o,o.prev=r,n.next=r,r.prev=n,a.next=n,n.prev=a,n}function y(e,t,r,n){var o=new M(e,t,r);return n?(o.next=n.next,o.prev=n,n.next.prev=o,n.next=o):(o.prev=o,o.next=o),o}function b(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function M(e,t,r){this.i=e,this.x=t,this.y=r,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function w(e,t,r,n){for(var o=0,a=t,i=r-n;a<r;a+=n)o+=(e[i]-e[a])*(e[a+1]+e[i+1]),i=a;return o}return e.deviation=function(e,t,r,n){var o,a,i=t&&t.length,s=i?t[0]*r:e.length,l=Math.abs(w(e,0,s,r));if(i)for(o=0,a=t.length;o<a;o++){var f=t[o]*r,c=o<a-1?t[o+1]*r:e.length;l-=Math.abs(w(e,f,c,r))}var u=0;for(o=0,a=n.length;o<a;o+=3){var h=n[o]*r,d=n[o+1]*r,p=n[o+2]*r;u+=Math.abs((e[h]-e[p])*(e[d+1]-e[h+1])-(e[h]-e[d])*(e[p+1]-e[h+1]))}return 0===l&&0===u?0:Math.abs((u-l)/l)},e.flatten=function(e){for(var t=e[0][0].length,r={vertices:[],holes:[],dimensions:t},n=0,o=0;o<e.length;o++){for(var a=0;a<e[o].length;a++)for(var i=0;i<t;i++)r.vertices.push(e[o][a][i]);o>0&&(n+=e[o-1].length,r.holes.push(n))}return r},e}(),vec3={len:function(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])},sub:function(e,t){return[e[0]-t[0],e[1]-t[1],e[2]-t[2]]},unit:function(e){var t=this.len(e);return[e[0]/t,e[1]/t,e[2]/t]},normal:function(e,t,r){var n=this.sub(e,t),o=this.sub(t,r);return this.unit([n[1]*o[2]-n[2]*o[1],n[2]*o[0]-n[0]*o[2],n[0]*o[1]-n[1]*o[0]])}},vec2={len:function(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1])},add:function(e,t){return[e[0]+t[0],e[1]+t[1]]},sub:function(e,t){return[e[0]-t[0],e[1]-t[1]]},dot:function(e,t){return e[1]*t[0]-e[0]*t[1]},scale:function(e,t){return[e[0]*t,e[1]*t]},equals:function(e,t){return e[0]===t[0]&&e[1]===t[1]}};function getOrigin(e){const t=e.coordinates;switch(e.type){case"Point":return t;case"MultiPoint":case"LineString":return t[0];case"MultiLineString":case"Polygon":return t[0][0];case"MultiPolygon":return t[0][0][0]}}function getPickingColor(e){return[0,(255&++e)/255,(e>>8&255)/255]}function postResult(e,t,r){const n={items:e,position:t,vertices:new Float32Array(r.vertices),normals:new Float32Array(r.normals),colors:new Float32Array(r.colors),texCoords:new Float32Array(r.texCoords),heights:new Float32Array(r.heights),pickingColors:new Float32Array(r.pickingColors)};postMessage(n,[n.vertices.buffer,n.normals.buffer,n.colors.buffer,n.texCoords.buffer,n.heights.buffer,n.pickingColors.buffer])}function loadGeoJSON(e){"object"==typeof e.url?(postMessage("load"),processGeoJSON(e.url,e.options)):Request.getJSON(e.url,(t,r)=>{t?postMessage("error"):(postMessage("load"),processGeoJSON(r,e.options))})}function processGeoJSON(e,t){if(!e||!e.features.length)return void postMessage("error");const r={vertices:[],normals:[],colors:[],texCoords:[],heights:[],pickingColors:[]},n=[],o=getOrigin(e.features[0].geometry),a={latitude:o[1],longitude:o[0]};e.features.forEach((e,a)=>{const i=e.properties,s=t.id||e.id,l=getPickingColor(a);let f=r.vertices.length;triangulate(r,e,o),f=(r.vertices.length-f)/3;for(let e=0;e<f;e++)r.heights.push(i.height),r.pickingColors.push(...l);n.push({id:s,properties:i,vertexCount:f})}),postResult(n,a,r)}function loadOBJ(e){Request.getText(e.url,(e,t)=>{if(e)return void postMessage("error");let r=t.match(/^mtllib\\s+(.*)$/m);r?Request.getText(this.url.replace(/[^\\/]+$/,"")+r[1],(e,r)=>{e?postMessage("error"):(postMessage("load"),processOBJ(t,r))}):(postMessage("load"),processOBJ(t,null))})}function processOBJ(e,t,r){const n={vertices:[],normals:[],colors:[],texCoords:[],heights:[],pickingColors:[]},o=[],a=Qolor.parse(r.color).toArray(),s=r.position;OBJ.parse(e,t).forEach((e,t)=>{n.vertices.push(...e.vertices),n.normals.push(...e.normals),n.texCoords.push(...e.texCoords);const s=r.id||e.id,l=(s/2%2?-1:1)*(s%2?.03:.06),f=a||e.color||DEFAULT_COLOR,c=e.vertices.length/3,u=getPickingColor(i);for(let t=0;t<c;t++)n.colors.push(f[0]+l,f[1]+l,f[2]+l),n.heights.push(e.height),n.pickingColors.push(...u);o.push({id:s,properties:{},vertexCount:c})}),postResult(o,s,n)}onmessage=function(e){const t=e.data;"GeoJSON"===t.type&&loadGeoJSON(t),"OBJ"===t.type&&loadOBJ(t)};';class n{constructor(e,t){let r;const i={antialias:!t,depth:!0,premultipliedAlpha:!1};try{r=e.getContext("webgl",i)}catch(e){}if(!r)try{r=e.getContext("experimental-webgl",i)}catch(e){}if(!r)throw new Error("GL not supported");e.addEventListener("webglcontextlost",e=>{console.warn("context lost")}),e.addEventListener("webglcontextrestored",e=>{console.warn("context restored")}),r.viewport(0,0,e.width,e.height),r.cullFace(r.BACK),r.enable(r.CULL_FACE),r.enable(r.DEPTH_TEST),r.clearColor(.5,.5,.5,1),t||(r.anisotropyExtension=r.getExtension("EXT_texture_filter_anisotropic"),r.anisotropyExtension&&(r.anisotropyExtension.maxAnisotropyLevel=r.getParameter(r.anisotropyExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),r.depthTextureExtension=r.getExtension("WEBGL_depth_texture")),this.GL=r}destroy(){this.GL.getExtension("WEBGL_lose_context").loseContext(),this.GL=null}}n.Buffer=class{constructor(e,t){this.id=f.createBuffer(),this.itemSize=e,this.numItems=t.length/e,f.bindBuffer(f.ARRAY_BUFFER,this.id),f.bufferData(f.ARRAY_BUFFER,t,f.STATIC_DRAW),t=null}enable(){f.bindBuffer(f.ARRAY_BUFFER,this.id)}use(){f.bindBuffer(f.ARRAY_BUFFER,this.id)}destroy(){f.deleteBuffer(this.id),this.id=null}},n.Framebuffer=class{constructor(e,t,r){if(r&&!f.depthTextureExtension)throw new Error("GL: Depth textures are not supported");this.useDepthTexture=!!r,this.setSize(e,t)}setSize(e,t){if(this.frameBuffer){if(e===this.width&&t===this.height)return}else this.frameBuffer=f.createFramebuffer();if(f.bindFramebuffer(f.FRAMEBUFFER,this.frameBuffer),this.width=e,this.height=t,this.depthRenderBuffer&&(f.deleteRenderbuffer(this.depthRenderBuffer),this.depthRenderBuffer=null),this.depthTexture&&(this.depthTexture.destroy(),this.depthTexture=null),this.useDepthTexture?(this.depthTexture=new n.texture.Image,this.depthTexture.enable(0),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.NEAREST),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.NEAREST),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),f.texImage2D(f.TEXTURE_2D,0,f.DEPTH_STENCIL,e,t,0,f.DEPTH_STENCIL,f.depthTextureExtension.UNSIGNED_INT_24_8_WEBGL,null),f.framebufferTexture2D(f.FRAMEBUFFER,f.DEPTH_STENCIL_ATTACHMENT,f.TEXTURE_2D,this.depthTexture.id,0)):(this.depthRenderBuffer=f.createRenderbuffer(),f.bindRenderbuffer(f.RENDERBUFFER,this.depthRenderBuffer),f.renderbufferStorage(f.RENDERBUFFER,f.DEPTH_COMPONENT16,e,t),f.framebufferRenderbuffer(f.FRAMEBUFFER,f.DEPTH_ATTACHMENT,f.RENDERBUFFER,this.depthRenderBuffer)),this.renderTexture&&this.renderTexture.destroy(),this.renderTexture=new n.texture.Data(f,e,t),f.bindTexture(f.TEXTURE_2D,this.renderTexture.id),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),f.framebufferTexture2D(f.FRAMEBUFFER,f.COLOR_ATTACHMENT0,f.TEXTURE_2D,this.renderTexture.id,0),f.checkFramebufferStatus(f.FRAMEBUFFER)!==f.FRAMEBUFFER_COMPLETE)throw new Error("Combination of framebuffer attachments doesn't work");f.bindRenderbuffer(f.RENDERBUFFER,null),f.bindFramebuffer(f.FRAMEBUFFER,null)}enable(){f.bindFramebuffer(f.FRAMEBUFFER,this.frameBuffer),this.useDepthTexture||f.bindRenderbuffer(f.RENDERBUFFER,this.depthRenderBuffer)}disable(){f.bindFramebuffer(f.FRAMEBUFFER,null),this.useDepthTexture||f.bindRenderbuffer(f.RENDERBUFFER,null)}getPixel(e,t){if(e<0||t<0||e>=this.width||t>=this.height)return;const r=new Uint8Array(4);return f.readPixels(e,t,1,1,f.RGBA,f.UNSIGNED_BYTE,r),r}getData(){const e=new Uint8Array(this.width*this.height*4);return f.readPixels(0,0,this.width,this.height,f.RGBA,f.UNSIGNED_BYTE,e),e}destroy(){this.renderTexture&&this.renderTexture.destroy(),this.depthTexture&&this.depthTexture.destroy()}},n.Shader=class{constructor(e){if(this.shaderName=e.shaderName,this.id=f.createProgram(),this.compile(f.VERTEX_SHADER,e.vertexShader),this.compile(f.FRAGMENT_SHADER,e.fragmentShader),f.linkProgram(this.id),!f.getProgramParameter(this.id,f.LINK_STATUS))throw new Error(f.getProgramParameter(this.id,f.VALIDATE_STATUS)+"\n"+f.getError());f.useProgram(this.id),this.attributes={},(e.attributes||[]).forEach(e=>{this.locateAttribute(e)}),this.uniforms={},(e.uniforms||[]).forEach(e=>{this.locateUniform(e)})}locateAttribute(e){const t=f.getAttribLocation(this.id,e);if(t<0)throw new Error(`unable to locate attribute "${e}" in shader "${this.shaderName}"`);this.attributes[e]=t}locateUniform(e){const t=f.getUniformLocation(this.id,e);if(!t)throw new Error(`unable to locate uniform "${e}" in shader "${this.shaderName}"`);this.uniforms[e]=t}compile(e,t){const r=f.createShader(e);if(f.shaderSource(r,t),f.compileShader(r),!f.getShaderParameter(r,f.COMPILE_STATUS))throw new Error(f.getShaderInfoLog(r));f.attachShader(this.id,r)}enable(){f.useProgram(this.id);for(let e in this.attributes)f.enableVertexAttribArray(this.attributes[e]);return this}disable(){if(this.attributes)for(let e in this.attributes)f.disableVertexAttribArray(this.attributes[e])}setBuffer(e,t){if(void 0===this.attributes[e])throw new Error(`attempt to bind buffer to invalid attribute "${e}" in shader "${this.shaderName}"`);t.enable(),f.vertexAttribPointer(this.attributes[e],t.itemSize,f.FLOAT,!1,0,0)}setParam(e,t,r){if(void 0===this.uniforms[e])throw new Error(`attempt to bind to invalid uniform "${e}" in shader "${this.shaderName}"`);f["uniform"+t](this.uniforms[e],r)}setMatrix(e,t,r){if(void 0===this.uniforms[e])throw new Error(`attempt to bind to invalid uniform "${e}" in shader "${this.shaderName}"`);f["uniformMatrix"+t](this.uniforms[e],!1,r)}setTexture(e,t,r){r.enable(t),this.setParam(e,"1i",t)}destroy(){this.disable(),this.id=null}},n.Matrix=function(e){this.data=new Float32Array(e||[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},n.Matrix.identity=function(){return new n.Matrix([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])},n.Matrix.identity3=function(){return new n.Matrix([1,0,0,0,1,0,0,0,1])},function(){function e(e){return e*Math.PI/180}function t(e,t,r){var i=t[0],n=t[1],o=t[2],a=t[3],s=t[4],u=t[5],h=t[6],l=t[7],f=t[8],d=t[9],c=t[10],m=t[11],g=t[12],x=t[13],p=t[14],v=t[15],w=r[0],b=r[1],T=r[2],A=r[3],y=r[4],M=r[5],E=r[6],P=r[7],S=r[8],D=r[9],B=r[10],C=r[11],F=r[12],_=r[13],R=r[14],I=r[15];e[0]=i*w+n*y+o*S+a*F,e[1]=i*b+n*M+o*D+a*_,e[2]=i*T+n*E+o*B+a*R,e[3]=i*A+n*P+o*C+a*I,e[4]=s*w+u*y+h*S+l*F,e[5]=s*b+u*M+h*D+l*_,e[6]=s*T+u*E+h*B+l*R,e[7]=s*A+u*P+h*C+l*I,e[8]=f*w+d*y+c*S+m*F,e[9]=f*b+d*M+c*D+m*_,e[10]=f*T+d*E+c*B+m*R,e[11]=f*A+d*P+c*C+m*I,e[12]=g*w+x*y+p*S+v*F,e[13]=g*b+x*M+p*D+v*_,e[14]=g*T+x*E+p*B+v*R,e[15]=g*A+x*P+p*C+v*I}n.Matrix.prototype={multiply:function(e){return t(this.data,this.data,e.data),this},translate:function(e,r,i){return t(this.data,this.data,[1,0,0,0,0,1,0,0,0,0,1,0,e,r,i,1]),this},rotateX:function(r){var i=e(r),n=Math.cos(i),o=Math.sin(i);return t(this.data,this.data,[1,0,0,0,0,n,o,0,0,-o,n,0,0,0,0,1]),this},rotateY:function(r){var i=e(r),n=Math.cos(i),o=Math.sin(i);return t(this.data,this.data,[n,0,-o,0,0,1,0,0,o,0,n,0,0,0,0,1]),this},rotateZ:function(r){var i=e(r),n=Math.cos(i),o=Math.sin(i);return t(this.data,this.data,[n,-o,0,0,o,n,0,0,0,0,1,0,0,0,0,1]),this},scale:function(e,r,i){return t(this.data,this.data,[e,0,0,0,0,r,0,0,0,0,i,0,0,0,0,1]),this}},n.Matrix.multiply=function(e,r){var i=new Float32Array(16);return t(i,e.data,r.data),i},n.Matrix.Perspective=function(e,t,r,i){var o=1/Math.tan(e*(Math.PI/180)/2),a=1/(r-i);return new n.Matrix([o/t,0,0,0,0,o,0,0,0,0,(i+r)*a,-1,0,0,2*i*r*a,0])},n.Matrix.Frustum=function(e,t,r,i,o,a){var s=1/(t-e),u=1/(r-i),h=1/(o-a);return new n.Matrix([2*o*s,0,0,0,0,2*o*u,0,0,(t+e)*s,(r+i)*u,(a+o)*h,-1,0,0,a*o*2*h,0])},n.Matrix.OffCenterProjection=function(e,t,r,i,o,a){var s=he(oe(r,e)),u=he(oe(t,e)),h=function(e,t,r){var i=oe(e,t),n=oe(t,r);return he([i[1]*n[2]-i[2]*n[1],i[2]*n[0]-i[0]*n[2],i[0]*n[1]-i[1]*n[0]])}(e,t,r),l=oe(e,i),f=oe(t,i),d=oe(r,i),c=-ne(l,h),m=ne(s,l)*o/c,g=ne(s,d)*o/c,x=ne(u,l)*o/c,p=ne(u,f)*o/c;return n.Matrix.Frustum(m,g,p,x,o,a)},n.Matrix.Ortho=function(e,t,r,i,o,a){return new n.Matrix([2/(t-e),0,0,0,0,2/(r-i),0,0,0,0,-2/(a-o),0,-(t+e)/(t-e),-(r+i)/(r-i),-(a+o)/(a-o),1])},n.Matrix.invert3=function(e){var t=e[0],r=e[1],i=e[2],n=e[4],o=e[5],a=e[6],s=e[8],u=e[9],h=e[10],l=h*o-a*u,f=-h*n+a*s,d=u*n-o*s,c=t*l+r*f+i*d;return c?[l*(c=1/c),(-h*r+i*u)*c,(a*r-i*o)*c,f*c,(h*t-i*s)*c,(-a*t+i*n)*c,d*c,(-u*t+r*s)*c,(o*t-r*n)*c]:null},n.Matrix.transpose3=function(e){return new Float32Array([e[0],e[3],e[6],e[1],e[4],e[7],e[2],e[5],e[8]])},n.Matrix.transpose=function(e){return new Float32Array([e[0],e[4],e[8],e[12],e[1],e[5],e[9],e[13],e[2],e[6],e[10],e[14],e[3],e[7],e[11],e[15]])},n.Matrix.transform=function(e){const t=e[12],r=e[13],i=e[14],n=e[15];return{x:(t/n+1)/2,y:(r/n+1)/2,z:(i/n+1)/2}},n.Matrix.invert=function(e){const t=new Float32Array(16),r=e[0],i=e[1],n=e[2],o=e[3],a=e[4],s=e[5],u=e[6],h=e[7],l=e[8],f=e[9],d=e[10],c=e[11],m=e[12],g=e[13],x=e[14],p=e[15],v=r*s-i*a,w=r*u-n*a,b=r*h-o*a,T=i*u-n*s,A=i*h-o*s,y=n*h-o*u,M=l*g-f*m,E=l*x-d*m,P=l*p-c*m,S=f*x-d*g,D=f*p-c*g,B=d*p-c*x;let C=v*B-w*D+b*S+T*P-A*E+y*M;if(C)return C=1/C,t[0]=(s*B-u*D+h*S)*C,t[1]=(n*D-i*B-o*S)*C,t[2]=(g*y-x*A+p*T)*C,t[3]=(d*A-f*y-c*T)*C,t[4]=(u*P-a*B-h*E)*C,t[5]=(r*B-n*P+o*E)*C,t[6]=(x*b-m*y-p*w)*C,t[7]=(l*y-d*b+c*w)*C,t[8]=(a*D-s*P+h*M)*C,t[9]=(i*P-r*D-o*M)*C,t[10]=(m*A-g*b+p*v)*C,t[11]=(f*b-l*A-c*v)*C,t[12]=(s*E-a*S-u*M)*C,t[13]=(r*S-i*E+n*M)*C,t[14]=(g*w-m*T-x*v)*C,t[15]=(l*T-f*w+d*v)*C,t}}(),n.texture={},n.texture.Image=class{constructor(){this.id=f.createTexture(),f.bindTexture(f.TEXTURE_2D,this.id),f.bindTexture(f.TEXTURE_2D,null)}clamp(e,t){if(e.width<=t&&e.height<=t)return e;let r=t,i=t;const n=e.width/e.height;n<1?r=Math.round(i*n):i=Math.round(r/n);const o=E.createElement("CANVAS");return o.width=r,o.height=i,o.getContext("2d").drawImage(e,0,0,o.width,o.height),o}load(e,t){const r=new Image;return r.crossOrigin="*",r.onload=(e=>{this.set(r),t&&t(r)}),r.onerror=(e=>{t&&t()}),r.src=e,this}color(e){return f.bindTexture(f.TEXTURE_2D,this.id),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.LINEAR),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.LINEAR),f.texImage2D(f.TEXTURE_2D,0,f.RGBA,1,1,0,f.RGBA,f.UNSIGNED_BYTE,new Uint8Array([255*e[0],255*e[1],255*e[2],255*(void 0===e[3]?1:e[3])])),f.bindTexture(f.TEXTURE_2D,null),this}set(e){if(this.id)return e=this.clamp(e,f.getParameter(f.MAX_TEXTURE_SIZE)),f.bindTexture(f.TEXTURE_2D,this.id),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.LINEAR_MIPMAP_NEAREST),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MAG_FILTER,f.LINEAR),f.texImage2D(f.TEXTURE_2D,0,f.RGBA,f.RGBA,f.UNSIGNED_BYTE,e),f.generateMipmap(f.TEXTURE_2D),f.anisotropyExtension&&f.texParameterf(f.TEXTURE_2D,f.anisotropyExtension.TEXTURE_MAX_ANISOTROPY_EXT,f.anisotropyExtension.maxAnisotropyLevel),f.bindTexture(f.TEXTURE_2D,null),this}enable(e){if(this.id)return f.activeTexture(f.TEXTURE0+(e||0)),f.bindTexture(f.TEXTURE_2D,this.id),this}destroy(){f.bindTexture(f.TEXTURE_2D,null),f.deleteTexture(this.id),this.id=null}},n.texture.Data=class{constructor(e,t,r,i){this.id=e.createTexture(),e.bindTexture(e.TEXTURE_2D,this.id),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(e.TEXTURE_2D,e.TEXTURE_MAG_FILTER,e.NEAREST);let n=null;if(i){const e=t*r*4;(n=new Uint8Array(e)).set(i.subarray(0,e))}e.texImage2D(e.TEXTURE_2D,0,e.RGBA,t,r,0,e.RGBA,e.UNSIGNED_BYTE,n),e.bindTexture(e.TEXTURE_2D,null),this.GL=e}enable(e){return this.GL.activeTexture(this.GL.TEXTURE0+(e||0)),this.GL.bindTexture(this.GL.TEXTURE_2D,this.id),this}destroy(){this.GL.bindTexture(this.GL.TEXTURE_2D,null),this.GL.deleteTexture(this.id),this.id=null}};class o{constructor(){this.items=[]}add(e){this.items.push(e)}remove(e){this.items=this.items.filter(t=>t!==e)}forEach(e){this.items.forEach(e)}destroy(){this.forEach(e=>e.destroy()),this.items=[]}}class s{constructor(e={}){this.offsetX=e.offsetX||0,this.offsetY=e.offsetY||0,this.position=e.position||{latitude:0,longitude:0},this.elevation=e.elevation||30,this.source=e.source,this.isReady=!1,this.size=e.size||1,l.markers.add(this),this.load()}load(){const e=this.size/2,t=this.size/2,r=[-e,-t,0,e,-t,0,-e,t,0,e,t,0,-e,t,0,e,-t,0];this.texCoordBuffer=new n.Buffer(2,new Float32Array([0,0,1,0,0,1,1,1,0,1,1,0])),this.vertexBuffer=new n.Buffer(3,new Float32Array(r)),this.source?this.texture=(new n.texture.Image).load(this.source,e=>{e?(f.pixelStorei(f.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),f.bindTexture(f.TEXTURE_2D,this.texture.id),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.LINEAR),this.isReady=!0):(console.log("can not read marker source"),this.loadStandardIcon())}):(console.log("no marker source"),this.loadStandardIcon())}loadStandardIcon(){this.texture=(new n.texture.Image).load(C,e=>{e&&(f.pixelStorei(f.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),f.bindTexture(f.TEXTURE_2D,this.texture.id),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_MIN_FILTER,f.LINEAR),this.isReady=!0,this.source="Standard Icon")})}destroy(){l.markers.remove(this),this.texCoordBuffer.destroy(),this.vertexBuffer.destroy(),this.isReady&&this.texture.destroy()}}class u{constructor(e,t){this.items=[];for(let r=0;r<t;r++)this.items[r]=new h(e)}get(e){for(let t=0;t<this.items.length;t++)if(!this.items[t].busy)return this.items[t].busy=!0,void e(this.items[t]);setTimeout(()=>{this.get(e)},50)}destroy(){this.items.forEach(e=>e.destroy()),this.items=[]}}class h{constructor(e){this.busy=!1,this.thread=new Worker(e)}postMessage(e){this.thread.postMessage(e)}onMessage(e){this.thread.onmessage=function(t){e(t.data)}}free(){this.thread.onmessage=function(e){},this.busy=!1}destroy(){this.thread.close()}}let l,f;class d{constructor(t={}){l=this,t.style&&(t.style.color||t.style.wallColor)&&e.parse(t.style.color||t.style.wallColor).toArray(),fe.backgroundColor=e.parse(t.backgroundColor||M).toArray(),fe.fogColor=e.parse(t.fogColor||y).toArray(),this.attribution=t.attribution||d.ATTRIBUTION,this.minZoom=Math.max(parseFloat(t.minZoom||v),v),this.maxZoom=Math.min(parseFloat(t.maxZoom||w),w),this.maxZoom<this.minZoom&&(this.minZoom=v,this.maxZoom=w),this.bounds=t.bounds,this.position=t.position||{latitude:52.52,longitude:13.41},this.zoom=t.zoom||this.minZoom+(this.maxZoom-this.minZoom)/2,this.rotation=t.rotation||0,this.tilt=t.tilt||0,t.disabled&&this.setDisabled(!0);const r=Math.min(window.navigator.hardwareConcurrency,4);if("string"==typeof i){const e=new Blob([i],{type:"application/javascript"});this.workers=new u(URL.createObjectURL(e),4*r)}let a=t.container;"string"==typeof a&&(a=E.getElementById(t.container)),this.container=E.createElement("DIV"),this.container.className="osmb",0===a.offsetHeight&&(a.style.height="100%",console.warn("Container height should be set. Now defaults to 100%.")),a.appendChild(this.container),this.canvas=E.createElement("CANVAS"),this.canvas.className="osmb-viewport";this.canvas.width=this.width=1*a.offsetWidth,this.canvas.height=this.height=1*a.offsetHeight,this.container.appendChild(this.canvas),this.glx=new n(this.canvas,t.fastMode),f=this.glx.GL,this.features=new k,this.markers=new o,this.events=new p(this.canvas),this._getStateFromUrl(),t.state&&(this._setStateToUrl(),this.events.on("change",e=>{this._setStateToUrl()})),this._attribution=E.createElement("DIV"),this._attribution.className="osmb-attribution",this.container.appendChild(this._attribution),this._updateAttribution(),this.setDate(new Date),fe.start(),this.emit("load",this)}appendTo(){}on(e,t){this.events.on(e,t)}off(e,t){this.events.off(e,t)}emit(e,t){this.events.emit(e,t)}setDate(e){ce.setDate("string"==typeof e?new Date(e):e)}project(e,t,r){const i=S*Math.cos(this.position.latitude/180*Math.PI),n=[(t-this.position.longitude)*i,-(e-this.position.latitude)*S,r];let o=X(fe.viewProjMatrix.data,n);return{x:(o=se(ae(o,[1,1,1]),.5))[0]*this.width,y:(1-o[1])*this.height,z:o[2]}}unproject(e,t){const r=n.Matrix.invert(fe.viewProjMatrix.data);let i=[e/this.width,1-t/this.height];const o=V((i=c(m(i,2),[-1,-1,-1]))[0],i[1],r);if(void 0===o)return;const a=S*Math.cos(this.position.latitude/180*Math.PI);return{latitude:this.position.latitude-o[1]/S,longitude:this.position.longitude+o[0]/a}}remove(e){e.destroy&&e.destroy()}addOBJ(e,t,r={}){return r.position=t,new G("OBJ",e,r)}addGeoJSON(e,t){return new G("GeoJSON",e,t)}addGeoJSONTiles(e,t={}){return t.fixedZoom=t.fixedZoom||15,this.dataGrid=new I(e,U,t,2),this.dataGrid}addMapTiles(e){return this.basemapGrid=new I(e,N,{},4),this.basemapGrid}highlight(e){this.features.setTintCallback(e)}hide(e){this.features.setZScaleCallback(e)}show(){}getTarget(){}screenshot(){}_updateAttribution(){const e=[];this.attribution&&e.push(this.attribution),this._attribution.innerHTML=e.join("  ")}_getStateFromUrl(){const e=location.search,t={};e&&e.substring(1).replace(/(?:^|&)([^&=]*)=?([^&]*)/g,(e,r,i)=>{r&&(t[r]=i)}),this.setPosition(void 0!==t.lat&&void 0!==t.lon?{latitude:t.lat,longitude:t.lon}:this.position),this.setZoom(void 0!==t.zoom?t.zoom:this.zoom),this.setRotation(void 0!==t.rotation?t.rotation:this.rotation),this.setTilt(void 0!==t.tilt?t.tilt:this.tilt)}_setStateToUrl(){history.replaceState&&!this.stateDebounce&&(this.stateDebounce=setTimeout(()=>{this.stateDebounce=null;const e=[];e.push("lat="+this.position.latitude.toFixed(6)),e.push("lon="+this.position.longitude.toFixed(6)),e.push("zoom="+this.zoom.toFixed(1)),e.push("tilt="+this.tilt.toFixed(1)),e.push("rotation="+this.rotation.toFixed(1)),history.replaceState({},"","?"+e.join("&"))},1e3))}setDisabled(e){this.events.isDisabled=!!e}isDisabled(){return!!this.events.isDisabled}getBounds(){return fe.getViewQuad().map(e=>q(e))}setZoom(e,t){e=parseFloat(e),e=Math.max(e,this.minZoom),e=Math.min(e,this.maxZoom),this.zoom!==e&&(this.zoom=e,this.events.emit("zoom",{zoom:e}),this.events.emit("change"))}getZoom(){return this.zoom}setPosition(e){const t=parseFloat(e.latitude),r=parseFloat(e.longitude);isNaN(t)||isNaN(r)||(this.position={latitude:R(t,-90,90),longitude:R(r,-180,180)},this.events.emit("change"))}getPosition(){return this.position}setSize(e,t){e===this.width&&t===this.height||(this.width=e,this.height=t,this.events.emit("resize",{width:this.width,height:this.height}))}getSize(){return{width:this.width,height:this.height}}setRotation(e){e=parseFloat(e)%360,this.rotation!==e&&(this.rotation=e,this.events.emit("rotate",{rotation:e}),this.events.emit("change"))}getRotation(){return this.rotation}setTilt(e){e=R(parseFloat(e),0,b),this.tilt!==e&&(this.tilt=e,this.events.emit("tilt",{tilt:e}),this.events.emit("change"))}getTilt(){return this.tilt}addMarker(e){return new s(e)}destroy(){fe.destroy(),this.events.destroy(),this.glx.destroy(),this.canvas.parentNode.removeChild(this.canvas),this.features.destroy(),this.markers.destroy(),this.container.innerHTML=""}}function c(e,t){return[e[0]+t[0],e[1]+t[1]]}function m(e,t){return[e[0]*t,e[1]*t]}function g(e){const t=e.target.getBoundingClientRect();return{x:e.x-t.left,y:e.y-t.top}}function x(e,t,r){e.addEventListener(t,r,!1)}d.VERSION="4.0.0",d.ATTRIBUTION='<a href="https://osmbuildings.org/"> OSM Buildings</a>',"function"==typeof define?define([],d):"object"==typeof module?module.exports=d:window.OSMBuildings=d;class p{constructor(e){this.window=top||window,this.listeners={},this.isDisabled=!1,this.prevX=0,this.prevY=0,this.startZoom=0,this.prevRotation=0,this.prevTilt=0,this.startDist=0,this.startAngle=0,this.buttons=0,this.addAllListeners(this.window,e)}addAllListeners(e,t){const r=e.document;let i;"ontouchstart"in e?(x(t,"touchstart",e=>{this.onTouchStart(e)}),x(r,"touchmove",e=>{this.onTouchMoveDocument(e)}),x(t,"touchmove",e=>{this.onTouchMove(e)}),x(r,"touchend",e=>{this.onTouchEndDocument(e)}),x(r,"gesturechange",e=>{this.onGestureChangeDocument(e)})):(x(t,"mousedown",e=>{this.onMouseDown(e)}),x(r,"mousemove",e=>{this.onMouseMoveDocument(e)}),x(t,"mousemove",e=>{this.onMouseMove(e)}),x(r,"mouseup",e=>{this.onMouseUpDocument(e)}),x(t,"mouseup",e=>{this.onMouseUp(e)}),x(t,"dblclick",e=>{this.onDoubleClick(e)}),x(t,"mousewheel",e=>{this.onMouseWheel(e)}),x(t,"DOMMouseScroll",e=>{this.onMouseWheel(e)}),x(t,"contextmenu",e=>{this.onContextMenu(e)})),x(window,"resize",e=>{i||(i=setTimeout(()=>{i=null,l.setSize(l.container.offsetWidth,l.container.offsetHeight)},250))})}cancelEvent(e){e.preventDefault&&e.preventDefault(),e.returnValue=!1}onDoubleClick(e){fe.speedUp(),this.cancelEvent(e),this.emit("doubleclick",{...g(e),buttons:e.buttons}),this.isDisabled||l.setZoom(l.zoom+1,e)}onMouseDown(e){fe.speedUp(),this.cancelEvent(e),this.startZoom=l.zoom,this.prevRotation=l.rotation,this.prevTilt=l.tilt,this.prevX=e.clientX,this.prevY=e.clientY,1===e.buttons&&e.altKey||2===e.buttons?this.buttons=2:1===e.buttons&&(this.buttons=1),this.emit("pointerdown",{...g(e),buttons:e.buttons})}onMouseMoveDocument(e){1===this.buttons?(fe.speedUp(),this.moveMap(e)):2===this.buttons&&(fe.speedUp(),this.rotateMap(e)),this.prevX=e.clientX,this.prevY=e.clientY}onMouseMove(e){this.emit("pointermove",g(e))}onMouseUpDocument(e){this.buttons&&(1===this.buttons?this.moveMap(e):2===this.buttons&&this.rotateMap(e),this.buttons=0)}onMouseUp(e){const t=g(e);fe.Picking.getTargets(t.x,t.y,t=>{this.emit("pointerup",{buttons:e.buttons,targets:t})})}onMouseWheel(e){fe.speedUp(),this.cancelEvent(e);let t=0;if(e.wheelDeltaY?t=e.wheelDeltaY:e.wheelDelta?t=e.wheelDelta:e.detail&&(t=-e.detail),!this.isDisabled){const r=.2*(t>0?1:t<0?-1:0);l.setZoom(l.zoom+r,e)}}onContextMenu(e){this.cancelEvent(e)}moveMap(e){if(this.isDisabled)return;const t=.86*Math.pow(2,-l.zoom),r=1/Math.cos(l.position.latitude/180*Math.PI),i=e.clientX-this.prevX,n=e.clientY-this.prevY,o=l.rotation*Math.PI/180,a=[Math.cos(o),Math.sin(o)],s=[Math.cos(o-Math.PI/2),Math.sin(o-Math.PI/2)],u=c(m(a,i),m(s,-n)),h={longitude:l.position.longitude-u[0]*t*r,latitude:l.position.latitude+u[1]*t};l.setPosition(h),this.emit("move",h)}rotateMap(e){this.isDisabled||(this.prevRotation+=(e.clientX-this.prevX)*(360/this.window.innerWidth),this.prevTilt-=(e.clientY-this.prevY)*(360/this.window.innerHeight),l.setRotation(this.prevRotation),l.setTilt(this.prevTilt))}emitGestureChange(e){const t=e.touches[0],r=e.touches[1],i=t.clientX-r.clientX,n=t.clientY-r.clientY,o=i*i+n*n,a=Math.atan2(n,i);this.onGestureChangeDocument({rotation:(a-this.startAngle)*(180/Math.PI)%360,scale:Math.sqrt(o/this.startDist)})}onTouchStart(e){fe.speedUp(),this.cancelEvent(e),this.buttons=1;const t=e.touches[0];if(2===e.touches.length&&!("ongesturechange"in this.window)){const r=e.touches[1],i=t.clientX-r.clientX,n=t.clientY-r.clientY;this.startDist=i*i+n*n,this.startAngle=Math.atan2(n,i)}this.startZoom=l.zoom,this.prevRotation=l.rotation,this.prevTilt=l.tilt,this.prevX=t.clientX,this.prevY=t.clientY,this.emit("pointerdown",{x:e.x,y:e.y,buttons:1})}onTouchMoveDocument(e){if(!this.buttons)return;fe.speedUp();const t=e.touches[0];e.touches.length>1?(l.setTilt(this.prevTilt+(this.prevY-t.clientY)*(360/this.window.innerHeight)),this.prevTilt=l.tilt,"ongesturechange"in this.window||this.emitGestureChange(e)):this.moveMap(t),this.prevX=t.clientX,this.prevY=t.clientY}onTouchMove(e){1===e.touches.length&&this.emit("pointermove",{...g(e.touches[0]),buttons:1})}onTouchEndDocument(e){if(!this.buttons)return;const t=e.touches[0];if(0===e.touches.length){this.buttons=0;const t=g(e);fe.Picking.getTargets(t.x,t.y,e=>{this.emit("pointerup",{buttons:1,targets:e})})}else 1===e.touches.length&&(this.prevX=t.clientX,this.prevY=t.clientY)}onGestureChangeDocument(e){this.buttons&&(fe.speedUp(),this.cancelEvent(e),this.isDisabled||(l.setZoom(this.startZoom+(e.scale-1)),l.setRotation(this.prevRotation-e.rotation)),this.emit("gesture",e))}on(e,t){(this.listeners[e]||(this.listeners[e]=[])).push(t)}off(e,t){this.listeners[e]=(this.listeners[e]||[]).filter(e=>e!==t)}emit(e,t){void 0!==this.listeners[e]&&setTimeout(()=>{this.listeners[e].forEach(e=>e(t))},0)}destroy(){this.listeners={}}}const v=14.5,w=22,b=55;var T=256,A=25,y=(e.parse("rgb(220, 210, 200)").toArray(),"#e8e0d8"),M="#efe8e0",E=window.document,P=6378137*Math.PI*2,S=P/360,D=2048,B="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABAAQMAAACQp+OdAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAB3RJTUUH3wwCCAUQLpaUSQAAABl0RVh0Q29tbWVudABDcmVhdGVkIHdpdGggR0lNUFeBDhcAAAAGUExURebm5v///zFES9kAAAAcSURBVCjPY/gPBQyUMh4wAAH/KAPCoFaoDnYGAAKtZsamTRFlAAAAAElFTkSuQmCC",C="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAAEACAYAAABccqhmAAAACXBIWXMAAA3XAAAN1wFCKJt4AAAAB3RJTUUH4gUHDxACbf+ToAAABKBJREFUeNrt3YFtKjEURFGWBmiE/iuhka0AOgCxWpDte04DP/nxG88zkbJdWMLjdnv+89+77/vmf31+foiGXDgIAAy8QBAAGHiBIAAw9MJAAGDohYEAwNALAwGAwRcEAgCDLwgEAAZfEAgADL4gEAAGH0EgAAw+gkAAGHwEgQAw/AgBAWDwEQQCwPAjBASA4UcICACDjyAQAIYfISAADD9CQAAYfoSAADD4CAIBYPgRAgLA8CMEBIDhRwgIAMOPEBAAhh8hcIqrHzd0ZZLO7Y8WEA0Aw48QiAaA4UcIRAPA8CMEogFg+BECn/kUAMKWTDW3P1pANAAMP0LACgDUGoDbHy0gGgCGHyFgBQBqDcDtjxagAQC1BuD2RwvQAIBaA3D7owVoAECtAbj90QI0AKDWANz+aAEaAFBrAG5/tAANABAAQGYFUP+xBmgAgAAAMiuA+o81QAMABACQWQHUf6wBGgAgAAABAKz/BmD/xzuABgAIAEAAAOu/Adj/8Q6gAQACABAAgAAABAAgAIAjhv14wkeArGTUjwI1ALACAAIAEACAAAAEACAAAAEACABAAAACABAAgAAABAAgAAABAAgAQAAAAgAQAIAAAAQAIAAAAQD8zjbyF+ePg7CCUf8oiAYAVgBAAAACAOjYRv8CPQQys5EfADUAsAIAAgDwBuAdABr7vwYAVgDACmANgFT91wDACgAIAJUKBADQuawEAIRNV6t9GoDbXwMABACQWgGsAaj/GgBQDQC/EwAaALiUBABw1NRV2mMgbn8NACgGgMdA0ADAJSQAgG8tUaE9BuL21wCAYgPQAnD7awBAtQFoAbj9NQCgGgB+MQg0AHDJVANACwANAFwuAgB4Z9m67CNB3P4aAFBsAFoAbn8NAKg2AC0At78GAFQbgBaA218DAKoNQAvA7R8PACGA4bcCANUGoAXg9tcAgGoD0AJw+2sAQLUBaAG4/TUA0ADK37wWQPn21wBAA2jTAtz+5e9fA8DwCwCHAKwAVgEEvwYAaABaAG5/DQDQALQA3P4aABh+AeCQgBXAKoBg1wAADUALwO2vAYDhFwAOD1gBrAIIcA0A0AC0ANz+GgAYfgHgUIEAAEEtABwu+DMH+gAPggJaAwDDLwAcNrACWAUQyBoAGH4B4PCBAAAB7A3AWwCGXwNwGEEAgMAVAA4leAPwHoCg1QDA8AsAhxSsAFYBBKsGAIZfADi0IAAQpHgD8BZg+NEAHGIQAAhOrABWAcOPBuBQgwBAUGIFsAoYfjQAhxwEAIIRK4BVwPCjATj0IAAQhFYArAKGXwPAECAAQPBZAbAKGH4BgBAw/FYADAcCAAScFQCrgOHXADAsCAAQaFYArAKGXwPA8CAAQIBZAciuAoZfABANAcNvBcBQIQAQVFgBSKwChl8DwJAhABBMWAFIrAKGXwAQDQHDbwXA8CEAEEBYAUisAoZfA8BNjABA4GAFILEKGH4BQDQEDL8VAPUcAYBgwQpAYhUw/AKAaAgYfisAajsaALUmIEA0ALQHBACGGSsAiVVAYAgAoiFg+K0AWBUQABhyrAAkVgHBAMEQmPEPj3KeFy7fLVanpR7MAAAAAElFTkSuQmCC";function F(e,t){if(!e)throw t}function _(e,t){var r=[];for(var i in e)r.push([e[i][0],e[i][1],t]);return r}function R(e,t,r){return Math.min(r,Math.max(e,t))}class I{constructor(e,t,r={},i=2){this.source=e,this.tileClass=t,this.tiles={},this.buffer=1,this.queue=[];for(let e=0;e<i;e++)this.queueNext();this.update(),this.fixedZoom=r.fixedZoom,this.bounds=r.bounds||{w:-180,s:-90,e:180,n:90},this.minZoom=Math.max(parseFloat(r.minZoom||l.minZoom),l.minZoom),this.maxZoom=Math.min(parseFloat(r.maxZoom||l.maxZoom),l.maxZoom),this.maxZoom<this.minZoom&&(this.minZoom=l.minZoom,this.maxZoom=l.maxZoom)}getURL(e,t,r){const i="abcd"[(e+t)%4];return n=this.source,o={s:i,x:e,y:t,z:r},n.replace(/\{(\w+)\}/g,function(e,t){return o[t]||e});var n,o}getClosestTiles(e,t){return e}mergeTiles(e,t,r){const i={},n={},o=[];let a;if(0===t||t<=this.minZoom){for(a in e)e[a][2]=t;return e}for(a in e){const s=e[a],u=(s[0]<<0)/2,h=(s[1]<<0)/2;if(void 0===i[[u,h]]){const e=Q(u,h,t-1,fe.viewProjMatrix);i[[u,h]]=e<r}i[[u,h]]||void 0===n[[s[0],s[1]]]&&(n[[s[0],s[1]]]=!0,o.push([s[0],s[1],t]))}let s=[];for(a in i)if(i[a]){const e=a.split(",");s.push([parseInt(e[0]),parseInt(e[1]),t-1])}return s.length>0&&(s=this.mergeTiles(s,t-1,r)),o.concat(s)}getDistance(e,t){const r=e[0]-t[0],i=e[1]-t[1];return r*r+i*i}update(){if(l.zoom<this.minZoom||l.zoom>this.maxZoom)return;const e=Math.round(this.fixedZoom||l.zoom);let t=fe.getViewQuad(fe.viewProjMatrix.data),r=J([l.position.longitude,l.position.latitude],1<<e);for(let r=0;r<4;r++)t[r]=W(t[r],e);let i=function(e){F(4==e.length,"Error: Quadrilateral with more or less than four vertices");var t=Z(e[0],e[1],e[2]),r=Z(e[0],e[2],e[3]);return t.concat(r)}(t);const n={};(i=this.fixedZoom?this.getClosestTiles(i,r):this.mergeTiles(i,e,.5*T*T)).forEach(t=>{void 0===t[2]&&(t[2]=e),n[t.join(",")]=!0}),this.visibleTiles=n;for(let e in n){const t=e.split(","),r=parseInt(t[0]),i=parseInt(t[1]),n=parseInt(t[2]);this.tiles[e]||(this.tiles[e]=new this.tileClass(r,i,n),this.queue.push(this.tiles[e]))}this.purge(n),this.queue.forEach(e=>{e.distance=this.getDistance([e.x,e.y],r)}),this.queue.sort((e,t)=>t.distance-e.distance),setTimeout(()=>{this.update()},100)}queueNext(){if(!this.queue.length)return void setTimeout(this.queueNext.bind(this),200);const e=this.queue.pop();e.load(this.getURL(e.x,e.y,e.zoom),()=>{this.queueNext()})}purge(e){const t=Math.round(l.zoom);for(let r in this.tiles){let i=this.tiles[r];if(!e[r])if(this.fixedZoom)this.tiles[r].destroy(),delete this.tiles[r];else{if(i.zoom===t+1){if(e[[i.x/2<<0,i.y/2<<0,t].join(",")])continue}i.zoom===t-1&&(e[[2*i.x,2*i.y,t].join(",")]||e[[2*i.x+1,2*i.y,t].join(",")]||e[[2*i.x,2*i.y+1,t].join(",")]||e[[2*i.x+1,2*i.y+1,t].join(",")])||delete this.tiles[r]}}this.queue=this.queue.filter(e=>!!e)}destroy(){for(let e in this.tiles)this.tiles[e].destroy();this.tiles={},this.queue=[]}}class L{constructor(e,t,r){this.x=e,this.y=t,this.zoom=r,this.key=[e,t,r].join(","),this.distance=1/0}load(){}destroy(){}}class N extends L{constructor(e,t,r){super(e,t,r),this.latitude=$(t,r),this.longitude=K(e,r);const i=j(this.latitude,r),o=[i,i,0,i,0,0,0,i,0,0,0,0];this.vertexBuffer=new n.Buffer(3,new Float32Array(o)),this.texCoordBuffer=new n.Buffer(2,new Float32Array([1,0,1,1,0,0,0,1]))}load(e,t){this.texture=(new n.texture.Image).load(e,e=>{e&&(f.bindTexture(f.TEXTURE_2D,this.texture.id),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_S,f.CLAMP_TO_EDGE),f.texParameteri(f.TEXTURE_2D,f.TEXTURE_WRAP_T,f.CLAMP_TO_EDGE),this.isReady=!0),t&&t()})}destroy(){this.vertexBuffer.destroy(),this.texCoordBuffer.destroy(),this.texture&&this.texture.destroy()}}class U extends L{constructor(e,t,r,i){super(e,t,r),this.options=i}load(e,t){this.content=new G("GeoJSON",e,this.options,t)}destroy(){this.content&&this.content.destroy()}}class k extends o{constructor(...e){super(...e),this.tintCallback=(()=>{}),this.zScaleCallback=(()=>{})}setTintCallback(e){this.tintCallback=e,this.forEach(e=>{e.applyTintAndZScale()})}setZScaleCallback(e){this.zScaleCallback=e,this.forEach(e=>{e.applyTintAndZScale()})}}class G{constructor(e,t,r={},i=function(){}){this.type=e,this.url=t,this.options=r,this.callback=i,this.id=r.id,this.color=r.color,this.matrix=new n.Matrix,this.translate(0,0,r.elevation||0),this.scale(r.scale||1),this.rotate(r.rotation||0),this.minZoom=Math.max(parseFloat(r.minZoom||v),l.minZoom),this.maxZoom=Math.min(parseFloat(r.maxZoom||w),l.maxZoom),this.maxZoom<this.minZoom&&(this.minZoom=v,this.maxZoom=w),this.load()}load(){l.workers.get(e=>{e.onMessage(t=>{if("error"===t)return this.callback(),void e.free();"load"!==t?(this.onLoad(t),e.free()):this.callback()}),e.postMessage({type:this.type,url:this.url,options:this.options})})}onLoad(e){this.position=e.position,this.prevX=0,this.prevY=0,this.vertexBuffer=new n.Buffer(3,e.vertices),this.timer=setTimeout(()=>{this.normalBuffer=new n.Buffer(3,e.normals),this.timer=setTimeout(()=>{this.colorBuffer=new n.Buffer(3,e.colors),this.timer=setTimeout(()=>{this.texCoordBuffer=new n.Buffer(2,e.texCoords),this.timer=setTimeout(()=>{this.heightBuffer=new n.Buffer(1,e.heights),this.timer=setTimeout(()=>{this.pickingBuffer=new n.Buffer(3,e.pickingColors),this.timer=setTimeout(()=>{this.items=e.items,this.applyTintAndZScale(),l.features.add(this),this.fade=0},20)},20)},20)},20)},20)},20)}translate(e=0,t=0,r=0){this.matrix.translate(e,t,r)}scale(e){this.matrix.scale(e,e,e)}rotate(e){this.matrix.rotateZ(-e)}getMatrix(){const e=this.position.longitude-l.position.longitude,t=this.position.latitude-l.position.latitude,r=e-this.prevX,i=t-this.prevY,n=S*Math.cos(l.position.latitude/180*Math.PI);return this.matrix.translate(r*n,-i*S,0),this.prevX=e,this.prevY=t,this.matrix}getFade(){if(this.fade>=1)return 1;fe.speedUp();const e=this.fade;return this.fade+=1/60,e}applyTintAndZScale(){const t=[],r=l.features.tintCallback,i=[],o=l.features.zScaleCallback;this.items.forEach(n=>{const a={id:n.id,properties:n.properties},s=r(a),u=s?[...e.parse(s).toArray(),1]:[0,0,0,0],h=o(a);for(let e=0;e<n.vertexCount;e++)t.push(...u),i.push(h?0:1)}),this.tintBuffer=new n.Buffer(4,new Float32Array(t)),this.zScaleBuffer=new n.Buffer(1,new Float32Array(i))}destroy(){l.features.remove(this),clearTimeout(this.timer),this.vertexBuffer&&this.vertexBuffer.destroy(),this.normalBuffer&&this.normalBuffer.destroy(),this.colorBuffer&&this.colorBuffer.destroy(),this.texCoordBuffer&&this.texCoordBuffer.destroy(),this.heightBuffer&&this.heightBuffer.destroy(),this.pickingBuffer&&this.pickingBuffer.destroy(),this.tintBuffer&&this.tintBuffer.destroy(),this.zScaleBuffer&&this.zScaleBuffer.destroy(),this.items=[]}}class H{constructor(){this.size=5e3,this.minZoom=l.minZoom,this.maxZoom=l.maxZoom,this.matrix=new n.Matrix,this.createGeometry()}createGeometry(){const e=2*this.size/50,t=[0,0,1],r=[...t,...t,...t,...t,...t,...t],i=[],o=[],a=[];for(let t=0;t<50;t++)for(let n=0;n<50;n++){const s=-this.size+t*e,u=-this.size+n*e;i.push(s,u,0,s+e,u+e,0,s+e,u,0,s,u,0,s,u+e,0,s+e,u+e,0),o.push(...r),a.push(1,1,1,1,1,1)}this.vertexBuffer=new n.Buffer(3,new Float32Array(i)),this.normalBuffer=new n.Buffer(3,new Float32Array(o)),this.zScaleBuffer=new n.Buffer(1,new Float32Array(a))}getFade(){return 1}getMatrix(){return this.matrix}destroy(){this.vertexBuffer.destroy(),this.normalBuffer.destroy()}}function F(e,t){if(!e)throw t}function O(e,t,r){var i=[e[0]<t[0]?1:-1,e[1]<t[1]?1:-1],n=r[0]+(e[0]<t[0]?1:0),o=r[1]+(e[1]<t[1]?1:0),a=(n-e[0])/(t[0]-e[0]),s=(o-e[1])/(t[1]-e[1]);return(a<=0||a>1)&&(s<=0||s>1)?[void 0,void 0]:a<=0||a>1?[r[0],r[1]+i[1]]:s<=0||s>1?[r[0]+i[0],r[1]]:a<s?[r[0]+i[0],r[1]]:[r[0],r[1]+i[1]]}function Z(e,t,r){var i=[e,t,r];if(i.sort(function(e,t){return e[1]<t[1]}),e=i[0],t=i[1],r=i[2],e[1]==t[1])return z(e,t,r);if(t[1]==r[1])return z(t,r,e);var n=(t[1]-e[1])/(r[1]-e[1]),o=[e[0]+n*(r[0]-e[0]),t[1]];return z(o,t,e).concat(z(o,t,r))}function z(e,t,r){var i=[];if(F(e[1]===t[1],"not a flat triangle"),F(r[1]!==e[1],"not a triangle"),F(e[0]!==t[0],"not a triangle"),e[0]>t[0]){var n=e;e=t,t=n}var o=[r[0]<<0,r[1]<<0],a=o.slice(0);i.push(o.slice(0));for(var s,u,h=r[1]<e[1]?1:-1,l=o[1],f=(e[1]<<0)+h,d=l;d*h<f*h;d+=h){do{i.push(o.slice(0)),s=o,o=O(r,e,o)}while(o[1]*h<=d*h);o=s;do{i.push(a.slice(0)),u=a,a=O(r,t,a)}while(a[1]*h<=d*h);a=u;for(var c=o[0];c<=a[0];c++)i.push([c,d])}return i}function X(e,t){var r=t[0]*e[0]+t[1]*e[4]+t[2]*e[8]+e[12],i=t[0]*e[1]+t[1]*e[5]+t[2]*e[9]+e[13],n=t[0]*e[2]+t[1]*e[6]+t[2]*e[10]+e[14],o=t[0]*e[3]+t[1]*e[7]+t[2]*e[11]+e[15];return[r/o,i/o,n/o]}function V(e,t,r){var i=X(r,[e,t,0]),n=oe(X(r,[e,t,1]),i);if(!(n[2]>=0)){var o=ae(i,se(n,-i[2]/n[2]));return[o[0],o[1]]}}function Q(e,t,r,i){var o=S*Math.cos(l.position.latitude/180*Math.PI),a=K(e,r),s=$(t,r),u=new n.Matrix;u.translate((a-l.position.longitude)*o,-(s-l.position.latitude)*S,0);var h,f=j(l.position.latitude,r),d=n.Matrix.multiply(u,i),c=X(d,[0,0,0]),m=X(d,[f,0,0]),g=X(d,[0,f,0]),x=X(d,[f,f,0]),p=[c,m,g,x];for(var v in p)p[v][0]=(p[v][0]+1)/2*l.width,p[v][1]=(p[v][1]+1)/2*l.height;return Y((h=[c,m,x,g])[0],h[1],h[2])+Y(h[0],h[2],h[3])}function Y(e,t,r){var i=ee(re(e,t)),n=ee(re(e,r)),o=ee(re(t,r)),a=.5*(i+n+o);return Math.sqrt(a*(a-i)*(a-n)*(a-o))}function j(e,t){return P*Math.cos(e/180*Math.PI)/Math.pow(2,t)}function q(e){var t=S*Math.cos(l.position.latitude/180*Math.PI);return{longitude:l.position.longitude+e[0]/t,latitude:l.position.latitude-e[1]/S}}function W(e,t){const r=q(e);return J([r.longitude,r.latitude],1<<t)}function J(e,t=1){return[(e[0]/360+.5)*t,(1-Math.log(Math.tan(e[1]*Math.PI/180)+1/Math.cos(e[1]*Math.PI/180))/Math.PI)/2*t]}function K(e,t){return e/Math.pow(2,t)*360-180}function $(e,t){var r=Math.PI-2*Math.PI*e/Math.pow(2,t);return 180/Math.PI*Math.atan(.5*(Math.exp(r)-Math.exp(-r)))}function ee(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1])}function te(e,t){return e[0]*t[0]+e[1]*t[1]}function re(e,t){return[e[0]-t[0],e[1]-t[1]]}function c(e,t){return[e[0]+t[0],e[1]+t[1]]}function m(e,t){return[e[0]*t,e[1]*t]}function ie(e){var t=ee(e);return[e[0]/t,e[1]/t]}function ne(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function oe(e,t){return[e[0]-t[0],e[1]-t[1],e[2]-t[2]]}function ae(e,t){return[e[0]+t[0],e[1]+t[1],e[2]+t[2]]}function se(e,t){return[e[0]*t,e[1]*t,e[2]*t]}function ue(e){return Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])}function he(e){var t=ue(e);return[e[0]/t,e[1]/t,e[2]/t]}function le(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}class fe{constructor(){this.metersPerDegreeLongitude=S*Math.cos(l.position.latitude/180*Math.PI)}static getViewQuad(){return function(e,t,r){const i=n.Matrix.invert(e);let o,a,s,u,h,l=V(-1,-1,i),f=V(1,-1,i),d=V(1,1,i),g=V(-1,1,i);if(l&&f)return g&&d||(h=te(o=ie(re(s=V(-1,-.9,i),l)),r),g=c(l,m(o,t/h)),h=te(a=ie(re(u=V(1,-.9,i),f)),r),d=c(f,m(a,t/h))),te(r,re(g,l))>t&&(h=te(o=ie(re(g,l)),r),g=c(l,m(o,t/h))),te(r,re(d,f))>t&&(h=te(a=ie(re(d,f)),r),d=c(f,m(a,t/h))),[l,f,d,g]}(this.viewProjMatrix.data,this.fogDistance+this.fogBlurDistance,this.viewDirOnMap)}static start(){fe.effects={shadows:!0},this.metersPerDegreeLongitude=S*Math.cos(l.position.latitude/180*Math.PI),f.depthTextureExtension||(console.warn("Shadows are disabled because your GPU does not support WEBGL_depth_texture"),fe.effects.shadows=!1),this.setupViewport(),f.cullFace(f.BACK),f.enable(f.CULL_FACE),f.enable(f.DEPTH_TEST),fe.Picking=new de,fe.Horizon=new ve,fe.Buildings=new me,fe.Marker=new be,fe.Basemap=new xe,fe.Overlay.init(),fe.AmbientMap.init(),fe.blurredAmbientMap=new we,fe.MapShadows=new ge,fe.effects.shadows&&(fe.cameraGBuffer=new pe,fe.sunGBuffer=new pe),this.speedUp(),this.renderFrame()}static renderFrame(){l.zoom>=l.minZoom&&l.zoom<=l.maxZoom&&requestAnimationFrame(()=>{this.setupViewport(),this.metersPerDegreeLongitude=S*Math.cos(l.position.latitude/180*Math.PI),f.clearColor(this.fogColor[0],this.fogColor[1],this.fogColor[2],0),f.clear(f.COLOR_BUFFER_BIT|f.DEPTH_BUFFER_BIT);const e=[l.width,l.height];if(fe.effects.shadows){const t=this.getViewQuad();ce.updateView(t),fe.Horizon.updateGeometry(t),fe.cameraGBuffer.render(this.viewMatrix,this.projMatrix,e,!0),fe.sunGBuffer.render(ce.viewMatrix,ce.projMatrix,[D,D]),fe.AmbientMap.render(fe.cameraGBuffer.framebuffer.depthTexture,fe.cameraGBuffer.framebuffer.renderTexture,e,2),fe.blurredAmbientMap.render(fe.AmbientMap.framebuffer.renderTexture,e),fe.Buildings.render(fe.sunGBuffer.framebuffer),fe.Basemap.render(),f.enable(f.BLEND),f.blendFuncSeparate(f.ZERO,f.SRC_COLOR,f.ZERO,f.ONE),fe.MapShadows.render(ce,fe.sunGBuffer.framebuffer,.5),fe.Overlay.render(fe.blurredAmbientMap.framebuffer.renderTexture,e),f.blendFuncSeparate(f.ONE_MINUS_DST_ALPHA,f.DST_ALPHA,f.ONE,f.ONE),f.disable(f.DEPTH_TEST),fe.Horizon.render(),f.enable(f.DEPTH_TEST),f.disable(f.BLEND),fe.Marker.render()}else fe.Buildings.render(),fe.MarkerRender.render(),f.enable(f.BLEND),f.blendFuncSeparate(f.ONE_MINUS_DST_ALPHA,f.DST_ALPHA,f.ONE,f.ONE),f.disable(f.DEPTH_TEST),fe.Horizon.render(),f.disable(f.BLEND),f.enable(f.DEPTH_TEST),fe.Basemap.render();this.isFast?this.renderFrame():setTimeout(()=>{this.renderFrame()},250)})}static setupViewport(){f.canvas.width!==l.width&&(f.canvas.width=l.width),f.canvas.height!==l.height&&(f.canvas.height=l.height);const e=1.3567*Math.pow(2,l.zoom-17),t=l.width,r=l.height;f.viewport(0,0,t,r),this.viewMatrix=(new n.Matrix).rotateZ(l.rotation).rotateX(l.tilt).translate(0,8/e,0).translate(0,0,-1220/e),this.viewDirOnMap=[Math.sin(l.rotation/180*Math.PI),-Math.cos(l.rotation/180*Math.PI)];const i=1024/(2*Math.tan(.125*Math.PI)),o=2*Math.atan(r/2/i)/Math.PI*180;this.nearPlane=1,this.farPlane=3e4,this.projMatrix=(new n.Matrix).translate(0,-r/(2*e),0).scale(1,-1,1).multiply(new n.Matrix.Perspective(o,t/r,this.nearPlane,this.farPlane)).translate(0,-1,0),this.viewProjMatrix=new n.Matrix(n.Matrix.multiply(this.viewMatrix,this.projMatrix)),this.lowerLeftOnMap=V(-1,-1,n.Matrix.invert(this.viewProjMatrix.data)),void 0!==this.lowerLeftOnMap&&(this.fogDistance=5e3,this.fogBlurDistance=1e4)}static speedUp(){this.isFast=!0,clearTimeout(this.speedTimer),this.speedTimer=setTimeout(()=>{this.isFast=!1},1e3)}static destroy(){fe.Picking.destroy(),fe.Horizon.destroy(),fe.Buildings.destroy(),fe.Marker.destroy(),fe.Basemap.destroy(),fe.MapShadows.destroy(),fe.cameraGBuffer&&fe.cameraGBuffer.destroy(),fe.sunGBuffer&&fe.sunGBuffer.destroy(),fe.AmbientMap.destroy(),fe.blurredAmbientMap.destroy(),clearTimeout(this.speedTimer)}}class de{constructor(){this.size=[512,512],this.shader=new n.Shader({vertexShader:r.picking.vertex,fragmentShader:r.picking.fragment,shaderName:"picking shader",attributes:["aPosition","aPickingColor","aZScale"],uniforms:["uModelMatrix","uMatrix","uFogDistance","uFade","uIndex"]}),this.framebuffer=new n.Framebuffer(this.size[0],this.size[1])}getTargets(e,t,r){requestAnimationFrame(()=>{const i=this.shader;i.enable(),this.framebuffer.enable(),f.viewport(0,0,this.size[0],this.size[1]),f.clearColor(0,0,0,1),f.clear(f.COLOR_BUFFER_BIT|f.DEPTH_BUFFER_BIT),i.setParam("uFogDistance","1f",fe.fogDistance);const o=[];l.features.forEach(e=>{if(l.zoom<e.minZoom||l.zoom>e.maxZoom)return;let t=e.getMatrix();t&&(o.push(e.items),i.setParam("uFade","1f",e.getFade()),i.setParam("uIndex","1f",o.length/256),i.setMatrix("uModelMatrix","4fv",t.data),i.setMatrix("uMatrix","4fv",n.Matrix.multiply(t,fe.viewProjMatrix)),i.setBuffer("aPosition",e.vertexBuffer),i.setBuffer("aPickingColor",e.pickingBuffer),i.setBuffer("aZScale",e.zScaleBuffer),f.drawArrays(f.TRIANGLES,0,e.vertexBuffer.numItems))}),i.disable(),f.viewport(0,0,l.width,l.height);const a=e/l.width*this.size[0]<<0,s=t/l.height*this.size[1]<<0,u=this.framebuffer.getPixel(a,this.size[1]-1-s);if(this.framebuffer.disable(),!u)return void r();const h=u[0]-1,d=(u[1]|u[2]<<8)-1;if(!o[h]||!o[h][d])return void r();const c=o[h][d],m={id:c.id,properties:c.properties,parts:[]},g=c.properties.building||c.id;l.features.forEach(e=>{e.items.forEach(e=>{e.id!==g&&e.properties.building!==g||m.parts.push({id:e.id,properties:e.properties})})}),r(m)})}destroy(){this.shader.destroy(),this.framebuffer.destroy()}}var ce={setDate:function(e){var r=t(e,l.position.latitude,l.position.longitude);this.direction=[-Math.sin(r.azimuth)*Math.cos(r.altitude),Math.cos(r.azimuth)*Math.cos(r.altitude),Math.sin(r.altitude)];var i=r.azimuth/(Math.PI/180),o=90-r.altitude/(Math.PI/180);this.viewMatrix=(new n.Matrix).rotateZ(i).rotateX(o).translate(0,0,-5e3).scale(1,-1,1)},updateView:function(e){this.projMatrix=function(e,t,r,i,o){for(var a=X(t.data,e[0]),s=a[0],u=a[0],h=a[1],l=a[1],f=0;f<e.length;f++){var d=X(t.data,e[f]);s=Math.min(s,d[0]),u=Math.max(u,d[0]),h=Math.max(h,d[1]),l=Math.min(l,d[1])}return new n.Matrix.Ortho(s,u,h,l,r,i)}(_(e,0).concat(_(e,100)),this.viewMatrix,1e3,7500),this.viewProjMatrix=new n.Matrix(n.Matrix.multiply(this.viewMatrix,this.projMatrix))}};class me{constructor(){this.shader=fe.effects.shadows?new n.Shader({vertexShader:r.buildings_with_shadows.vertex,fragmentShader:r.buildings_with_shadows.fragment,shaderName:"quality building shader",attributes:["aPosition","aTexCoord","aColor","aNormal","aHeight","aTintColor","aZScale"],uniforms:["uFogDistance","uFogBlurDistance","uLightColor","uLightDirection","uLowerEdgePoint","uMatrix","uModelMatrix","uSunMatrix","uShadowTexIndex","uShadowTexDimensions","uFade","uViewDirOnMap","uWallTexIndex"]}):new n.Shader({vertexShader:r.buildings.vertex,fragmentShader:r.buildings.fragment,shaderName:"building shader",attributes:["aPosition","aTexCoord","aColor","aNormal","aHeight","aTintColor","aZScale"],uniforms:["uModelMatrix","uViewDirOnMap","uMatrix","uNormalTransform","uLightColor","uLightDirection","uLowerEdgePoint","uFogDistance","uFogBlurDistance","uFade","uWallTexIndex"]}),this.wallTexture=new n.texture.Image,this.wallTexture.color([1,1,1]),this.wallTexture.load(B)}render(e){const t=this.shader;t.enable(),t.setParam("uFogDistance","1f",fe.fogDistance),t.setParam("uFogBlurDistance","1f",fe.fogBlurDistance),t.setParam("uLightColor","3fv",[.5,.5,.5]),t.setParam("uLightDirection","3fv",ce.direction),t.setParam("uLowerEdgePoint","2fv",fe.lowerLeftOnMap),t.setParam("uViewDirOnMap","2fv",fe.viewDirOnMap),fe.effects.shadows||t.setMatrix("uNormalTransform","3fv",n.Matrix.identity3().data),t.setTexture("uWallTexIndex",0,this.wallTexture),e&&(t.setParam("uShadowTexDimensions","2fv",[e.width,e.height]),t.setTexture("uShadowTexIndex",1,e.depthTexture)),l.features.forEach(e=>{if(l.zoom<e.minZoom||l.zoom>e.maxZoom)return;const r=e.getMatrix();r&&(t.setParam("uFade","1f",e.getFade()),t.setMatrix("uModelMatrix","4fv",r.data),t.setMatrix("uMatrix","4fv",n.Matrix.multiply(r,fe.viewProjMatrix)),fe.effects.shadows&&t.setMatrix("uSunMatrix","4fv",n.Matrix.multiply(r,ce.viewProjMatrix)),t.setBuffer("aPosition",e.vertexBuffer),t.setBuffer("aTexCoord",e.texCoordBuffer),t.setBuffer("aNormal",e.normalBuffer),t.setBuffer("aColor",e.colorBuffer),t.setBuffer("aHeight",e.heightBuffer),t.setBuffer("aTintColor",e.tintBuffer),t.setBuffer("aZScale",e.zScaleBuffer),f.drawArrays(f.TRIANGLES,0,e.vertexBuffer.numItems))}),t.disable()}destroy(){}}class ge{constructor(){this.shader=new n.Shader({vertexShader:r.basemap_with_shadows.vertex,fragmentShader:r.basemap_with_shadows.fragment,shaderName:"map shadows shader",attributes:["aPosition","aNormal"],uniforms:["uModelMatrix","uViewDirOnMap","uMatrix","uDirToSun","uLowerEdgePoint","uFogDistance","uFogBlurDistance","uShadowTexDimensions","uShadowStrength","uShadowTexIndex","uSunMatrix"]}),this.mapPlane=new H}render(e,t,r){const i=this.mapPlane;if(l.zoom<i.minZoom||l.zoom>i.maxZoom)return;const o=this.shader;let a;o.enable(),f.disable(f.CULL_FACE),o.setParam("uDirToSun","3fv",e.direction),o.setParam("uViewDirOnMap","2fv",fe.viewDirOnMap),o.setParam("uLowerEdgePoint","2fv",fe.lowerLeftOnMap),o.setParam("uFogDistance","1f",fe.fogDistance),o.setParam("uFogBlurDistance","1f",fe.fogBlurDistance),o.setParam("uShadowTexDimensions","2fv",[t.width,t.height]),o.setParam("uShadowStrength","1f",r),o.setTexture("uShadowTexIndex",0,t.depthTexture),(a=i.getMatrix())&&(o.setMatrix("uModelMatrix","4fv",a.data),o.setMatrix("uMatrix","4fv",n.Matrix.multiply(a,fe.viewProjMatrix)),o.setMatrix("uSunMatrix","4fv",n.Matrix.multiply(a,e.viewProjMatrix)),o.setBuffer("aPosition",i.vertexBuffer),o.setBuffer("aNormal",i.normalBuffer),f.drawArrays(f.TRIANGLES,0,i.vertexBuffer.numItems),o.disable())}destroy(){this.mapPlane.destroy()}}class xe{constructor(){this.shader=new n.Shader({vertexShader:r.basemap.vertex,fragmentShader:r.basemap.fragment,shaderName:"basemap shader",attributes:["aPosition","aTexCoord"],uniforms:["uViewMatrix","uModelMatrix","uTexIndex","uFogDistance","uFogBlurDistance","uLowerEdgePoint","uViewDirOnMap"]})}render(){const e=l.basemapGrid;if(!e)return;if(l.zoom<e.minZoom||l.zoom>e.maxZoom)return;const t=this.shader;t.enable(),t.setParam("uFogDistance","1f",fe.fogDistance),t.setParam("uFogBlurDistance","1f",fe.fogBlurDistance),t.setParam("uLowerEdgePoint","2fv",fe.lowerLeftOnMap),t.setParam("uViewDirOnMap","2fv",fe.viewDirOnMap);const r=Math.round(l.zoom);let i;for(let t in e.visibleTiles){if((i=e.tiles[t])&&i.isReady){this.renderTile(i);continue}const n=[i.x/2<<0,i.y/2<<0,r-1].join(",");if(e.tiles[n]&&e.tiles[n].isReady){this.renderTile(e.tiles[n]);continue}const o=[[2*i.x,2*i.y,i.zoom+1].join(","),[2*i.x+1,2*i.y,i.zoom+1].join(","),[2*i.x,2*i.y+1,i.zoom+1].join(","),[2*i.x+1,2*i.y+1,i.zoom+1].join(",")];for(let t=0;t<4;t++)e.tiles[o[t]]&&e.tiles[o[t]].isReady&&this.renderTile(e.tiles[o[t]])}t.disable()}renderTile(e){const t=this.shader,r=S*Math.cos(l.position.latitude/180*Math.PI),i=new n.Matrix;i.translate((e.longitude-l.position.longitude)*r,-(e.latitude-l.position.latitude)*S,0),f.enable(f.POLYGON_OFFSET_FILL),f.polygonOffset(A-e.zoom,A-e.zoom),t.setMatrix("uModelMatrix","4fv",i.data),t.setMatrix("uViewMatrix","4fv",n.Matrix.multiply(i,fe.viewProjMatrix)),t.setBuffer("aPosition",e.vertexBuffer),t.setBuffer("aTexCoord",e.texCoordBuffer),t.setTexture("uTexIndex",0,e.texture),f.drawArrays(f.TRIANGLE_STRIP,0,e.vertexBuffer.numItems),f.disable(f.POLYGON_OFFSET_FILL)}destroy(){}}fe.HudRect={init:function(){var e=this.createGeometry();this.vertexBuffer=new n.Buffer(3,new Float32Array(e.vertices)),this.texCoordBuffer=new n.Buffer(2,new Float32Array(e.texCoords)),this.shader=new n.Shader({vertexShader:r.texture.vertex,fragmentShader:r.texture.fragment,shaderName:"HUD rectangle shader",attributes:["aPosition","aTexCoord"],uniforms:["uMatrix","uTexIndex"]})},createGeometry:function(){var e=[],t=[];return e.push(0,0,1e-5,1,0,1e-5,1,1,1e-5),e.push(0,0,1e-5,1,1,1e-5,0,1,1e-5),t.push(.5,.5,1,.5,1,1),t.push(.5,.5,1,1,.5,1),{vertices:e,texCoords:t}},render:function(e){var t=this.shader;t.enable(),f.uniformMatrix4fv(t.uniforms.uMatrix,!1,n.Matrix.identity().data),this.vertexBuffer.enable(),f.vertexAttribPointer(t.attributes.aPosition,this.vertexBuffer.itemSize,f.FLOAT,!1,0,0),this.texCoordBuffer.enable(),f.vertexAttribPointer(t.attributes.aTexCoord,this.texCoordBuffer.itemSize,f.FLOAT,!1,0,0),e.enable(0),f.uniform1i(t.uniforms.uTexIndex,0),f.drawArrays(f.TRIANGLES,0,this.vertexBuffer.numItems),t.disable()},destroy:function(){}};class pe{constructor(){this.shader=new n.Shader({vertexShader:r.depth_normal.vertex,fragmentShader:r.depth_normal.fragment,shaderName:"depth/normal shader",attributes:["aPosition","aNormal","aZScale"],uniforms:["uMatrix","uModelMatrix","uNormalMatrix","uFade","uFogDistance","uFogBlurDistance","uViewDirOnMap","uLowerEdgePoint"]}),this.framebuffer=new n.Framebuffer(128,128,!0),this.mapPlane=new H}render(e,t,r){const i=this.shader,o=this.framebuffer,a=new n.Matrix(n.Matrix.multiply(e,t));o.setSize(r[0],r[1]),i.enable(),o.enable(),f.viewport(0,0,r[0],r[1]),f.clearColor(0,0,0,1),f.clear(f.COLOR_BUFFER_BIT|f.DEPTH_BUFFER_BIT),i.setParam("uViewDirOnMap","2fv",fe.viewDirOnMap),i.setParam("uLowerEdgePoint","2fv",fe.lowerLeftOnMap),i.setParam("uFogDistance","1f",fe.fogDistance),i.setParam("uFogBlurDistance","1f",fe.fogBlurDistance),l.features.items.concat([this.mapPlane]).forEach(t=>{if(l.zoom<t.minZoom||l.zoom>t.maxZoom)return;const r=t.getMatrix();r&&(i.setParam("uFade","1f",t.getFade()),i.setMatrix("uMatrix","4fv",n.Matrix.multiply(r,a)),i.setMatrix("uModelMatrix","4fv",r.data),i.setMatrix("uNormalMatrix","3fv",n.Matrix.transpose3(n.Matrix.invert3(n.Matrix.multiply(r,e)))),i.setBuffer("aPosition",t.vertexBuffer),i.setBuffer("aNormal",t.normalBuffer),i.setBuffer("aZScale",t.zScaleBuffer),f.drawArrays(f.TRIANGLES,0,t.vertexBuffer.numItems))}),i.disable(),o.disable(),f.viewport(0,0,l.width,l.height)}destroy(){this.shader.destroy(),this.framebuffer.destroy(),this.mapPlane.destroy()}}fe.AmbientMap={init:function(){this.shader=new n.Shader({vertexShader:r.ambient_from_depth.vertex,fragmentShader:r.ambient_from_depth.fragment,shaderName:"SSAO shader",attributes:["aPosition","aTexCoord"],uniforms:["uInverseTexSize","uNearPlane","uFarPlane","uDepthTexIndex","uFogTexIndex","uEffectStrength"]}),this.framebuffer=new n.Framebuffer(128,128),this.vertexBuffer=new n.Buffer(3,new Float32Array([-1,-1,1e-5,1,-1,1e-5,1,1,1e-5,-1,-1,1e-5,1,1,1e-5,-1,1,1e-5])),this.texCoordBuffer=new n.Buffer(2,new Float32Array([0,0,1,0,1,1,0,0,1,1,0,1]))},render:function(e,t,r,i){var n=this.shader,o=this.framebuffer;void 0===i&&(i=1),o.setSize(r[0],r[1]),f.viewport(0,0,r[0],r[1]),n.enable(),o.enable(),f.clearColor(1,0,0,1),f.clear(f.COLOR_BUFFER_BIT|f.DEPTH_BUFFER_BIT),n.setParam("uInverseTexSize","2fv",[1/r[0],1/r[1]]),n.setParam("uEffectStrength","1f",i),n.setParam("uNearPlane","1f",fe.nearPlane),n.setParam("uFarPlane","1f",fe.farPlane),n.setBuffer("aPosition",this.vertexBuffer),n.setBuffer("aTexCoord",this.texCoordBuffer),n.setTexture("uDepthTexIndex",0,e),n.setTexture("uFogTexIndex",1,t),f.drawArrays(f.TRIANGLES,0,this.vertexBuffer.numItems),n.disable(),o.disable(),f.viewport(0,0,l.width,l.height)},destroy:function(){}},fe.Overlay={init:function(){const e=this.createGeometry();this.vertexBuffer=new n.Buffer(3,new Float32Array(e.vertices)),this.texCoordBuffer=new n.Buffer(2,new Float32Array(e.texCoords)),this.shader=new n.Shader({vertexShader:r.texture.vertex,fragmentShader:r.texture.fragment,shaderName:"overlay texture shader",attributes:["aPosition","aTexCoord"],uniforms:["uMatrix","uTexIndex"]})},createGeometry:function(){const e=[],t=[];return e.push(-1,-1,1e-5,1,-1,1e-5,1,1,1e-5),e.push(-1,-1,1e-5,1,1,1e-5,-1,1,1e-5),t.push(0,0,1,0,1,1),t.push(0,0,1,1,0,1),{vertices:e,texCoords:t}},render:function(e,t){const r=this.shader;r.enable(),f.disable(f.DEPTH_TEST),r.setMatrix("uMatrix","4fv",n.Matrix.identity().data),r.setBuffer("aPosition",this.vertexBuffer),r.setBuffer("aTexCoord",this.texCoordBuffer),r.setTexture("uTexIndex",0,e),f.drawArrays(f.TRIANGLES,0,this.vertexBuffer.numItems),f.enable(f.DEPTH_TEST),r.disable()},destroy:function(){}};class ve{constructor(){this.HORIZON_HEIGHT=2e3,this.skyShader=new n.Shader({vertexShader:r.horizon.vertex,fragmentShader:r.horizon.fragment,shaderName:"sky wall shader",attributes:["aPosition"],uniforms:["uAbsoluteHeight","uMatrix","uFogColor"]}),this.v1=this.v2=this.v3=this.v4=[!1,!1,!1],this.updateGeometry([[0,0,0],[0,0,0],[0,0,0],[0,0,0]]),this.floorShader=new n.Shader({vertexShader:r.flat_color.vertex,fragmentShader:r.flat_color.fragment,attributes:["aPosition"],uniforms:["uColor","uMatrix"]})}updateGeometry(e){let t=[e[3][0],e[3][1],0],r=[e[2][0],e[2][1],0],i=[e[2][0],e[2][1],this.HORIZON_HEIGHT],o=[e[3][0],e[3][1],this.HORIZON_HEIGHT];if(le(t,this.v1)&&le(r,this.v2)&&le(i,this.v3)&&le(o,this.v4))return;this.v1=t,this.v2=r,this.v3=i,this.v4=o,this.skyVertexBuffer&&this.skyVertexBuffer.destroy();const a=[...t,...r,...i,...t,...i,...o];this.skyVertexBuffer=new n.Buffer(3,new Float32Array(a)),t=[e[0][0],e[0][1],1],r=[e[1][0],e[1][1],1],i=[e[2][0],e[2][1],1],o=[e[3][0],e[3][1],1],this.floorVertexBuffer&&this.floorVertexBuffer.destroy(),this.floorVertexBuffer=new n.Buffer(3,new Float32Array([...t,...r,...i,...o]))}render(){const e=this.skyShader,t=this.floorShader,r=fe.fogColor;e.enable(),e.setParam("uFogColor","3fv",r),e.setParam("uAbsoluteHeight","1f",10*this.HORIZON_HEIGHT),e.setMatrix("uMatrix","4fv",fe.viewProjMatrix.data),e.setBuffer("aPosition",this.skyVertexBuffer),f.drawArrays(f.TRIANGLES,0,this.skyVertexBuffer.numItems),e.disable(),t.enable(),t.setParam("uColor","4fv",[...r,1]),t.setMatrix("uMatrix","4fv",fe.viewProjMatrix.data),t.setBuffer("aPosition",this.floorVertexBuffer),f.drawArrays(f.TRIANGLE_FAN,0,this.floorVertexBuffer.numItems),t.disable()}destroy(){this.skyVertexBuffer.destroy(),this.skyShader.destroy(),this.floorVertexBuffer.destroy(),this.floorShader.destroy()}}class we{constructor(){this.shader=new n.Shader({vertexShader:r.blur.vertex,fragmentShader:r.blur.fragment,shaderName:"blur shader",attributes:["aPosition","aTexCoord"],uniforms:["uInverseTexSize","uTexIndex"]}),this.framebuffer=new n.Framebuffer(128,128),this.vertexBuffer=new n.Buffer(3,new Float32Array([-1,-1,1e-5,1,-1,1e-5,1,1,1e-5,-1,-1,1e-5,1,1,1e-5,-1,1,1e-5])),this.texCoordBuffer=new n.Buffer(2,new Float32Array([0,0,1,0,1,1,0,0,1,1,0,1]))}render(e,t){this.framebuffer.setSize(t[0],t[1]),f.viewport(0,0,t[0],t[1]),this.shader.enable(),this.framebuffer.enable(),f.clearColor(1,0,0,1),f.clear(f.COLOR_BUFFER_BIT|f.DEPTH_BUFFER_BIT),this.shader.setParam("uInverseTexSize","2fv",[1/this.framebuffer.width,1/this.framebuffer.height]),this.shader.setBuffer("aPosition",this.vertexBuffer),this.shader.setBuffer("aTexCoord",this.texCoordBuffer),this.shader.setTexture("uTexIndex",0,e),f.drawArrays(f.TRIANGLES,0,this.vertexBuffer.numItems),this.shader.disable(),this.framebuffer.disable(),f.viewport(0,0,l.width,l.height)}destroy(){this.shader.destroy(),this.framebuffer.destroy(),this.vertexBuffer.destroy(),this.texCoordBuffer.destroy()}}class be{constructor(){this.shader=new n.Shader({vertexShader:r.marker.vertex,fragmentShader:r.marker.fragment,shaderName:"marker shader",attributes:["aPosition","aTexCoord"],uniforms:["uProjMatrix","uViewMatrix","uModelMatrix","uTexIndex","markerSize"]})}render(){const e=this.shader;e.enable();const t=fe.metersPerDegreeLongitude;f.disable(f.DEPTH_TEST),f.enable(f.BLEND),f.blendFunc(f.SRC_ALPHA,f.ONE_MINUS_SRC_ALPHA),l.markers.forEach(r=>{if(!r.isReady)return;const i=new n.Matrix;i.translate((r.position.longitude-l.position.longitude)*t,-(r.position.latitude-l.position.latitude)*S,r.elevation),e.setParam("markerSize","1f",r.size),e.setMatrix("uProjMatrix","4fv",fe.projMatrix.data),e.setMatrix("uViewMatrix","4fv",fe.viewMatrix.data),e.setMatrix("uModelMatrix","4fv",i.data),e.setBuffer("aPosition",r.vertexBuffer),e.setBuffer("aTexCoord",r.texCoordBuffer),e.setTexture("uTexIndex",0,r.texture),f.drawArrays(f.TRIANGLES,0,r.vertexBuffer.numItems)}),f.disable(f.BLEND),f.enable(f.DEPTH_TEST),e.disable()}destroy(){this.shader.destroy()}}}();